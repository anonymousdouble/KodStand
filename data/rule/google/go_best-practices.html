<!DOCTYPE html>
<html lang="en-US">
 <head>
  <meta charset="utf-8"/>
  <meta content="IE=edge" http-equiv="X-UA-Compatible"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <!-- Begin Jekyll SEO tag v2.8.0 -->
  <title>
   styleguide | Style guides for Google-originated open-source projects
  </title>
  <meta content="Jekyll v3.9.5" name="generator"/>
  <meta content="styleguide" property="og:title"/>
  <meta content="en_US" property="og:locale"/>
  <meta content="Style guides for Google-originated open-source projects" name="description"/>
  <meta content="Style guides for Google-originated open-source projects" property="og:description"/>
  <link href="https://google.github.io/styleguide/go/best-practices.html" rel="canonical"/>
  <meta content="https://google.github.io/styleguide/go/best-practices.html" property="og:url"/>
  <meta content="styleguide" property="og:site_name"/>
  <meta content="website" property="og:type"/>
  <meta content="summary" name="twitter:card"/>
  <meta content="styleguide" property="twitter:title"/>
  <script type="application/ld+json">
   {"@context":"https://schema.org","@type":"WebPage","description":"Style guides for Google-originated open-source projects","headline":"styleguide","url":"https://google.github.io/styleguide/go/best-practices.html"}
  </script>
  <!-- End Jekyll SEO tag -->
  <link href="/styleguide/assets/css/style.css?v=8487c083e1faecb1259be8a8873618cfdb69d33d" rel="stylesheet"/>
  <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->
  <!-- Setup Google Analytics -->
  <!-- You can set your favicon here -->
  <!-- link rel="shortcut icon" type="image/x-icon" href="/styleguide/favicon.ico" -->
  <!-- end custom head snippets -->
 </head>
 <body>
  <div class="container-lg px-3 my-5 markdown-body">
   <h1>
    <a href="https://google.github.io/styleguide/">
     styleguide
    </a>
   </h1>
   <!--* toc_depth: 3 *-->
   <h1 id="go-style-best-practices">
    Go Style Best Practices
   </h1>
   <p>
    https://google.github.io/styleguide/go/best-practices
   </p>
   <p>
    <a href="index">
     Overview
    </a>
    |
    <a href="guide">
     Guide
    </a>
    |
    <a href="decisions">
     Decisions
    </a>
    |
    <a href="best-practices">
     Best practices
    </a>
   </p>
   <!--
-->
   <p>
    <strong>
     Note:
    </strong>
    This is part of a series of documents that outline
    <a href="index">
     Go Style
    </a>
    at Google. This document is
    <strong>
     neither
     <a href="index#normative">
      normative
     </a>
     nor
     <a href="index#canonical">
      canonical
     </a>
    </strong>
    , and is an auxiliary document to the
    <a href="guide">
     core style guide
    </a>
    . See
    <a href="index#about">
     the overview
    </a>
    for more information.
   </p>
   <p>
    <a id="about">
    </a>
   </p>
   <h2 id="about">
    About
   </h2>
   <p>
    This file documents
    <strong>
     guidance about how to best apply the Go Style Guide
    </strong>
    .
            This guidance is intended for common situations that arise frequently, but may
            not apply in every circumstance. Where possible, multiple alternative approaches
            are discussed along with the considerations that go into the decision about when
            and when not to apply them.
   </p>
   <p>
    See
    <a href="index#about">
     the overview
    </a>
    for the full set of Style Guide documents.
   </p>
   <p>
    <a id="naming">
    </a>
   </p>
   <h2 id="naming">
    Naming
   </h2>
   <p>
    <a id="function-names">
    </a>
   </p>
   <h3 id="function-and-method-names">
    Function and method names
   </h3>
   <p>
    <a id="function-name-repetition">
    </a>
   </p>
   <h4 id="avoid-repetition">
    Avoid repetition
   </h4>
   <p>
    When choosing the name for a function or method, consider the context in which
            the name will be read. Consider the following recommendations to avoid excess
    <a href="decisions#repetition">
     repetition
    </a>
    at the call site:
   </p>
   <ul>
    <li>
     <p>
      The following can generally be omitted from function and method names:
     </p>
     <ul>
      <li>
       The types of the inputs and outputs (when there is no collision)
      </li>
      <li>
       The type of a method’s receiver
      </li>
      <li>
       Whether an input or output is a pointer
      </li>
     </ul>
    </li>
    <li>
     <p>
      For functions, do not
      <a href="decisions#repetitive-with-package">
       repeat the name of the package
      </a>
      .
     </p>
     <div class="language-go highlighter-rouge">
      <div class="highlight">
       <pre class="highlight"><code><span class="c">// Bad:</span>
<span class="k">package</span> <span class="n">yamlconfig</span>

<span class="k">func</span> <span class="n">ParseYAMLConfig</span><span class="p">(</span><span class="n">input</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">Config</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</code></pre>
      </div>
     </div>
     <div class="language-go highlighter-rouge">
      <div class="highlight">
       <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">package</span> <span class="n">yamlconfig</span>

<span class="k">func</span> <span class="n">Parse</span><span class="p">(</span><span class="n">input</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">Config</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</code></pre>
      </div>
     </div>
    </li>
    <li>
     <p>
      For methods, do not repeat the name of the method receiver.
     </p>
     <div class="language-go highlighter-rouge">
      <div class="highlight">
       <pre class="highlight"><code><span class="c">// Bad:</span>
<span class="k">func</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">Config</span><span class="p">)</span> <span class="n">WriteConfigTo</span><span class="p">(</span><span class="n">w</span> <span class="n">io</span><span class="o">.</span><span class="n">Writer</span><span class="p">)</span> <span class="p">(</span><span class="kt">int64</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</code></pre>
      </div>
     </div>
     <div class="language-go highlighter-rouge">
      <div class="highlight">
       <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">func</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">Config</span><span class="p">)</span> <span class="n">WriteTo</span><span class="p">(</span><span class="n">w</span> <span class="n">io</span><span class="o">.</span><span class="n">Writer</span><span class="p">)</span> <span class="p">(</span><span class="kt">int64</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</code></pre>
      </div>
     </div>
    </li>
    <li>
     <p>
      Do not repeat the names of variables passed as parameters.
     </p>
     <div class="language-go highlighter-rouge">
      <div class="highlight">
       <pre class="highlight"><code><span class="c">// Bad:</span>
<span class="k">func</span> <span class="n">OverrideFirstWithSecond</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">source</span> <span class="o">*</span><span class="n">Config</span><span class="p">)</span> <span class="kt">error</span>
</code></pre>
      </div>
     </div>
     <div class="language-go highlighter-rouge">
      <div class="highlight">
       <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">func</span> <span class="n">Override</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">source</span> <span class="o">*</span><span class="n">Config</span><span class="p">)</span> <span class="kt">error</span>
</code></pre>
      </div>
     </div>
    </li>
    <li>
     <p>
      Do not repeat the names and types of the return values.
     </p>
     <div class="language-go highlighter-rouge">
      <div class="highlight">
       <pre class="highlight"><code><span class="c">// Bad:</span>
<span class="k">func</span> <span class="n">TransformYAMLToJSON</span><span class="p">(</span><span class="n">input</span> <span class="o">*</span><span class="n">Config</span><span class="p">)</span> <span class="o">*</span><span class="n">jsonconfig</span><span class="o">.</span><span class="n">Config</span>
</code></pre>
      </div>
     </div>
     <div class="language-go highlighter-rouge">
      <div class="highlight">
       <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">func</span> <span class="n">Transform</span><span class="p">(</span><span class="n">input</span> <span class="o">*</span><span class="n">Config</span><span class="p">)</span> <span class="o">*</span><span class="n">jsonconfig</span><span class="o">.</span><span class="n">Config</span>
</code></pre>
      </div>
     </div>
    </li>
   </ul>
   <p>
    When it is necessary to disambiguate functions of a similar name, it is
            acceptable to include extra information.
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">func</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">Config</span><span class="p">)</span> <span class="n">WriteTextTo</span><span class="p">(</span><span class="n">w</span> <span class="n">io</span><span class="o">.</span><span class="n">Writer</span><span class="p">)</span> <span class="p">(</span><span class="kt">int64</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="k">func</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">Config</span><span class="p">)</span> <span class="n">WriteBinaryTo</span><span class="p">(</span><span class="n">w</span> <span class="n">io</span><span class="o">.</span><span class="n">Writer</span><span class="p">)</span> <span class="p">(</span><span class="kt">int64</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</code></pre>
    </div>
   </div>
   <p>
    <a id="function-name-conventions">
    </a>
   </p>
   <h4 id="naming-conventions">
    Naming conventions
   </h4>
   <p>
    There are some other common conventions when choosing names for functions and
            methods:
   </p>
   <ul>
    <li>
     <p>
      Functions that return something are given noun-like names.
     </p>
     <div class="language-go highlighter-rouge">
      <div class="highlight">
       <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">func</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">Config</span><span class="p">)</span> <span class="n">JobName</span><span class="p">(</span><span class="n">key</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">value</span> <span class="kt">string</span><span class="p">,</span> <span class="n">ok</span> <span class="kt">bool</span><span class="p">)</span>
</code></pre>
      </div>
     </div>
     <p>
      A corollary of this is that function and method names should
      <a href="decisions#getters">
       avoid the prefix
       <code class="language-plaintext highlighter-rouge">
        Get
       </code>
      </a>
      .
     </p>
     <div class="language-go highlighter-rouge">
      <div class="highlight">
       <pre class="highlight"><code><span class="c">// Bad:</span>
<span class="k">func</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">Config</span><span class="p">)</span> <span class="n">GetJobName</span><span class="p">(</span><span class="n">key</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">value</span> <span class="kt">string</span><span class="p">,</span> <span class="n">ok</span> <span class="kt">bool</span><span class="p">)</span>
</code></pre>
      </div>
     </div>
    </li>
    <li>
     <p>
      Functions that do something are given verb-like names.
     </p>
     <div class="language-go highlighter-rouge">
      <div class="highlight">
       <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">func</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">Config</span><span class="p">)</span> <span class="n">WriteDetail</span><span class="p">(</span><span class="n">w</span> <span class="n">io</span><span class="o">.</span><span class="n">Writer</span><span class="p">)</span> <span class="p">(</span><span class="kt">int64</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</code></pre>
      </div>
     </div>
    </li>
    <li>
     <p>
      Identical functions that differ only by the types involved include the name
                    of the type at the end of the name.
     </p>
     <div class="language-go highlighter-rouge">
      <div class="highlight">
       <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">func</span> <span class="n">ParseInt</span><span class="p">(</span><span class="n">input</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="k">func</span> <span class="n">ParseInt64</span><span class="p">(</span><span class="n">input</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">int64</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="k">func</span> <span class="n">AppendInt</span><span class="p">(</span><span class="n">buf</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="n">value</span> <span class="kt">int</span><span class="p">)</span> <span class="p">[]</span><span class="kt">byte</span>
<span class="k">func</span> <span class="n">AppendInt64</span><span class="p">(</span><span class="n">buf</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="n">value</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">[]</span><span class="kt">byte</span>
</code></pre>
      </div>
     </div>
     <p>
      If there is a clear “primary” version, the type can be omitted from the name
                    for that version:
     </p>
     <div class="language-go highlighter-rouge">
      <div class="highlight">
       <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">func</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">Config</span><span class="p">)</span> <span class="n">Marshal</span><span class="p">()</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="k">func</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">Config</span><span class="p">)</span> <span class="n">MarshalText</span><span class="p">()</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</code></pre>
      </div>
     </div>
    </li>
   </ul>
   <p>
    <a id="naming-doubles">
    </a>
   </p>
   <h3 id="test-double-packages-and-types">
    Test double packages and types
   </h3>
   <p>
    There are several disciplines you can apply to
    <a href="guide#naming">
     naming
    </a>
    packages and types that
            provide test helpers and especially
    <a href="https://abseil.io/resources/swe-book/html/ch13.html#basic_concepts">
     test doubles
    </a>
    . A test double could be a
            stub, fake, mock, or spy.
   </p>
   <p>
    These examples mostly use stubs. Update your names accordingly if your code uses
            fakes or another kind of test double.
   </p>
   <p>
    Suppose you have a well-focused package providing production code similar to
            this:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="k">package</span> <span class="n">creditcard</span>

<span class="k">import</span> <span class="p">(</span>
    <span class="s">"errors"</span>

    <span class="s">"path/to/money"</span>
<span class="p">)</span>

<span class="c">// ErrDeclined indicates that the issuer declines the charge.</span>
<span class="k">var</span> <span class="n">ErrDeclined</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="s">"creditcard: declined"</span><span class="p">)</span>

<span class="c">// Card contains information about a credit card, such as its issuer,</span>
<span class="c">// expiration, and limit.</span>
<span class="k">type</span> <span class="n">Card</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="c">// omitted</span>
<span class="p">}</span>

<span class="c">// Service allows you to perform operations with credit cards against external</span>
<span class="c">// payment processor vendors like charge, authorize, reimburse, and subscribe.</span>
<span class="k">type</span> <span class="n">Service</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="c">// omitted</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span><span class="n">Service</span><span class="p">)</span> <span class="n">Charge</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">Card</span><span class="p">,</span> <span class="n">amount</span> <span class="n">money</span><span class="o">.</span><span class="n">Money</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span> <span class="c">/* omitted */</span> <span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    <a id="naming-doubles-helper-package">
    </a>
   </p>
   <h4 id="creating-test-helper-packages">
    Creating test helper packages
   </h4>
   <p>
    Suppose you want to create a package that contains test doubles for another.
            We’ll use
    <code class="language-plaintext highlighter-rouge">
     package creditcard
    </code>
    (from above) for this example:
   </p>
   <p>
    One approach is to introduce a new Go package based on the production one for
            testing. A safe choice is to append the word
    <code class="language-plaintext highlighter-rouge">
     test
    </code>
    to the original package name
            (“creditcard” + “test”):
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">package</span> <span class="n">creditcardtest</span>
</code></pre>
    </div>
   </div>
   <p>
    Unless stated explicitly otherwise, all examples in the sections below are in
    <code class="language-plaintext highlighter-rouge">
     package creditcardtest
    </code>
    .
   </p>
   <p>
    <a id="naming-doubles-simple">
    </a>
   </p>
   <h4 id="simple-case">
    Simple case
   </h4>
   <p>
    You want to add a set of test doubles for
    <code class="language-plaintext highlighter-rouge">
     Service
    </code>
    . Because
    <code class="language-plaintext highlighter-rouge">
     Card
    </code>
    is
            effectively a dumb data type, similar to a Protocol Buffer message, it needs no
            special treatment in tests, so no double is required. If you anticipate only
            test doubles for one type (like
    <code class="language-plaintext highlighter-rouge">
     Service
    </code>
    ), you can take a concise approach to
            naming the doubles:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">import</span> <span class="p">(</span>
    <span class="s">"path/to/creditcard"</span>
    <span class="s">"path/to/money"</span>
<span class="p">)</span>

<span class="c">// Stub stubs creditcard.Service and provides no behavior of its own.</span>
<span class="k">type</span> <span class="n">Stub</span> <span class="k">struct</span><span class="p">{}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">Stub</span><span class="p">)</span> <span class="n">Charge</span><span class="p">(</span><span class="o">*</span><span class="n">creditcard</span><span class="o">.</span><span class="n">Card</span><span class="p">,</span> <span class="n">money</span><span class="o">.</span><span class="n">Money</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span> <span class="k">return</span> <span class="no">nil</span> <span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    This is strictly preferable to a naming choice like
    <code class="language-plaintext highlighter-rouge">
     StubService
    </code>
    or the very
            poor
    <code class="language-plaintext highlighter-rouge">
     StubCreditCardService
    </code>
    , because the base package name and its domain types
            imply what
    <code class="language-plaintext highlighter-rouge">
     creditcardtest.Stub
    </code>
    is.
   </p>
   <p>
    Finally, if the package is built with Bazel, make sure the new
    <code class="language-plaintext highlighter-rouge">
     go_library
    </code>
    rule
            for the package is marked as
    <code class="language-plaintext highlighter-rouge">
     testonly
    </code>
    :
   </p>
   <pre><code class="language-build"># Good:
go_library(
    name = "creditcardtest",
    srcs = ["creditcardtest.go"],
    deps = [
        ":creditcard",
        ":money",
    ],
    testonly = True,
)
</code></pre>
   <p>
    The approach above is conventional and will be reasonably well understood by
            other engineers.
   </p>
   <p>
    See also:
   </p>
   <ul>
    <li>
     <a href="https://google.github.io/styleguide/go/index.html#gotip">
      Go Tip #42: Authoring a Stub for Testing
     </a>
    </li>
   </ul>
   <p>
    <a id="naming-doubles-multiple-behaviors">
    </a>
   </p>
   <h4 id="multiple-test-double-behaviors">
    Multiple test double behaviors
   </h4>
   <p>
    When one kind of stub is not enough (for example, you also need one that always
            fails), we recommend naming the stubs according to the behavior they emulate.
            Here we rename
    <code class="language-plaintext highlighter-rouge">
     Stub
    </code>
    to
    <code class="language-plaintext highlighter-rouge">
     AlwaysCharges
    </code>
    and introduce a new stub called
    <code class="language-plaintext highlighter-rouge">
     AlwaysDeclines
    </code>
    :
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="c">// AlwaysCharges stubs creditcard.Service and simulates success.</span>
<span class="k">type</span> <span class="n">AlwaysCharges</span> <span class="k">struct</span><span class="p">{}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">AlwaysCharges</span><span class="p">)</span> <span class="n">Charge</span><span class="p">(</span><span class="o">*</span><span class="n">creditcard</span><span class="o">.</span><span class="n">Card</span><span class="p">,</span> <span class="n">money</span><span class="o">.</span><span class="n">Money</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span> <span class="k">return</span> <span class="no">nil</span> <span class="p">}</span>

<span class="c">// AlwaysDeclines stubs creditcard.Service and simulates declined charges.</span>
<span class="k">type</span> <span class="n">AlwaysDeclines</span> <span class="k">struct</span><span class="p">{}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">AlwaysDeclines</span><span class="p">)</span> <span class="n">Charge</span><span class="p">(</span><span class="o">*</span><span class="n">creditcard</span><span class="o">.</span><span class="n">Card</span><span class="p">,</span> <span class="n">money</span><span class="o">.</span><span class="n">Money</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">creditcard</span><span class="o">.</span><span class="n">ErrDeclined</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    <a id="naming-doubles-multiple-types">
    </a>
   </p>
   <h4 id="multiple-doubles-for-multiple-types">
    Multiple doubles for multiple types
   </h4>
   <p>
    But now suppose that
    <code class="language-plaintext highlighter-rouge">
     package creditcard
    </code>
    contains multiple types worth creating
            doubles for, as seen below with
    <code class="language-plaintext highlighter-rouge">
     Service
    </code>
    and
    <code class="language-plaintext highlighter-rouge">
     StoredValue
    </code>
    :
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="k">package</span> <span class="n">creditcard</span>

<span class="k">type</span> <span class="n">Service</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="c">// omitted</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">Card</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="c">// omitted</span>
<span class="p">}</span>

<span class="c">// StoredValue manages customer credit balances.  This applies when returned</span>
<span class="c">// merchandise is credited to a customer's local account instead of processed</span>
<span class="c">// by the credit issuer.  For this reason, it is implemented as a separate</span>
<span class="c">// service.</span>
<span class="k">type</span> <span class="n">StoredValue</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="c">// omitted</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span><span class="n">StoredValue</span><span class="p">)</span> <span class="n">Credit</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">Card</span><span class="p">,</span> <span class="n">amount</span> <span class="n">money</span><span class="o">.</span><span class="n">Money</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span> <span class="c">/* omitted */</span> <span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    In this case, more explicit test double naming is sensible:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">type</span> <span class="n">StubService</span> <span class="k">struct</span><span class="p">{}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">StubService</span><span class="p">)</span> <span class="n">Charge</span><span class="p">(</span><span class="o">*</span><span class="n">creditcard</span><span class="o">.</span><span class="n">Card</span><span class="p">,</span> <span class="n">money</span><span class="o">.</span><span class="n">Money</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span> <span class="k">return</span> <span class="no">nil</span> <span class="p">}</span>

<span class="k">type</span> <span class="n">StubStoredValue</span> <span class="k">struct</span><span class="p">{}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">StubStoredValue</span><span class="p">)</span> <span class="n">Credit</span><span class="p">(</span><span class="o">*</span><span class="n">creditcard</span><span class="o">.</span><span class="n">Card</span><span class="p">,</span> <span class="n">money</span><span class="o">.</span><span class="n">Money</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span> <span class="k">return</span> <span class="no">nil</span> <span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    <a id="naming-doubles-local-variables">
    </a>
   </p>
   <h4 id="local-variables-in-tests">
    Local variables in tests
   </h4>
   <p>
    When variables in your tests refer to doubles, choose a name that most clearly
            differentiates the double from other production types based on context. Consider
            some production code you want to test:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="k">package</span> <span class="n">payment</span>

<span class="k">import</span> <span class="p">(</span>
    <span class="s">"path/to/creditcard"</span>
    <span class="s">"path/to/money"</span>
<span class="p">)</span>

<span class="k">type</span> <span class="n">CreditCard</span> <span class="k">interface</span> <span class="p">{</span>
    <span class="n">Charge</span><span class="p">(</span><span class="o">*</span><span class="n">creditcard</span><span class="o">.</span><span class="n">Card</span><span class="p">,</span> <span class="n">money</span><span class="o">.</span><span class="n">Money</span><span class="p">)</span> <span class="kt">error</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">Processor</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">CC</span> <span class="n">CreditCard</span>
<span class="p">}</span>

<span class="k">var</span> <span class="n">ErrBadInstrument</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="s">"payment: instrument is invalid or expired"</span><span class="p">)</span>

<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Processor</span><span class="p">)</span> <span class="n">Process</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">creditcard</span><span class="o">.</span><span class="n">Card</span><span class="p">,</span> <span class="n">amount</span> <span class="n">money</span><span class="o">.</span><span class="n">Money</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">Expired</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">ErrBadInstrument</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">CC</span><span class="o">.</span><span class="n">Charge</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    In the tests, a test double called a “spy” for
    <code class="language-plaintext highlighter-rouge">
     CreditCard
    </code>
    is juxtaposed
            against production types, so prefixing the name may improve clarity.
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">package</span> <span class="n">payment</span>

<span class="k">import</span> <span class="s">"path/to/creditcardtest"</span>

<span class="k">func</span> <span class="n">TestProcessor</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">var</span> <span class="n">spyCC</span> <span class="n">creditcardtest</span><span class="o">.</span><span class="n">Spy</span>

    <span class="n">proc</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">Processor</span><span class="p">{</span><span class="n">CC</span><span class="o">:</span> <span class="n">spyCC</span><span class="p">}</span>

    <span class="c">// declarations omitted: card and amount</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">proc</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"proc.Process(card, amount) = %v, want %v"</span><span class="p">,</span> <span class="n">got</span><span class="p">,</span> <span class="n">want</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">charges</span> <span class="o">:=</span> <span class="p">[]</span><span class="n">creditcardtest</span><span class="o">.</span><span class="n">Charge</span><span class="p">{</span>
        <span class="p">{</span><span class="n">Card</span><span class="o">:</span> <span class="n">card</span><span class="p">,</span> <span class="n">Amount</span><span class="o">:</span> <span class="n">amount</span><span class="p">},</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">got</span><span class="p">,</span> <span class="n">want</span> <span class="o">:=</span> <span class="n">spyCC</span><span class="o">.</span><span class="n">Charges</span><span class="p">,</span> <span class="n">charges</span><span class="p">;</span> <span class="o">!</span><span class="n">cmp</span><span class="o">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">got</span><span class="p">,</span> <span class="n">want</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"spyCC.Charges = %v, want %v"</span><span class="p">,</span> <span class="n">got</span><span class="p">,</span> <span class="n">want</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    This is clearer than when the name is not prefixed.
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Bad:</span>
<span class="k">package</span> <span class="n">payment</span>

<span class="k">import</span> <span class="s">"path/to/creditcardtest"</span>

<span class="k">func</span> <span class="n">TestProcessor</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">var</span> <span class="n">cc</span> <span class="n">creditcardtest</span><span class="o">.</span><span class="n">Spy</span>

    <span class="n">proc</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">Processor</span><span class="p">{</span><span class="n">CC</span><span class="o">:</span> <span class="n">cc</span><span class="p">}</span>

    <span class="c">// declarations omitted: card and amount</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">proc</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"proc.Process(card, amount) = %v, want %v"</span><span class="p">,</span> <span class="n">got</span><span class="p">,</span> <span class="n">want</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">charges</span> <span class="o">:=</span> <span class="p">[]</span><span class="n">creditcardtest</span><span class="o">.</span><span class="n">Charge</span><span class="p">{</span>
        <span class="p">{</span><span class="n">Card</span><span class="o">:</span> <span class="n">card</span><span class="p">,</span> <span class="n">Amount</span><span class="o">:</span> <span class="n">amount</span><span class="p">},</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">got</span><span class="p">,</span> <span class="n">want</span> <span class="o">:=</span> <span class="n">cc</span><span class="o">.</span><span class="n">Charges</span><span class="p">,</span> <span class="n">charges</span><span class="p">;</span> <span class="o">!</span><span class="n">cmp</span><span class="o">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">got</span><span class="p">,</span> <span class="n">want</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"cc.Charges = %v, want %v"</span><span class="p">,</span> <span class="n">got</span><span class="p">,</span> <span class="n">want</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    <a id="shadowing">
    </a>
   </p>
   <h3 id="shadowing">
    Shadowing
   </h3>
   <p>
    <strong>
     Note:
    </strong>
    This explanation uses two informal terms,
    <em>
     stomping
    </em>
    and
    <em>
     shadowing
    </em>
    .
            They are not official concepts in the Go language spec.
   </p>
   <p>
    Like many programming languages, Go has mutable variables: assigning to a
            variable changes its value.
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">func</span> <span class="n">abs</span><span class="p">(</span><span class="n">i</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="m">0</span> <span class="p">{</span>
        <span class="n">i</span> <span class="o">*=</span> <span class="o">-</span><span class="m">1</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">i</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    When using
    <a href="https://go.dev/ref/spec#Short_variable_declarations">
     short variable declarations
    </a>
    with the
    <code class="language-plaintext highlighter-rouge">
     :=
    </code>
    operator, in some cases a
            new variable is not created. We can call this
    <em>
     stomping
    </em>
    . It’s OK to do this
            when the original value is no longer needed.
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="c">// innerHandler is a helper for some request handler, which itself issues</span>
<span class="c">// requests to other backends.</span>
<span class="k">func</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span><span class="n">Server</span><span class="p">)</span> <span class="n">innerHandler</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">req</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">MyRequest</span><span class="p">)</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">MyResponse</span> <span class="p">{</span>
    <span class="c">// Unconditionally cap the deadline for this part of request handling.</span>
    <span class="n">ctx</span><span class="p">,</span> <span class="n">cancel</span> <span class="o">:=</span> <span class="n">context</span><span class="o">.</span><span class="n">WithTimeout</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="m">3</span><span class="o">*</span><span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">)</span>
    <span class="k">defer</span> <span class="n">cancel</span><span class="p">()</span>
    <span class="n">ctxlog</span><span class="o">.</span><span class="n">Info</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="s">"Capped deadline in inner request"</span><span class="p">)</span>

    <span class="c">// Code here no longer has access to the original context.</span>
    <span class="c">// This is good style if when first writing this, you anticipate</span>
    <span class="c">// that even as the code grows, no operation legitimately should</span>
    <span class="c">// use the (possibly unbounded) original context that the caller provided.</span>

    <span class="c">// ...</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    Be careful using short variable declarations in a new scope, though: that
            introduces a new variable. We can call this
    <em>
     shadowing
    </em>
    the original variable.
            Code after the end of the block refers to the original. Here is a buggy attempt
            to shorten the deadline conditionally:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Bad:</span>
<span class="k">func</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span><span class="n">Server</span><span class="p">)</span> <span class="n">innerHandler</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">req</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">MyRequest</span><span class="p">)</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">MyResponse</span> <span class="p">{</span>
    <span class="c">// Attempt to conditionally cap the deadline.</span>
    <span class="k">if</span> <span class="o">*</span><span class="n">shortenDeadlines</span> <span class="p">{</span>
        <span class="n">ctx</span><span class="p">,</span> <span class="n">cancel</span> <span class="o">:=</span> <span class="n">context</span><span class="o">.</span><span class="n">WithTimeout</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="m">3</span><span class="o">*</span><span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">)</span>
        <span class="k">defer</span> <span class="n">cancel</span><span class="p">()</span>
        <span class="n">ctxlog</span><span class="o">.</span><span class="n">Info</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="s">"Capped deadline in inner request"</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c">// BUG: "ctx" here again means the context that the caller provided.</span>
    <span class="c">// The above buggy code compiled because both ctx and cancel</span>
    <span class="c">// were used inside the if statement.</span>

    <span class="c">// ...</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    A correct version of the code might be:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">func</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span><span class="n">Server</span><span class="p">)</span> <span class="n">innerHandler</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">req</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">MyRequest</span><span class="p">)</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">MyResponse</span> <span class="p">{</span>
    <span class="k">if</span> <span class="o">*</span><span class="n">shortenDeadlines</span> <span class="p">{</span>
        <span class="k">var</span> <span class="n">cancel</span> <span class="k">func</span><span class="p">()</span>
        <span class="c">// Note the use of simple assignment, = and not :=.</span>
        <span class="n">ctx</span><span class="p">,</span> <span class="n">cancel</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">WithTimeout</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="m">3</span><span class="o">*</span><span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">)</span>
        <span class="k">defer</span> <span class="n">cancel</span><span class="p">()</span>
        <span class="n">ctxlog</span><span class="o">.</span><span class="n">Info</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="s">"Capped deadline in inner request"</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c">// ...</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    In the case we called stomping, because there’s no new variable, the type being
            assigned must match that of the original variable. With shadowing, an entirely
            new entity is introduced so it can have a different type. Intentional shadowing
            can be a useful practice, but you can always use a new name if it improves
    <a href="guide#clarity">
     clarity
    </a>
    .
   </p>
   <p>
    It is not a good idea to use variables with the same name as standard packages
            other than very small scopes, because that renders free functions and values
            from that package inaccessible. Conversely, when picking a name for your
            package, avoid names that are likely to require
    <a href="decisions#import-renaming">
     import renaming
    </a>
    or cause shadowing of otherwise
            good variable names at the client side.
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Bad:</span>
<span class="k">func</span> <span class="n">LongFunction</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">url</span> <span class="o">:=</span> <span class="s">"https://example.com/"</span>
    <span class="c">// Oops, now we can't use net/url in code below.</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    <a id="util-packages">
    </a>
   </p>
   <h3 id="util-packages">
    Util packages
   </h3>
   <p>
    Go packages have a name specified on the
    <code class="language-plaintext highlighter-rouge">
     package
    </code>
    declaration, separate from
            the import path. The package name matters more for readability than the path.
   </p>
   <p>
    Go package names should be
    <a href="decisions#package-names">
     related to what the package provides
    </a>
    . Naming a
            package just
    <code class="language-plaintext highlighter-rouge">
     util
    </code>
    ,
    <code class="language-plaintext highlighter-rouge">
     helper
    </code>
    ,
    <code class="language-plaintext highlighter-rouge">
     common
    </code>
    or similar is usually a poor choice (it
            can be used as
    <em>
     part
    </em>
    of the name though). Uninformative names make the code
            harder to read, and if used too broadly they are liable to cause needless
    <a href="decisions#import-renaming">
     import conflicts
    </a>
    .
   </p>
   <p>
    Instead, consider what the callsite will look like.
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="n">db</span> <span class="o">:=</span> <span class="n">spannertest</span><span class="o">.</span><span class="n">NewDatabaseFromFile</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="n">_</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">f</span><span class="o">.</span><span class="n">Seek</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">SeekStart</span><span class="p">)</span>

<span class="n">b</span> <span class="o">:=</span> <span class="n">elliptic</span><span class="o">.</span><span class="n">Marshal</span><span class="p">(</span><span class="n">curve</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</code></pre>
    </div>
   </div>
   <p>
    You can tell roughly what each of these do even without knowing the imports list
            (
    <code class="language-plaintext highlighter-rouge">
     cloud.google.com/go/spanner/spannertest
    </code>
    ,
    <code class="language-plaintext highlighter-rouge">
     io
    </code>
    , and
    <code class="language-plaintext highlighter-rouge">
     crypto/elliptic
    </code>
    ). With
            less focused names, these might read:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Bad:</span>
<span class="n">db</span> <span class="o">:=</span> <span class="n">test</span><span class="o">.</span><span class="n">NewDatabaseFromFile</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="n">_</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">f</span><span class="o">.</span><span class="n">Seek</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">common</span><span class="o">.</span><span class="n">SeekStart</span><span class="p">)</span>

<span class="n">b</span> <span class="o">:=</span> <span class="n">helper</span><span class="o">.</span><span class="n">Marshal</span><span class="p">(</span><span class="n">curve</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</code></pre>
    </div>
   </div>
   <p>
    <a id="package-size">
    </a>
   </p>
   <h2 id="package-size">
    Package size
   </h2>
   <p>
    If you’re asking yourself how big your Go packages should be and whether to
            place related types in the same package or split them into different ones, a
            good place to start is the
    <a href="https://go.dev/blog/package-names">
     Go blog post about package names
    </a>
    .
            Despite the post title, it’s not solely about naming. It contains some helpful
            hints and cites several useful articles and talks.
   </p>
   <p>
    Here are some other considerations and notes.
   </p>
   <p>
    Users see
    <a href="https://pkg.go.dev/">
     godoc
    </a>
    for the package in one page, and any methods exported by types
            supplied by the package are grouped by their type. Godoc also group constructors
            along with the types they return. If
    <em>
     client code
    </em>
    is likely to need two values
            of different type to interact with each other, it may be convenient for the user
            to have them in the same package.
   </p>
   <p>
    Code within a package can access unexported identifiers in the package. If you
            have a few related types whose
    <em>
     implementation
    </em>
    is tightly coupled, placing them
            in the same package lets you achieve this coupling without polluting the public
            API with these details. A good test for this coupling is to imagine a
            hypothetical user of two packages, where the packages cover closely related
            topics: if the user must import both packages in order to use either in any
            meaningful way, combining them together is usually the right thing to do. The
            standard library generally demonstrates this kind of scoping and layering well.
   </p>
   <p>
    All of that being said, putting your entire project in a single package would
            likely make that package too large. When something is conceptually distinct,
            giving it its own small package can make it easier to use. The short name of the
            package as known to clients together with the exported type name work together
            to make a meaningful identifier: e.g.
    <code class="language-plaintext highlighter-rouge">
     bytes.Buffer
    </code>
    ,
    <code class="language-plaintext highlighter-rouge">
     ring.New
    </code>
    . The
    <a href="https://go.dev/blog/package-names">
     blog post
    </a>
    has more examples.
   </p>
   <p>
    Go style is flexible about file size, because maintainers can move code within a
            package from one file to another without affecting callers. But as a general
            guideline: it is usually not a good idea to have a single file with many
            thousands of lines in it, or having many tiny files. There is no “one type, one
            file” convention as in some other languages. As a rule of thumb, files should be
            focused enough that a maintainer can tell which file contains something, and the
            files should be small enough that it will be easy to find once there. The
            standard library often splits large packages to several source files, grouping
            related code by file. The source for
    <a href="https://go.dev/src/bytes/">
     package
     <code class="language-plaintext highlighter-rouge">
      bytes
     </code>
    </a>
    is a good example.
            Packages with long package documentation may choose to dedicate one file called
    <code class="language-plaintext highlighter-rouge">
     doc.go
    </code>
    that has the
    <a href="decisions#package-comments">
     package documentation
    </a>
    , a
            package declaration, and nothing else, but this is not required.
   </p>
   <p>
    Within the Google codebase and in projects using Bazel, directory layout for Go
            code is different than it is in open source Go projects: you can have multiple
    <code class="language-plaintext highlighter-rouge">
     go_library
    </code>
    targets in a single directory. A good reason to give each package
            its own directory is if you expect to open source your project in the future.
   </p>
   <p>
    See also:
   </p>
   <ul>
    <li>
     <a href="#naming-doubles">
      Test double packages
     </a>
    </li>
   </ul>
   <p>
    <a id="imports">
    </a>
   </p>
   <h2 id="imports">
    Imports
   </h2>
   <p>
    <a id="import-protos">
    </a>
   </p>
   <h3 id="protos-and-stubs">
    Protos and stubs
   </h3>
   <p>
    Proto library imports are treated differently than standard Go imports due to
            their cross-language nature. The convention for renamed proto imports are based
            on the rule that generated the package:
   </p>
   <ul>
    <li>
     The
     <code class="language-plaintext highlighter-rouge">
      pb
     </code>
     suffix is generally used for
     <code class="language-plaintext highlighter-rouge">
      go_proto_library
     </code>
     rules.
    </li>
    <li>
     The
     <code class="language-plaintext highlighter-rouge">
      grpc
     </code>
     suffix is generally used for
     <code class="language-plaintext highlighter-rouge">
      go_grpc_library
     </code>
     rules.
    </li>
   </ul>
   <p>
    Generally, a short one- or two-letter prefix is used:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">import</span> <span class="p">(</span>
    <span class="n">fspb</span> <span class="s">"path/to/package/foo_service_go_proto"</span>
    <span class="n">fsgrpc</span> <span class="s">"path/to/package/foo_service_go_grpc"</span>
<span class="p">)</span>
</code></pre>
    </div>
   </div>
   <p>
    If there is only a single proto used by a package or the package is tied closely
            to that proto, the prefix can be omitted:
   </p>
   <p>
    import ( pb “path/to/package/foo_service_go_proto” grpc
            “path/to/package/foo_service_go_grpc” )
   </p>
   <p>
    If the symbols in the proto are generic or are not very self-descriptive, or if
            shortening the package name with an acronym is unclear, a short word can suffice
            as the prefix:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">import</span> <span class="p">(</span>
    <span class="n">mapspb</span> <span class="s">"path/to/package/maps_go_proto"</span>
<span class="p">)</span>
</code></pre>
    </div>
   </div>
   <p>
    In this case
    <code class="language-plaintext highlighter-rouge">
     mapspb.Address
    </code>
    might be clearer than
    <code class="language-plaintext highlighter-rouge">
     mpb.Address
    </code>
    if the code in
            question is not already clearly related to maps.
   </p>
   <p>
    <a id="import-order">
    </a>
   </p>
   <h3 id="import-ordering">
    Import ordering
   </h3>
   <p>
    Imports are typically grouped into the following two (or more) blocks, in order:
   </p>
   <ol>
    <li>
     Standard library imports (e.g.,
     <code class="language-plaintext highlighter-rouge">
      "fmt"
     </code>
     )
    </li>
    <li>
     imports (e.g., “/path/to/somelib”)
    </li>
    <li>
     (optional) Protobuf imports (e.g.,
     <code class="language-plaintext highlighter-rouge">
      fpb "path/to/foo_go_proto"
     </code>
     )
    </li>
    <li>
     (optional) Side-effect imports (e.g.,
     <code class="language-plaintext highlighter-rouge">
      _ "path/to/package"
     </code>
     )
    </li>
   </ol>
   <p>
    If a file does not have a group for one of the optional categories above, the
            relevant imports are included in the project import group.
   </p>
   <p>
    Any import grouping that is clear and easy to understand is generally fine. For
            example, a team may choose to group gRPC imports separately from protobuf
            imports.
   </p>
   <blockquote>
    <p>
     <strong>
      Note:
     </strong>
     For code maintaining only the two mandatory groups (one group for
                the standard library and one for all other imports), the
     <code class="language-plaintext highlighter-rouge">
      goimports
     </code>
     tool
                produces output consistent with this guidance.
    </p>
    <p>
     However,
     <code class="language-plaintext highlighter-rouge">
      goimports
     </code>
     has no knowledge of groups beyond the mandatory ones; the
                optional groups are prone to invalidation by the tool. When optional groups
                are used, attention on the part of both authors and reviewers is required to
                ensure that groupings remain compliant.
    </p>
    <p>
     Either approach is fine, but do not leave the imports section in an
                inconsistent, partially grouped state.
    </p>
   </blockquote>
   <p>
    <a id="error-handling">
    </a>
   </p>
   <h2 id="error-handling">
    Error handling
   </h2>
   <p>
    In Go,
    <a href="https://go.dev/blog/errors-are-values">
     errors are values
    </a>
    ; they are created by code and consumed by code.
            Errors can be:
   </p>
   <ul>
    <li>
     Converted into diagnostic information for display to humans
    </li>
    <li>
     Used by the maintainer
    </li>
    <li>
     Interpreted by an end user
    </li>
   </ul>
   <p>
    Error messages also show up across a variety of different surfaces including log
            messages, error dumps, and rendered UIs.
   </p>
   <p>
    Code that processes (produces or consumes) errors should do so deliberately. It
            can be tempting to ignore or blindly propagate an error return value. However,
            it is always worth considering whether the current function in the call frame is
            positioned to handle the error most effectively. This is a large topic and it is
            hard to give categorical advice. Use your judgment, but keep the following
            considerations in mind:
   </p>
   <ul>
    <li>
     When creating an error value, decide whether to give it any
     <a href="#error-structure">
      structure
     </a>
     .
    </li>
    <li>
     When handling an error, consider
     <a href="#error-extra-info">
      adding information
     </a>
     that you have but that the caller and/or callee might not.
    </li>
    <li>
     See also guidance on
     <a href="#error-logging">
      error logging
     </a>
     .
    </li>
   </ul>
   <p>
    While it is usually not appropriate to ignore an error, a reasonable exception
            to this is when orchestrating related operations, where often only the first
            error is useful. Package
    <a href="https://pkg.go.dev/golang.org/x/sync/errgroup">
     <code class="language-plaintext highlighter-rouge">
      errgroup
     </code>
    </a>
    provides a convenient abstraction for a
            group of operations that can all fail or be canceled as a group.
   </p>
   <p>
    See also:
   </p>
   <ul>
    <li>
     <a href="https://go.dev/doc/effective_go#errors">
      Effective Go on errors
     </a>
    </li>
    <li>
     <a href="https://go.dev/blog/go1.13-errors">
      A post by the Go Blog on errors
     </a>
    </li>
    <li>
     <a href="https://pkg.go.dev/errors">
      Package
      <code class="language-plaintext highlighter-rouge">
       errors
      </code>
     </a>
    </li>
    <li>
     <a href="https://commandcenter.blogspot.com/2017/12/error-handling-in-upspin.html">
      Package
      <code class="language-plaintext highlighter-rouge">
       upspin.io/errors
      </code>
     </a>
    </li>
    <li>
     <a href="https://google.github.io/styleguide/go/index.html#gotip">
      GoTip #89: When to Use Canonical Status Codes as Errors
     </a>
    </li>
    <li>
     <a href="https://google.github.io/styleguide/go/index.html#gotip">
      GoTip #48: Error Sentinel Values
     </a>
    </li>
    <li>
     <a href="https://google.github.io/styleguide/go/index.html#gotip">
      GoTip #13: Designing Errors for Checking
     </a>
    </li>
   </ul>
   <p>
    <a id="error-structure">
    </a>
   </p>
   <h3 id="error-structure">
    Error structure
   </h3>
   <p>
    If callers need to interrogate the error (e.g., distinguish different error
            conditions), give the error value structure so that this can be done
            programmatically rather than having the caller perform string matching. This
            advice applies to production code as well as to tests that care about different
            error conditions.
   </p>
   <p>
    The simplest structured errors are unparameterized global values.
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="k">type</span> <span class="n">Animal</span> <span class="kt">string</span>

<span class="k">var</span> <span class="p">(</span>
    <span class="c">// ErrDuplicate occurs if this animal has already been seen.</span>
    <span class="n">ErrDuplicate</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="s">"duplicate"</span><span class="p">)</span>

    <span class="c">// ErrMarsupial occurs because we're allergic to marsupials outside Australia.</span>
    <span class="c">// Sorry.</span>
    <span class="n">ErrMarsupial</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="s">"marsupials are not supported"</span><span class="p">)</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">process</span><span class="p">(</span><span class="n">animal</span> <span class="n">Animal</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">seen</span><span class="p">[</span><span class="n">animal</span><span class="p">]</span><span class="o">:</span>
        <span class="k">return</span> <span class="n">ErrDuplicate</span>
    <span class="k">case</span> <span class="n">marsupial</span><span class="p">(</span><span class="n">animal</span><span class="p">)</span><span class="o">:</span>
        <span class="k">return</span> <span class="n">ErrMarsupial</span>
    <span class="p">}</span>
    <span class="n">seen</span><span class="p">[</span><span class="n">animal</span><span class="p">]</span> <span class="o">=</span> <span class="no">true</span>
    <span class="c">// ...</span>
    <span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    The caller can simply compare the returned error value of the function with one
            of the known error values:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">func</span> <span class="n">handlePet</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">process</span><span class="p">(</span><span class="n">an</span><span class="p">);</span> <span class="n">err</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">ErrDuplicate</span><span class="o">:</span>
        <span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"feed %q: %v"</span><span class="p">,</span> <span class="n">an</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
    <span class="k">case</span> <span class="n">ErrMarsupial</span><span class="o">:</span>
        <span class="c">// Try to recover with a friend instead.</span>
        <span class="n">alternate</span> <span class="o">=</span> <span class="n">an</span><span class="o">.</span><span class="n">BackupAnimal</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">handlePet</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">alternate</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    The above uses sentinel values, where the error must be equal (in the sense of
    <code class="language-plaintext highlighter-rouge">
     ==
    </code>
    ) to the expected value. That is perfectly adequate in many cases. If
    <code class="language-plaintext highlighter-rouge">
     process
    </code>
    returns wrapped errors (discussed below), you can use
    <a href="https://pkg.go.dev/errors#Is">
     <code class="language-plaintext highlighter-rouge">
      errors.Is
     </code>
    </a>
    .
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">func</span> <span class="n">handlePet</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">process</span><span class="p">(</span><span class="n">an</span><span class="p">);</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">errors</span><span class="o">.</span><span class="n">Is</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">ErrDuplicate</span><span class="p">)</span><span class="o">:</span>
        <span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"feed %q: %v"</span><span class="p">,</span> <span class="n">an</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
    <span class="k">case</span> <span class="n">errors</span><span class="o">.</span><span class="n">Is</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">ErrMarsupial</span><span class="p">)</span><span class="o">:</span>
        <span class="c">// ...</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    Do not attempt to distinguish errors based on their string form. (See
    <a href="https://google.github.io/styleguide/go/index.html#gotip">
     Go Tip #13: Designing Errors for Checking
    </a>
    for more.)
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Bad:</span>
<span class="k">func</span> <span class="n">handlePet</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">err</span> <span class="o">:=</span> <span class="n">process</span><span class="p">(</span><span class="n">an</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">regexp</span><span class="o">.</span><span class="n">MatchString</span><span class="p">(</span><span class="s">`duplicate`</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">Error</span><span class="p">())</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">regexp</span><span class="o">.</span><span class="n">MatchString</span><span class="p">(</span><span class="s">`marsupial`</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">Error</span><span class="p">())</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    If there is extra information in the error that the caller needs
            programmatically, it should ideally be presented structurally. For example, the
    <a href="https://pkg.go.dev/os#PathError">
     <code class="language-plaintext highlighter-rouge">
      os.PathError
     </code>
    </a>
    type is documented to place the pathname of the failing
            operation in a struct field which the caller can easily access.
   </p>
   <p>
    Other error structures can be used as appropriate, for example a project struct
            containing an error code and detail string.
    <a href="https://pkg.go.dev/google.golang.org/grpc/status">
     Package
     <code class="language-plaintext highlighter-rouge">
      status
     </code>
    </a>
    is a
            common encapsulation; if you choose this approach (which you are not obligated
            to do), use
    <a href="https://pkg.go.dev/google.golang.org/grpc/codes">
     canonical codes
    </a>
    . See
    <a href="https://google.github.io/styleguide/go/index.html#gotip">
     Go Tip #89: When to Use Canonical Status Codes as Errors
    </a>
    to know if using status codes is the right choice.
   </p>
   <p>
    <a id="error-extra-info">
    </a>
   </p>
   <h3 id="adding-information-to-errors">
    Adding information to errors
   </h3>
   <p>
    Any function returning an error should strive to make the error value useful.
            Often, the function is in the middle of a callchain and is merely propagating an
            error from some other function that it called (maybe even from another package).
            Here there is an opportunity to annotate the error with extra information, but
            the programmer should ensure there’s sufficient information in the error without
            adding duplicate or irrelevant detail. If you’re unsure, try triggering the
            error condition during development: that’s a good way to assess what the
            observers of the error (either humans or code) will end up with.
   </p>
   <p>
    Convention and good documentation help. For example, the standard package
    <code class="language-plaintext highlighter-rouge">
     os
    </code>
    advertises that its errors contain path information when it is available. This
            is a useful style, because callers getting back an error don’t need to annotate
            it with information that they had already provided the failing function.
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s">"settings.txt"</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">err</span>
<span class="p">}</span>

<span class="c">// Output:</span>
<span class="c">//</span>
<span class="c">// open settings.txt: no such file or directory</span>
</code></pre>
    </div>
   </div>
   <p>
    If there is something interesting to say about the
    <em>
     meaning
    </em>
    of the error, of
            course it can be added. Just consider which level of the callchain is best
            positioned to understand this meaning.
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s">"settings.txt"</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="c">// We convey the significance of this error to us. Note that the current</span>
    <span class="c">// function might perform more than one file operation that can fail, so</span>
    <span class="c">// these annotations can also serve to disambiguate to the caller what went</span>
    <span class="c">// wrong.</span>
    <span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"launch codes unavailable: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="c">// Output:</span>
<span class="c">//</span>
<span class="c">// launch codes unavailable: open settings.txt: no such file or directory</span>
</code></pre>
    </div>
   </div>
   <p>
    Contrast with the redundant information here:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Bad:</span>
<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s">"settings.txt"</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"could not open settings.txt: %w"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="c">// Output:</span>
<span class="c">//</span>
<span class="c">// could not open settings.txt: open settings.txt: no such file or directory</span>
</code></pre>
    </div>
   </div>
   <p>
    When adding information to a propagated error, you can either wrap the error or
            present a fresh error. Wrapping the error with the
    <code class="language-plaintext highlighter-rouge">
     %w
    </code>
    verb in
    <code class="language-plaintext highlighter-rouge">
     fmt.Errorf
    </code>
    allows callers to access data from the original error. This can be very useful
            at times, but in other cases these details are misleading or uninteresting to
            the caller. See the
    <a href="https://blog.golang.org/go1.13-errors">
     blog post on error wrapping
    </a>
    for more
            information. Wrapping errors also expands the API surface of your package in a
            non-obvious way, and this can cause breakages if you change the implementation
            details of your package.
   </p>
   <p>
    It is best to avoid using
    <code class="language-plaintext highlighter-rouge">
     %w
    </code>
    unless you also document (and have tests that
            validate) the underlying errors that you expose. If you do not expect your
            caller to call
    <code class="language-plaintext highlighter-rouge">
     errors.Unwrap
    </code>
    ,
    <code class="language-plaintext highlighter-rouge">
     errors.Is
    </code>
    and so on, don’t bother with
    <code class="language-plaintext highlighter-rouge">
     %w
    </code>
    .
   </p>
   <p>
    The same concept applies to
    <a href="#error-structure">
     structured errors
    </a>
    like
    <a href="https://pkg.go.dev/google.golang.org/grpc/status">
     <code class="language-plaintext highlighter-rouge">
      *status.Status
     </code>
    </a>
    (see
    <a href="https://pkg.go.dev/google.golang.org/grpc/codes">
     canonical codes
    </a>
    ). For example, if your server
            sends malformed requests to a backend and receives an
    <code class="language-plaintext highlighter-rouge">
     InvalidArgument
    </code>
    code,
            this code should
    <em>
     not
    </em>
    be propagated to the client, assuming that the client has
            done nothing wrong. Instead, return an
    <code class="language-plaintext highlighter-rouge">
     Internal
    </code>
    canonical code to the client.
   </p>
   <p>
    However, annotating errors helps automated logging systems preserve the status
            payload of an error. For example, annotating the error is appropriate in an
            internal function:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">func</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span><span class="n">Server</span><span class="p">)</span> <span class="n">internalFunction</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="c">// ...</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"couldn't find remote file: %w"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    Code directly at system boundaries (typically RPC, IPC, storage, and similar)
            should report errors using the canonical error space. It is the responsibility
            of code here to handle domain-specific errors and represent them canonically.
            For example:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Bad:</span>
<span class="k">func</span> <span class="p">(</span><span class="o">*</span><span class="n">FortuneTeller</span><span class="p">)</span> <span class="n">SuggestFortune</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">SuggestionRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">SuggestionResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c">// ...</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="no">nil</span><span class="p">,</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"couldn't find remote file: %w"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">import</span> <span class="p">(</span>
    <span class="s">"google.golang.org/grpc/codes"</span>
    <span class="s">"google.golang.org/grpc/status"</span>
<span class="p">)</span>
<span class="k">func</span> <span class="p">(</span><span class="o">*</span><span class="n">FortuneTeller</span><span class="p">)</span> <span class="n">SuggestFortune</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">SuggestionRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">SuggestionResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c">// ...</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="c">// Or use fmt.Errorf with the %w verb if deliberately wrapping an</span>
        <span class="c">// error which the caller is meant to unwrap.</span>
        <span class="k">return</span> <span class="no">nil</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="n">codes</span><span class="o">.</span><span class="n">Internal</span><span class="p">,</span> <span class="s">"couldn't find fortune database"</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">ErrInternal</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    See also:
   </p>
   <ul>
    <li>
     <a href="#documentation-conventions-errors">
      Error Documentation Conventions
     </a>
    </li>
   </ul>
   <p>
    <a id="error-percent-w">
    </a>
   </p>
   <h3 id="placement-of-w-in-errors">
    Placement of %w in errors
   </h3>
   <p>
    Prefer to place
    <code class="language-plaintext highlighter-rouge">
     %w
    </code>
    at the end of an error string.
   </p>
   <p>
    Errors can be wrapped with
    <a href="https://blog.golang.org/go1.13-errors">
     the
     <code class="language-plaintext highlighter-rouge">
      %w
     </code>
     verb
    </a>
    , or by placing them in a
    <a href="https://google.github.io/styleguide/go/index.html#gotip">
     structured error
    </a>
    that
            implements
    <code class="language-plaintext highlighter-rouge">
     Unwrap() error
    </code>
    (ex:
    <a href="https://pkg.go.dev/io/fs#PathError">
     <code class="language-plaintext highlighter-rouge">
      fs.PathError
     </code>
    </a>
    ).
   </p>
   <p>
    Wrapped errors form error chains: each new layer of wrapping adds a new entry to
            the front of the error chain. The error chain can be traversed with the
    <code class="language-plaintext highlighter-rouge">
     Unwrap() error
    </code>
    method. For example:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="n">err1</span> <span class="o">:=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"err1"</span><span class="p">)</span>
<span class="n">err2</span> <span class="o">:=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"err2: %w"</span><span class="p">,</span> <span class="n">err1</span><span class="p">)</span>
<span class="n">err3</span> <span class="o">:=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"err3: %w"</span><span class="p">,</span> <span class="n">err2</span><span class="p">)</span>
</code></pre>
    </div>
   </div>
   <p>
    This forms an error chain of the form,
   </p>
   <pre><code class="language-mermaid">flowchart LR
  err3 == err3 wraps err2 ==&gt; err2;
  err2 == err2 wraps err1 ==&gt; err1;
</code></pre>
   <p>
    Regardless of where the
    <code class="language-plaintext highlighter-rouge">
     %w
    </code>
    verb is placed, the error returned always
            represents the front of the error chain, and the
    <code class="language-plaintext highlighter-rouge">
     %w
    </code>
    is the next child.
            Similarly,
    <code class="language-plaintext highlighter-rouge">
     Unwrap() error
    </code>
    always traverses the error chain from newest to
            oldest error.
   </p>
   <p>
    Placement of the
    <code class="language-plaintext highlighter-rouge">
     %w
    </code>
    verb does, however, affect whether the error chain is
            printed newest to oldest, oldest to newest, or neither:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="n">err1</span> <span class="o">:=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"err1"</span><span class="p">)</span>
<span class="n">err2</span> <span class="o">:=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"err2: %w"</span><span class="p">,</span> <span class="n">err1</span><span class="p">)</span>
<span class="n">err3</span> <span class="o">:=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"err3: %w"</span><span class="p">,</span> <span class="n">err2</span><span class="p">)</span>
<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">err3</span><span class="p">)</span> <span class="c">// err3: err2: err1</span>
<span class="c">// err3 is a newest-to-oldest error chain, that prints newest-to-oldest.</span>
</code></pre>
    </div>
   </div>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Bad:</span>
<span class="n">err1</span> <span class="o">:=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"err1"</span><span class="p">)</span>
<span class="n">err2</span> <span class="o">:=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"%w: err2"</span><span class="p">,</span> <span class="n">err1</span><span class="p">)</span>
<span class="n">err3</span> <span class="o">:=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"%w: err3"</span><span class="p">,</span> <span class="n">err2</span><span class="p">)</span>
<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">err3</span><span class="p">)</span> <span class="c">// err1: err2: err3</span>
<span class="c">// err3 is a newest-to-oldest error chain, that prints oldest-to-newest.</span>
</code></pre>
    </div>
   </div>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Bad:</span>
<span class="n">err1</span> <span class="o">:=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"err1"</span><span class="p">)</span>
<span class="n">err2</span> <span class="o">:=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"err2-1 %w err2-2"</span><span class="p">,</span> <span class="n">err1</span><span class="p">)</span>
<span class="n">err3</span> <span class="o">:=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"err3-1 %w err3-2"</span><span class="p">,</span> <span class="n">err2</span><span class="p">)</span>
<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">err3</span><span class="p">)</span> <span class="c">// err3-1 err2-1 err1 err2-2 err3-2</span>
<span class="c">// err3 is a newest-to-oldest error chain, that neither prints newest-to-oldest</span>
<span class="c">// nor oldest-to-newest.</span>
</code></pre>
    </div>
   </div>
   <p>
    Therefore, in order for error text to mirror error chain structure, prefer
            placing the
    <code class="language-plaintext highlighter-rouge">
     %w
    </code>
    verb at the end with the form
    <code class="language-plaintext highlighter-rouge">
     [...]: %w
    </code>
    .
   </p>
   <p>
    <a id="error-logging">
    </a>
   </p>
   <h3 id="logging-errors">
    Logging errors
   </h3>
   <p>
    Functions sometimes need to tell an external system about an error without
            propagating it to their callers. Logging is an obvious choice here; but be
            conscious of what and how you log errors.
   </p>
   <ul>
    <li>
     <p>
      Like
      <a href="https://google.github.io/styleguide/go/decisions#useful-test-failures">
       good test failure messages
      </a>
      , log messages should clearly express what
                    went wrong and help the maintainer by including relevant information to
                    diagnose the problem.
     </p>
    </li>
    <li>
     <p>
      Avoid duplication. If you return an error, it’s usually better not to log it
                    yourself but rather let the caller handle it. The caller can choose to log
                    the error, or perhaps rate-limit logging using
      <a href="https://pkg.go.dev/golang.org/x/time/rate#Sometimes">
       <code class="language-plaintext highlighter-rouge">
        rate.Sometimes
       </code>
      </a>
      . Other
                    options include attempting recovery or even
      <a href="#checks-and-panics">
       stopping the program
      </a>
      . In any
                    case, giving the caller control helps avoid logspam.
     </p>
     <p>
      The downside to this approach, however, is that any logging is written using
                    the caller’s line coordinates.
     </p>
    </li>
    <li>
     <p>
      Be careful with
      <a href="https://en.wikipedia.org/wiki/Personal_data">
       PII
      </a>
      . Many log sinks are not appropriate destinations for
                    sensitive end-user information.
     </p>
    </li>
    <li>
     <p>
      Use
      <code class="language-plaintext highlighter-rouge">
       log.Error
      </code>
      sparingly. ERROR level logging causes a flush and is more
                    expensive than lower logging levels. This can have serious performance
                    impact on your code. When deciding between error and warning levels,
                    consider the best practice that messages at the error level should be
                    actionable rather than “more serious” than a warning.
     </p>
    </li>
    <li>
     <p>
      Inside Google, we have monitoring systems that can be set up for more
                    effective alerting than writing to a log file and hoping someone notices it.
                    This is similar but not identical to the standard library
      <a href="https://pkg.go.dev/expvar">
       package
       <code class="language-plaintext highlighter-rouge">
        expvar
       </code>
      </a>
      .
     </p>
    </li>
   </ul>
   <p>
    <a id="vlog">
    </a>
   </p>
   <h4 id="custom-verbosity-levels">
    Custom verbosity levels
   </h4>
   <p>
    Use verbose logging (
    <a href="https://pkg.go.dev/github.com/golang/glog#V">
     <code class="language-plaintext highlighter-rouge">
      log.V
     </code>
    </a>
    ) to your advantage. Verbose logging can be useful
            for development and tracing. Establishing a convention around verbosity levels
            can be helpful. For example:
   </p>
   <ul>
    <li>
     Write a small amount of extra information at
     <code class="language-plaintext highlighter-rouge">
      V(1)
     </code>
    </li>
    <li>
     Trace more information in
     <code class="language-plaintext highlighter-rouge">
      V(2)
     </code>
    </li>
    <li>
     Dump large internal states in
     <code class="language-plaintext highlighter-rouge">
      V(3)
     </code>
    </li>
   </ul>
   <p>
    To minimize the cost of verbose logging, you should ensure not to accidentally
            call expensive functions even when
    <code class="language-plaintext highlighter-rouge">
     log.V
    </code>
    is turned off.
    <code class="language-plaintext highlighter-rouge">
     log.V
    </code>
    offers two
            APIs. The more convenient one carries the risk of this accidental expense. When
            in doubt, use the slightly more verbose style.
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">sql</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">queries</span> <span class="p">{</span>
  <span class="n">log</span><span class="o">.</span><span class="n">V</span><span class="p">(</span><span class="m">1</span><span class="p">)</span><span class="o">.</span><span class="n">Infof</span><span class="p">(</span><span class="s">"Handling %v"</span><span class="p">,</span> <span class="n">sql</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">V</span><span class="p">(</span><span class="m">2</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">log</span><span class="o">.</span><span class="n">Infof</span><span class="p">(</span><span class="s">"Handling %v"</span><span class="p">,</span> <span class="n">sql</span><span class="o">.</span><span class="n">Explain</span><span class="p">())</span>
  <span class="p">}</span>
  <span class="n">sql</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Bad:</span>
<span class="c">// sql.Explain called even when this log is not printed.</span>
<span class="n">log</span><span class="o">.</span><span class="n">V</span><span class="p">(</span><span class="m">2</span><span class="p">)</span><span class="o">.</span><span class="n">Infof</span><span class="p">(</span><span class="s">"Handling %v"</span><span class="p">,</span> <span class="n">sql</span><span class="o">.</span><span class="n">Explain</span><span class="p">())</span>
</code></pre>
    </div>
   </div>
   <p>
    <a id="program-init">
    </a>
   </p>
   <h3 id="program-initialization">
    Program initialization
   </h3>
   <p>
    Program initialization errors (such as bad flags and configuration) should be
            propagated upward to
    <code class="language-plaintext highlighter-rouge">
     main
    </code>
    , which should call
    <code class="language-plaintext highlighter-rouge">
     log.Exit
    </code>
    with an error that
            explains how to fix the error. In these cases,
    <code class="language-plaintext highlighter-rouge">
     log.Fatal
    </code>
    should not generally
            be used, because a stack trace that points at the check is not likely to be as
            useful as a human-generated, actionable message.
   </p>
   <p>
    <a id="checks-and-panics">
    </a>
   </p>
   <h3 id="program-checks-and-panics">
    Program checks and panics
   </h3>
   <p>
    As stated in the
    <a href="https://google.github.io/styleguide/go/decisions#dont-panic">
     decision against panics
    </a>
    , standard error handling should be
            structured around error return values. Libraries should prefer returning an
            error to the caller rather than aborting the program, especially for transient
            errors.
   </p>
   <p>
    It is occasionally necessary to perform consistency checks on an invariant and
            terminate the program if it is violated. In general, this is only done when a
            failure of the invariant check means that the internal state has become
            unrecoverable. The most reliable way to do this in the Google codebase is to
            call
    <code class="language-plaintext highlighter-rouge">
     log.Fatal
    </code>
    . Using
    <code class="language-plaintext highlighter-rouge">
     panic
    </code>
    in these cases is not reliable, because it is
            possible for deferred functions to deadlock or further corrupt internal or
            external state.
   </p>
   <p>
    Similarly, resist the temptation to recover panics to avoid crashes, as doing so
            can result in propagating a corrupted state. The further you are from the panic,
            the less you know about the state of the program, which could be holding locks
            or other resources. The program can then develop other unexpected failure modes
            that can make the problem even more difficult to diagnose. Instead of trying to
            handle unexpected panics in code, use monitoring tools to surface unexpected
            failures and fix related bugs with a high priority.
   </p>
   <p>
    <strong>
     Note:
    </strong>
    The standard
    <a href="https://pkg.go.dev/net/http#Server">
     <code class="language-plaintext highlighter-rouge">
      net/http
     </code>
     server
    </a>
    violates this advice and recovers
            panics from request handlers. Consensus among experienced Go engineers is that
            this was a historical mistake. If you sample server logs from application
            servers in other languages, it is common to find large stacktraces that are left
            unhandled. Avoid this pitfall in your servers.
   </p>
   <p>
    <a id="when-to-panic">
    </a>
   </p>
   <h3 id="when-to-panic">
    When to panic
   </h3>
   <p>
    The standard library panics on API misuse. For example,
    <a href="https://pkg.go.dev/reflect">
     <code class="language-plaintext highlighter-rouge">
      reflect
     </code>
    </a>
    issues a
            panic in many cases where a value is accessed in a way that suggests it was
            misinterpreted. This is analogous to the panics on core language bugs such as
            accessing an element of a slice that is out of bounds. Code review and tests
            should discover such bugs, which are not expected to appear in production code.
            These panics act as invariant checks that do not depend on a library, as the
            standard library does not have access to the
    <a href="decisions#logging">
     levelled
     <code class="language-plaintext highlighter-rouge">
      log
     </code>
    </a>
    package that the
            Google codebase uses.
   </p>
   <p>
    Another case in which panics can be useful, though uncommon, is as an internal
            implementation detail of a package which always has a matching recover in the
            callchain. Parsers and similar deeply nested, tightly coupled internal function
            groups can benefit from this design, where plumbing error returns adds
            complexity without value. The key attribute of this design is that these panics
            are never allowed to escape across package boundaries and do not form part of
            the package’s API. This is typically accomplished with a top-level deferred
            recover that translates a propagating panic into a returned error at the public
            API surfaces.
   </p>
   <p>
    Panic is also used when the compiler cannot identify unreachable code, for
            example when using a function like
    <code class="language-plaintext highlighter-rouge">
     log.Fatal
    </code>
    that will not return:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">func</span> <span class="n">answer</span><span class="p">(</span><span class="n">i</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="n">i</span> <span class="p">{</span>
    <span class="k">case</span> <span class="m">42</span><span class="o">:</span>
        <span class="k">return</span> <span class="s">"yup"</span>
    <span class="k">case</span> <span class="m">54</span><span class="o">:</span>
        <span class="k">return</span> <span class="s">"base 13, huh"</span>
    <span class="k">default</span><span class="o">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"Sorry, %d is not the answer."</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="nb">panic</span><span class="p">(</span><span class="s">"unreachable"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    <a href="https://pkg.go.dev/github.com/golang/glog#pkg-overview">
     Do not call
     <code class="language-plaintext highlighter-rouge">
      log
     </code>
     functions before flags have been parsed.
    </a>
    If you must die in an
    <code class="language-plaintext highlighter-rouge">
     init
    </code>
    func, a panic is acceptable in place of the logging
            call.
   </p>
   <p>
    <a id="documentation">
    </a>
   </p>
   <h2 id="documentation">
    Documentation
   </h2>
   <p>
    <a id="documentation-conventions">
    </a>
   </p>
   <h3 id="conventions">
    Conventions
   </h3>
   <p>
    This section augments the decisions document’s
    <a href="decisions#commentary">
     commentary
    </a>
    section.
   </p>
   <p>
    Go code that is documented in familiar style is easier to read and less likely
            to be misused than something misdocumented or not documented at all. Runnable
    <a href="decisions#examples">
     examples
    </a>
    show up in Godoc and Code Search and are an excellent way of
            explaining how to use your code.
   </p>
   <p>
    <a id="documentation-conventions-params">
    </a>
   </p>
   <h4 id="parameters-and-configuration">
    Parameters and configuration
   </h4>
   <p>
    Not every parameter must be enumerated in the documentation. This applies to:
   </p>
   <ul>
    <li>
     function and method parameters
    </li>
    <li>
     struct fields
    </li>
    <li>
     APIs for options
    </li>
   </ul>
   <p>
    Document the error-prone or non-obvious fields and parameters by saying why they
            are interesting.
   </p>
   <p>
    In the following snippet, the highlighted commentary adds little useful
            information to the reader:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Bad:</span>
<span class="c">// Sprintf formats according to a format specifier and returns the resulting</span>
<span class="c">// string.</span>
<span class="c">//</span>
<span class="c">// format is the format, and data is the interpolation data.</span>
<span class="k">func</span> <span class="n">Sprintf</span><span class="p">(</span><span class="n">format</span> <span class="kt">string</span><span class="p">,</span> <span class="n">data</span> <span class="o">...</span><span class="n">any</span><span class="p">)</span> <span class="kt">string</span>
</code></pre>
    </div>
   </div>
   <p>
    However, this snippet demonstrates a code scenario similar to the previous where
            the commentary instead states something non-obvious or materially helpful to the
            reader:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="c">// Sprintf formats according to a format specifier and returns the resulting</span>
<span class="c">// string.</span>
<span class="c">//</span>
<span class="c">// The provided data is used to interpolate the format string. If the data does</span>
<span class="c">// not match the expected format verbs or the amount of data does not satisfy</span>
<span class="c">// the format specification, the function will inline warnings about formatting</span>
<span class="c">// errors into the output string as described by the Format errors section</span>
<span class="c">// above.</span>
<span class="k">func</span> <span class="n">Sprintf</span><span class="p">(</span><span class="n">format</span> <span class="kt">string</span><span class="p">,</span> <span class="n">data</span> <span class="o">...</span><span class="n">any</span><span class="p">)</span> <span class="kt">string</span>
</code></pre>
    </div>
   </div>
   <p>
    Consider your likely audience in choosing what to document and at what depth.
            Maintainers, newcomers to the team, external users, and even yourself six months
            in the future may appreciate slightly different information from what is on your
            mind when you first come to write your docs.
   </p>
   <p>
    See also:
   </p>
   <ul>
    <li>
     <a href="https://google.github.io/styleguide/go/index.html#gotip">
      GoTip #41: Identify Function Call Parameters
     </a>
    </li>
    <li>
     <a href="https://google.github.io/styleguide/go/index.html#gotip">
      GoTip #51: Patterns for Configuration
     </a>
    </li>
   </ul>
   <p>
    <a id="documentation-conventions-contexts">
    </a>
   </p>
   <h4 id="contexts">
    Contexts
   </h4>
   <p>
    It is implied that the cancellation of a context argument interrupts the
            function it is provided to. If the function can return an error, conventionally
            it is
    <code class="language-plaintext highlighter-rouge">
     ctx.Err()
    </code>
    .
   </p>
   <p>
    This fact does not need to be restated:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Bad:</span>
<span class="c">// Run executes the worker's run loop.</span>
<span class="c">//</span>
<span class="c">// The method will process work until the context is cancelled and accordingly</span>
<span class="c">// returns an error.</span>
<span class="k">func</span> <span class="p">(</span><span class="n">Worker</span><span class="p">)</span> <span class="n">Run</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="kt">error</span>
</code></pre>
    </div>
   </div>
   <p>
    Because that is implied, the following is better:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="c">// Run executes the worker's run loop.</span>
<span class="k">func</span> <span class="p">(</span><span class="n">Worker</span><span class="p">)</span> <span class="n">Run</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="kt">error</span>
</code></pre>
    </div>
   </div>
   <p>
    Where context behavior is different or non-obvious, it should be expressly
            documented if any of the following are true.
   </p>
   <ul>
    <li>
     <p>
      The function returns an error other than
      <code class="language-plaintext highlighter-rouge">
       ctx.Err()
      </code>
      when the context is
                    cancelled:
     </p>
     <div class="language-go highlighter-rouge">
      <div class="highlight">
       <pre class="highlight"><code><span class="c">// Good:</span>
<span class="c">// Run executes the worker's run loop.</span>
<span class="c">//</span>
<span class="c">// If the context is cancelled, Run returns a nil error.</span>
<span class="k">func</span> <span class="p">(</span><span class="n">Worker</span><span class="p">)</span> <span class="n">Run</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="kt">error</span>
</code></pre>
      </div>
     </div>
    </li>
    <li>
     <p>
      The function has other mechanisms that may interrupt it or affect lifetime:
     </p>
     <div class="language-go highlighter-rouge">
      <div class="highlight">
       <pre class="highlight"><code><span class="c">// Good:</span>
<span class="c">// Run executes the worker's run loop.</span>
<span class="c">//</span>
<span class="c">// Run processes work until the context is cancelled or Stop is called.</span>
<span class="c">// Context cancellation is handled asynchronously internally: run may return</span>
<span class="c">// before all work has stopped. The Stop method is synchronous and waits</span>
<span class="c">// until all operations from the run loop finish. Use Stop for graceful</span>
<span class="c">// shutdown.</span>
<span class="k">func</span> <span class="p">(</span><span class="n">Worker</span><span class="p">)</span> <span class="n">Run</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="kt">error</span>

<span class="k">func</span> <span class="p">(</span><span class="n">Worker</span><span class="p">)</span> <span class="n">Stop</span><span class="p">()</span>
</code></pre>
      </div>
     </div>
    </li>
    <li>
     <p>
      The function has special expectations about context lifetime, lineage, or
                    attached values:
     </p>
     <div class="language-go highlighter-rouge">
      <div class="highlight">
       <pre class="highlight"><code><span class="c">// Good:</span>
<span class="c">// NewReceiver starts receiving messages sent to the specified queue.</span>
<span class="c">// The context should not have a deadline.</span>
<span class="k">func</span> <span class="n">NewReceiver</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="o">*</span><span class="n">Receiver</span>

<span class="c">// Principal returns a human-readable name of the party who made the call.</span>
<span class="c">// The context must have a value attached to it from security.NewContext.</span>
<span class="k">func</span> <span class="n">Principal</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="p">(</span><span class="n">name</span> <span class="kt">string</span><span class="p">,</span> <span class="n">ok</span> <span class="kt">bool</span><span class="p">)</span>
</code></pre>
      </div>
     </div>
     <p>
      <strong>
       Warning:
      </strong>
      Avoid designing APIs that make such demands (like contexts not
                    having deadlines) from their callers. The above is only an example of how to
                    document this if it cannot be avoided, not an endorsement of the pattern.
     </p>
    </li>
   </ul>
   <p>
    <a id="documentation-conventions-concurrency">
    </a>
   </p>
   <h4 id="concurrency">
    Concurrency
   </h4>
   <p>
    Go users assume that conceptually read-only operations are safe for concurrent
            use and do not require extra synchronization.
   </p>
   <p>
    The extra remark about concurrency can safely be removed in this Godoc:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Len returns the number of bytes of the unread portion of the buffer;</span>
<span class="c">// b.Len() == len(b.Bytes()).</span>
<span class="c">//</span>
<span class="c">// It is safe to be called concurrently by multiple goroutines.</span>
<span class="k">func</span> <span class="p">(</span><span class="o">*</span><span class="n">Buffer</span><span class="p">)</span> <span class="n">Len</span><span class="p">()</span> <span class="kt">int</span>
</code></pre>
    </div>
   </div>
   <p>
    Mutating operations, however, are not assumed to be safe for concurrent use and
            require the user to consider synchronization.
   </p>
   <p>
    Similarly, the extra remark about concurrency can safely be removed here:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Grow grows the buffer's capacity.</span>
<span class="c">//</span>
<span class="c">// It is not safe to be called concurrently by multiple goroutines.</span>
<span class="k">func</span> <span class="p">(</span><span class="o">*</span><span class="n">Buffer</span><span class="p">)</span> <span class="n">Grow</span><span class="p">(</span><span class="n">n</span> <span class="kt">int</span><span class="p">)</span>
</code></pre>
    </div>
   </div>
   <p>
    Documentation is strongly encouraged if any of the following are true.
   </p>
   <ul>
    <li>
     <p>
      It is unclear whether the operation is read-only or mutating:
     </p>
     <div class="language-go highlighter-rouge">
      <div class="highlight">
       <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">package</span> <span class="n">lrucache</span>

<span class="c">// Lookup returns the data associated with the key from the cache.</span>
<span class="c">//</span>
<span class="c">// This operation is not safe for concurrent use.</span>
<span class="k">func</span> <span class="p">(</span><span class="o">*</span><span class="n">Cache</span><span class="p">)</span> <span class="n">Lookup</span><span class="p">(</span><span class="n">key</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="n">ok</span> <span class="kt">bool</span><span class="p">)</span>
</code></pre>
      </div>
     </div>
     <p>
      Why? A cache hit when looking up the key mutate a LRU cache internally. How
                    this is implemented may not be obvious to all readers.
     </p>
    </li>
    <li>
     <p>
      Synchronization is provided by the API:
     </p>
     <div class="language-go highlighter-rouge">
      <div class="highlight">
       <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">package</span> <span class="n">fortune_go_proto</span>

<span class="c">// NewFortuneTellerClient returns an *rpc.Client for the FortuneTeller service.</span>
<span class="c">// It is safe for simultaneous use by multiple goroutines.</span>
<span class="k">func</span> <span class="n">NewFortuneTellerClient</span><span class="p">(</span><span class="n">cc</span> <span class="o">*</span><span class="n">rpc</span><span class="o">.</span><span class="n">ClientConn</span><span class="p">)</span> <span class="o">*</span><span class="n">FortuneTellerClient</span>
</code></pre>
      </div>
     </div>
     <p>
      Why? Stubby provides synchronization.
     </p>
     <p>
      <strong>
       Note:
      </strong>
      If the API is a type and the API provides synchronization in
                    entirety, conventionally only the type definition documents the semantics.
     </p>
    </li>
    <li>
     <p>
      The API consumes user-implemented types of interfaces, and the interface’s
                    consumer has particular concurrency requirements:
     </p>
     <div class="language-go highlighter-rouge">
      <div class="highlight">
       <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">package</span> <span class="n">health</span>

<span class="c">// A Watcher reports the health of some entity (usually a backend service).</span>
<span class="c">//</span>
<span class="c">// Watcher methods are safe for simultaneous use by multiple goroutines.</span>
<span class="k">type</span> <span class="n">Watcher</span> <span class="k">interface</span> <span class="p">{</span>
    <span class="c">// Watch sends true on the passed-in channel when the Watcher's</span>
    <span class="c">// status has changed.</span>
    <span class="n">Watch</span><span class="p">(</span><span class="n">changed</span> <span class="k">chan</span><span class="o">&lt;-</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">(</span><span class="n">unwatch</span> <span class="k">func</span><span class="p">())</span>

    <span class="c">// Health returns nil if the entity being watched is healthy, or a</span>
    <span class="c">// non-nil error explaining why the entity is not healthy.</span>
    <span class="n">Health</span><span class="p">()</span> <span class="kt">error</span>
<span class="p">}</span>
</code></pre>
      </div>
     </div>
     <p>
      Why? Whether an API is safe for use by multiple goroutines is part of its
                    contract.
     </p>
    </li>
   </ul>
   <p>
    <a id="documentation-conventions-cleanup">
    </a>
   </p>
   <h4 id="cleanup">
    Cleanup
   </h4>
   <p>
    Document any explicit cleanup requirements that the API has. Otherwise, callers
            won’t use the API correctly, leading to resource leaks and other possible bugs.
   </p>
   <p>
    Call out cleanups that are up to the caller:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="c">// NewTicker returns a new Ticker containing a channel that will send the</span>
<span class="c">// current time on the channel after each tick.</span>
<span class="c">//</span>
<span class="c">// Call Stop to release the Ticker's associated resources when done.</span>
<span class="k">func</span> <span class="n">NewTicker</span><span class="p">(</span><span class="n">d</span> <span class="n">Duration</span><span class="p">)</span> <span class="o">*</span><span class="n">Ticker</span>

<span class="k">func</span> <span class="p">(</span><span class="o">*</span><span class="n">Ticker</span><span class="p">)</span> <span class="n">Stop</span><span class="p">()</span>
</code></pre>
    </div>
   </div>
   <p>
    If it is potentially unclear how to clean up the resources, explain how:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="c">// Get issues a GET to the specified URL.</span>
<span class="c">//</span>
<span class="c">// When err is nil, resp always contains a non-nil resp.Body.</span>
<span class="c">// Caller should close resp.Body when done reading from it.</span>
<span class="c">//</span>
<span class="c">//    resp, err := http.Get("http://example.com/")</span>
<span class="c">//    if err != nil {</span>
<span class="c">//        // handle error</span>
<span class="c">//    }</span>
<span class="c">//    defer resp.Body.Close()</span>
<span class="c">//    body, err := io.ReadAll(resp.Body)</span>
<span class="k">func</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">Client</span><span class="p">)</span> <span class="n">Get</span><span class="p">(</span><span class="n">url</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">resp</span> <span class="o">*</span><span class="n">Response</span><span class="p">,</span> <span class="n">err</span> <span class="kt">error</span><span class="p">)</span>
</code></pre>
    </div>
   </div>
   <p>
    See also:
   </p>
   <ul>
    <li>
     <a href="https://google.github.io/styleguide/go/index.html#gotip">
      GoTip #110: Don’t Mix Exit With Defer
     </a>
    </li>
   </ul>
   <p>
    <a id="documentation-conventions-errors">
    </a>
   </p>
   <h4 id="errors">
    Errors
   </h4>
   <p>
    Document significant error sentinel values or error types that your functions
            return to callers so that callers can anticipate what types of conditions they
            can handle in their code.
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">package</span> <span class="n">os</span>

<span class="c">// Read reads up to len(b) bytes from the File and stores them in b. It returns</span>
<span class="c">// the number of bytes read and any error encountered.</span>
<span class="c">//</span>
<span class="c">// At end of file, Read returns 0, io.EOF.</span>
<span class="k">func</span> <span class="p">(</span><span class="o">*</span><span class="n">File</span><span class="p">)</span> <span class="n">Read</span><span class="p">(</span><span class="n">b</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="n">n</span> <span class="kt">int</span><span class="p">,</span> <span class="n">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</code></pre>
    </div>
   </div>
   <p>
    When a function returns a specific error type, correctly note whether the error
            is a pointer receiver or not:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">package</span> <span class="n">os</span>

<span class="k">type</span> <span class="n">PathError</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">Op</span>   <span class="kt">string</span>
    <span class="n">Path</span> <span class="kt">string</span>
    <span class="n">Err</span>  <span class="kt">error</span>
<span class="p">}</span>

<span class="c">// Chdir changes the current working directory to the named directory.</span>
<span class="c">//</span>
<span class="c">// If there is an error, it will be of type *PathError.</span>
<span class="k">func</span> <span class="n">Chdir</span><span class="p">(</span><span class="n">dir</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</code></pre>
    </div>
   </div>
   <p>
    Documenting whether the values returned are pointer receivers enables callers to
            correctly compare the errors using
    <a href="https://pkg.go.dev/errors#Is">
     <code class="language-plaintext highlighter-rouge">
      errors.Is
     </code>
    </a>
    ,
    <a href="https://pkg.go.dev/errors#As">
     <code class="language-plaintext highlighter-rouge">
      errors.As
     </code>
    </a>
    , and
    <a href="https://pkg.go.dev/github.com/google/go-cmp/cmp">
     <code class="language-plaintext highlighter-rouge">
      package cmp
     </code>
    </a>
    . This is because a non-pointer value is not equivalent to a
            pointer value.
   </p>
   <p>
    <strong>
     Note:
    </strong>
    In the
    <code class="language-plaintext highlighter-rouge">
     Chdir
    </code>
    example, the return type is written as
    <code class="language-plaintext highlighter-rouge">
     error
    </code>
    rather
            than
    <code class="language-plaintext highlighter-rouge">
     *PathError
    </code>
    due to
    <a href="https://go.dev/doc/faq#nil_error">
     how nil interface values work
    </a>
    .
   </p>
   <p>
    Document overall error conventions in the
    <a href="decisions#package-comments">
     package’s documentation
    </a>
    when the behavior is
            applicable to most errors found in the package:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="c">// Package os provides a platform-independent interface to operating system</span>
<span class="c">// functionality.</span>
<span class="c">//</span>
<span class="c">// Often, more information is available within the error. For example, if a</span>
<span class="c">// call that takes a file name fails, such as Open or Stat, the error will</span>
<span class="c">// include the failing file name when printed and will be of type *PathError,</span>
<span class="c">// which may be unpacked for more information.</span>
<span class="k">package</span> <span class="n">os</span>
</code></pre>
    </div>
   </div>
   <p>
    Thoughtful application of these approaches can add
    <a href="#error-extra-info">
     extra information to errors
    </a>
    without much effort and help
            callers avoid adding redundant annotations.
   </p>
   <p>
    See also:
   </p>
   <ul>
    <li>
     <a href="https://google.github.io/styleguide/go/index.html#gotip">
      Go Tip #106: Error Naming Conventions
     </a>
    </li>
    <li>
     <a href="https://google.github.io/styleguide/go/index.html#gotip">
      Go Tip #89: When to Use Canonical Status Codes as Errors
     </a>
    </li>
   </ul>
   <p>
    <a id="documentation-preview">
    </a>
   </p>
   <h3 id="preview">
    Preview
   </h3>
   <p>
    Go features a
    <a href="https://pkg.go.dev/golang.org/x/pkgsite/cmd/pkgsite">
     documentation server
    </a>
    . It
            is recommended to preview the documentation your code produces both before and
            during the code review process. This helps to validate that the
    <a href="#godoc-formatting">
     godoc formatting
    </a>
    is rendered correctly.
   </p>
   <p>
    <a id="godoc-formatting">
    </a>
   </p>
   <h3 id="godoc-formatting">
    Godoc formatting
   </h3>
   <p>
    <a href="https://pkg.go.dev/">
     Godoc
    </a>
    provides some specific syntax to
    <a href="https://go.dev/doc/comment">
     format documentation
    </a>
    .
   </p>
   <ul>
    <li>
     <p>
      A blank line is required to separate paragraphs:
     </p>
     <div class="language-go highlighter-rouge">
      <div class="highlight">
       <pre class="highlight"><code><span class="c">// Good:</span>
<span class="c">// LoadConfig reads a configuration out of the named file.</span>
<span class="c">//</span>
<span class="c">// See some/shortlink for config file format details.</span>
</code></pre>
      </div>
     </div>
    </li>
    <li>
     <p>
      Test files can contain
      <a href="decisions#examples">
       runnable examples
      </a>
      that appear attached to the
                    corresponding documentation in godoc:
     </p>
     <div class="language-go highlighter-rouge">
      <div class="highlight">
       <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">func</span> <span class="n">ExampleConfig_WriteTo</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">cfg</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">Config</span><span class="p">{</span>
    <span class="n">Name</span><span class="o">:</span> <span class="s">"example"</span><span class="p">,</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">WriteTo</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Stdout</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="n">log</span><span class="o">.</span><span class="n">Exitf</span><span class="p">(</span><span class="s">"Failed to write config: %s"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="c">// Output:</span>
  <span class="c">// {</span>
  <span class="c">//   "name": "example"</span>
  <span class="c">// }</span>
<span class="p">}</span>
</code></pre>
      </div>
     </div>
    </li>
    <li>
     <p>
      Indenting lines by an additional two spaces formats them verbatim:
     </p>
     <div class="language-go highlighter-rouge">
      <div class="highlight">
       <pre class="highlight"><code><span class="c">// Good:</span>
<span class="c">// Update runs the function in an atomic transaction.</span>
<span class="c">//</span>
<span class="c">// This is typically used with an anonymous TransactionFunc:</span>
<span class="c">//</span>
<span class="c">//   if err := db.Update(func(state *State) { state.Foo = bar }); err != nil {</span>
<span class="c">//     //...</span>
<span class="c">//   }</span>
</code></pre>
      </div>
     </div>
     <p>
      Note, however, that it can often be more appropriate to put code in a
                    runnable example instead of including it in a comment.
     </p>
     <p>
      This verbatim formatting can be leveraged for formatting that is not native
                    to godoc, such as lists and tables:
     </p>
     <div class="language-go highlighter-rouge">
      <div class="highlight">
       <pre class="highlight"><code><span class="c">// Good:</span>
<span class="c">// LoadConfig reads a configuration out of the named file.</span>
<span class="c">//</span>
<span class="c">// LoadConfig treats the following keys in special ways:</span>
<span class="c">//   "import" will make this configuration inherit from the named file.</span>
<span class="c">//   "env" if present will be populated with the system environment.</span>
</code></pre>
      </div>
     </div>
    </li>
    <li>
     <p>
      A single line that begins with a capital letter, contains no punctuation
                    except parentheses and commas, and is followed by another paragraph, is
                    formatted as a header:
     </p>
     <div class="language-go highlighter-rouge">
      <div class="highlight">
       <pre class="highlight"><code><span class="c">// Good:</span>
<span class="c">// The following line is formatted as a heading.</span>
<span class="c">//</span>
<span class="c">// Using headings</span>
<span class="c">//</span>
<span class="c">// Headings come with autogenerated anchor tags for easy linking.</span>
</code></pre>
      </div>
     </div>
    </li>
   </ul>
   <p>
    <a id="signal-boost">
    </a>
   </p>
   <h3 id="signal-boosting">
    Signal boosting
   </h3>
   <p>
    Sometimes a line of code looks like something common, but actually isn’t. One of
            the best examples of this is an
    <code class="language-plaintext highlighter-rouge">
     err == nil
    </code>
    check (since
    <code class="language-plaintext highlighter-rouge">
     err != nil
    </code>
    is much
            more common). The following two conditional checks are hard to distinguish:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">doSomething</span><span class="p">();</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="c">// ...</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Bad:</span>
<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">doSomething</span><span class="p">();</span> <span class="n">err</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="c">// ...</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    You can instead “boost” the signal of the conditional by adding a comment:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">doSomething</span><span class="p">();</span> <span class="n">err</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span> <span class="c">// if NO error</span>
    <span class="c">// ...</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    The comment draws attention to the difference in the conditional.
   </p>
   <p>
    <a id="vardecls">
    </a>
   </p>
   <h2 id="variable-declarations">
    Variable declarations
   </h2>
   <p>
    <a id="vardeclinitialization">
    </a>
   </p>
   <h3 id="initialization">
    Initialization
   </h3>
   <p>
    For consistency, prefer
    <code class="language-plaintext highlighter-rouge">
     :=
    </code>
    over
    <code class="language-plaintext highlighter-rouge">
     var
    </code>
    when initializing a new variable with a
            non-zero value.
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="n">i</span> <span class="o">:=</span> <span class="m">42</span>
</code></pre>
    </div>
   </div>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Bad:</span>
<span class="k">var</span> <span class="n">i</span> <span class="o">=</span> <span class="m">42</span>
</code></pre>
    </div>
   </div>
   <p>
    <a id="vardeclzero">
    </a>
   </p>
   <h3 id="non-pointer-zero-values">
    Non-pointer zero values
   </h3>
   <p>
    The following declarations use the
    <a href="https://golang.org/ref/spec#The_zero_value">
     zero value
    </a>
    :
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">var</span> <span class="p">(</span>
    <span class="n">coords</span> <span class="n">Point</span>
    <span class="n">magic</span>  <span class="p">[</span><span class="m">4</span><span class="p">]</span><span class="kt">byte</span>
    <span class="n">primes</span> <span class="p">[]</span><span class="kt">int</span>
<span class="p">)</span>
</code></pre>
    </div>
   </div>
   <p>
    You should declare values using the zero value when you want to convey an empty
            value that
    <strong>
     is ready for later use
    </strong>
    . Using composite literals with explicit
            initialization can be clunky:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Bad:</span>
<span class="k">var</span> <span class="p">(</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">Point</span><span class="p">{</span><span class="n">X</span><span class="o">:</span> <span class="m">0</span><span class="p">,</span> <span class="n">Y</span><span class="o">:</span> <span class="m">0</span><span class="p">}</span>
    <span class="n">magic</span>  <span class="o">=</span> <span class="p">[</span><span class="m">4</span><span class="p">]</span><span class="kt">byte</span><span class="p">{</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">}</span>
    <span class="n">primes</span> <span class="o">=</span> <span class="p">[]</span><span class="kt">int</span><span class="p">(</span><span class="no">nil</span><span class="p">)</span>
<span class="p">)</span>
</code></pre>
    </div>
   </div>
   <p>
    A common application of zero value declaration is when using a variable as the
            output when unmarshalling:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">var</span> <span class="n">coords</span> <span class="n">Point</span>
<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">json</span><span class="o">.</span><span class="n">Unmarshal</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">coords</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
</code></pre>
    </div>
   </div>
   <p>
    If you need a lock or other field that
    <a href="decisions#copying">
     must not be copied
    </a>
    in your struct, you can make it a value type to take advantage of zero value
            initialization. It does mean that the containing type must now be passed via a
            pointer and not a value. Methods on the type must take pointer receivers.
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">type</span> <span class="n">Counter</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="c">// This field does not have to be "*sync.Mutex". However,</span>
    <span class="c">// users must now pass *Counter objects between themselves, not Counter.</span>
    <span class="n">mu</span>   <span class="n">sync</span><span class="o">.</span><span class="n">Mutex</span>
    <span class="n">data</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int64</span>
<span class="p">}</span>

<span class="c">// Note this must be a pointer receiver to prevent copying.</span>
<span class="k">func</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">Counter</span><span class="p">)</span> <span class="n">IncrementBy</span><span class="p">(</span><span class="n">name</span> <span class="kt">string</span><span class="p">,</span> <span class="n">n</span> <span class="kt">int64</span><span class="p">)</span>
</code></pre>
    </div>
   </div>
   <p>
    It’s acceptable to use value types for local variables of composites (such as
            structs and arrays) even if they contain such uncopyable fields. However, if the
            composite is returned by the function, or if all accesses to it end up needing
            to take an address anyway, prefer declaring the variable as a pointer type at
            the outset. Similarly, protobufs should be declared as pointer types.
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">func</span> <span class="n">NewCounter</span><span class="p">(</span><span class="n">name</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="n">Counter</span> <span class="p">{</span>
    <span class="n">c</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="n">Counter</span><span class="p">)</span> <span class="c">// "&amp;Counter{}" is also fine.</span>
    <span class="n">registerCounter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">c</span>
<span class="p">}</span>

<span class="k">var</span> <span class="n">myMsg</span> <span class="o">=</span> <span class="nb">new</span><span class="p">(</span><span class="n">pb</span><span class="o">.</span><span class="n">Bar</span><span class="p">)</span> <span class="c">// or "&amp;pb.Bar{}".</span>
</code></pre>
    </div>
   </div>
   <p>
    This is because
    <code class="language-plaintext highlighter-rouge">
     *pb.Something
    </code>
    satisfies
    <a href="https://pkg.go.dev/google.golang.org/protobuf/proto#Message">
     <code class="language-plaintext highlighter-rouge">
      proto.Message
     </code>
    </a>
    while
    <code class="language-plaintext highlighter-rouge">
     pb.Something
    </code>
    does not.
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Bad:</span>
<span class="k">func</span> <span class="n">NewCounter</span><span class="p">(</span><span class="n">name</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="n">Counter</span> <span class="p">{</span>
    <span class="k">var</span> <span class="n">c</span> <span class="n">Counter</span>
    <span class="n">registerCounter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="n">c</span>
<span class="p">}</span>

<span class="k">var</span> <span class="n">myMsg</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">Bar</span><span class="p">{}</span>
</code></pre>
    </div>
   </div>
   <blockquote>
    <p>
     <strong>
      Important:
     </strong>
     Map types must be explicitly initialized before they can be
                modified. However, reading from zero-value maps is perfectly fine.
    </p>
    <p>
     For map and slice types, if the code is particularly performance sensitive and
                if you know the sizes in advance, see the
     <a href="#vardeclsize">
      size hints
     </a>
     section.
    </p>
   </blockquote>
   <p>
    <a id="vardeclcomposite">
    </a>
   </p>
   <h3 id="composite-literals">
    Composite literals
   </h3>
   <p>
    The following are
    <a href="https://golang.org/ref/spec#Composite_literals">
     composite literal
    </a>
    declarations:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">var</span> <span class="p">(</span>
    <span class="n">coords</span>   <span class="o">=</span> <span class="n">Point</span><span class="p">{</span><span class="n">X</span><span class="o">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">Y</span><span class="o">:</span> <span class="n">y</span><span class="p">}</span>
    <span class="n">magic</span>    <span class="o">=</span> <span class="p">[</span><span class="m">4</span><span class="p">]</span><span class="kt">byte</span><span class="p">{</span><span class="sc">'I'</span><span class="p">,</span> <span class="sc">'W'</span><span class="p">,</span> <span class="sc">'A'</span><span class="p">,</span> <span class="sc">'D'</span><span class="p">}</span>
    <span class="n">primes</span>   <span class="o">=</span> <span class="p">[]</span><span class="kt">int</span><span class="p">{</span><span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">5</span><span class="p">,</span> <span class="m">7</span><span class="p">,</span> <span class="m">11</span><span class="p">}</span>
    <span class="n">captains</span> <span class="o">=</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span><span class="s">"Kirk"</span><span class="o">:</span> <span class="s">"James Tiberius"</span><span class="p">,</span> <span class="s">"Picard"</span><span class="o">:</span> <span class="s">"Jean-Luc"</span><span class="p">}</span>
<span class="p">)</span>
</code></pre>
    </div>
   </div>
   <p>
    You should declare a value using a composite literal when you know initial
            elements or members.
   </p>
   <p>
    In contrast, using composite literals to declare empty or memberless values can
            be visually noisy compared to
    <a href="#vardeclzero">
     zero-value initialization
    </a>
    .
   </p>
   <p>
    When you need a pointer to a zero value, you have two options: empty composite
            literals and
    <code class="language-plaintext highlighter-rouge">
     new
    </code>
    . Both are fine, but the
    <code class="language-plaintext highlighter-rouge">
     new
    </code>
    keyword can serve to remind the
            reader that if a non-zero value were needed, a composite literal wouldn’t work:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">var</span> <span class="p">(</span>
  <span class="n">buf</span> <span class="o">=</span> <span class="nb">new</span><span class="p">(</span><span class="n">bytes</span><span class="o">.</span><span class="n">Buffer</span><span class="p">)</span> <span class="c">// non-empty Buffers are initialized with constructors.</span>
  <span class="n">msg</span> <span class="o">=</span> <span class="nb">new</span><span class="p">(</span><span class="n">pb</span><span class="o">.</span><span class="n">Message</span><span class="p">)</span> <span class="c">// non-empty proto messages are initialized with builders or by setting fields one by one.</span>
<span class="p">)</span>
</code></pre>
    </div>
   </div>
   <p>
    <a id="vardeclsize">
    </a>
   </p>
   <h3 id="size-hints">
    Size hints
   </h3>
   <p>
    The following are declarations that take advantage of size hints in order to
            preallocate capacity:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">var</span> <span class="p">(</span>
    <span class="c">// Preferred buffer size for target filesystem: st_blksize.</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="m">131072</span><span class="p">)</span>
    <span class="c">// Typically process up to 8-10 elements per run (16 is a safe assumption).</span>
    <span class="n">q</span> <span class="o">=</span> <span class="nb">make</span><span class="p">([]</span><span class="n">Node</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">16</span><span class="p">)</span>
    <span class="c">// Each shard processes shardSize (typically 32000+) elements.</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="nb">make</span><span class="p">(</span><span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">bool</span><span class="p">,</span> <span class="n">shardSize</span><span class="p">)</span>
<span class="p">)</span>
</code></pre>
    </div>
   </div>
   <p>
    Size hints and preallocation are important steps
    <strong>
     when combined with empirical
                analysis of the code and its integrations
    </strong>
    , to create performance-sensitive and
            resource-efficient code.
   </p>
   <p>
    Most code does not need a size hint or preallocation, and can allow the runtime
            to grow the slice or map as necessary. It is acceptable to preallocate when the
            final size is known (e.g. when converting between a map and a slice) but this is
            not a readability requirement, and may not be worth the clutter in small cases.
   </p>
   <p>
    <strong>
     Warning:
    </strong>
    Preallocating more memory than you need can waste memory in the
            fleet or even harm performance. When in doubt, see
    <a href="https://google.github.io/styleguide/go/index.html#gotip">
     GoTip #3: Benchmarking Go Code
    </a>
    and default to a
    <a href="#vardeclzero">
     zero initialization
    </a>
    or a
    <a href="#vardeclcomposite">
     composite literal declaration
    </a>
    .
   </p>
   <p>
    <a id="decl-chan">
    </a>
   </p>
   <h3 id="channel-direction">
    Channel direction
   </h3>
   <p>
    Specify
    <a href="https://go.dev/ref/spec#Channel_types">
     channel direction
    </a>
    where possible.
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="c">// sum computes the sum of all of the values. It reads from the channel until</span>
<span class="c">// the channel is closed.</span>
<span class="k">func</span> <span class="n">sum</span><span class="p">(</span><span class="n">values</span> <span class="o">&lt;-</span><span class="k">chan</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
    <span class="c">// ...</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    This prevents casual programming errors that are possible without specification:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Bad:</span>
<span class="k">func</span> <span class="n">sum</span><span class="p">(</span><span class="n">values</span> <span class="k">chan</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">out</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="n">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">values</span> <span class="p">{</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span>
    <span class="p">}</span>
    <span class="c">// values must already be closed for this code to be reachable, which means</span>
    <span class="c">// a second close triggers a panic.</span>
    <span class="nb">close</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    When the direction is specified, the compiler catches simple errors like this.
            It also helps to convey a measure of ownership to the type.
   </p>
   <p>
    See also Bryan Mills’ talk “Rethinking Classical Concurrency Patterns”:
    <a href="https://drive.google.com/file/d/1nPdvhB0PutEJzdCq5ms6UI58dp50fcAN/view?usp=sharing">
     slides
    </a>
    <a href="https://www.youtube.com/watch?v=5zXAHh5tJqQ">
     video
    </a>
    .
   </p>
   <p>
    <a id="funcargs">
    </a>
   </p>
   <h2 id="function-argument-lists">
    Function argument lists
   </h2>
   <p>
    Don’t let the signature of a function get too long. As more parameters are added
            to a function, the role of individual parameters becomes less clear, and
            adjacent parameters of the same type become easier to confuse. Functions with
            large numbers of arguments are less memorable and more difficult to read at the
            call-site.
   </p>
   <p>
    When designing an API, consider splitting a highly configurable function whose
            signature is growing complex into several simpler ones. These can share an
            (unexported) implementation if necessary.
   </p>
   <p>
    Where a function requires many inputs, consider introducing an
    <a href="#option-structure">
     option struct
    </a>
    for some of the arguments or employing the more advanced
    <a href="#variadic-options">
     variadic options
    </a>
    technique. The primary consideration for which strategy to choose should be how
            the function call looks across all expected use cases.
   </p>
   <p>
    The recommendations below primarily apply to exported APIs, which are held to a
            higher standard than unexported ones. These techniques may be unnecessary for
            your use case. Use your judgment, and balance the principles of
    <a href="guide#clarity">
     clarity
    </a>
    and
    <a href="guide#least-mechanism">
     least mechanism
    </a>
    .
   </p>
   <p>
    See also:
    <a href="https://google.github.io/styleguide/go/index.html#gotip">
     Go Tip #24: Use Case-Specific Constructions
    </a>
   </p>
   <p>
    <a id="option-structure">
    </a>
   </p>
   <h3 id="option-structure">
    Option structure
   </h3>
   <p>
    An option structure is a struct type that collects some or all of the arguments
            of a function or method, that is then passed as the last argument to the
            function or method. (The struct should be exported only if it is used in an
            exported function.)
   </p>
   <p>
    Using an option structure has a number of benefits:
   </p>
   <ul>
    <li>
     The struct literal includes both fields and values for each argument, which
                makes them self-documenting and harder to swap.
    </li>
    <li>
     Irrelevant or “default” fields can be omitted.
    </li>
    <li>
     Callers can share the options struct and write helpers to operate on it.
    </li>
    <li>
     Structs provide cleaner per-field documentation than function arguments.
    </li>
    <li>
     Option structs can grow over time without impacting call-sites.
    </li>
   </ul>
   <p>
    Here is an example of a function that could be improved:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Bad:</span>
<span class="k">func</span> <span class="n">EnableReplication</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">config</span> <span class="o">*</span><span class="n">replicator</span><span class="o">.</span><span class="n">Config</span><span class="p">,</span> <span class="n">primaryRegions</span><span class="p">,</span> <span class="n">readonlyRegions</span> <span class="p">[]</span><span class="kt">string</span><span class="p">,</span> <span class="n">replicateExisting</span><span class="p">,</span> <span class="n">overwritePolicies</span> <span class="kt">bool</span><span class="p">,</span> <span class="n">replicationInterval</span> <span class="n">time</span><span class="o">.</span><span class="n">Duration</span><span class="p">,</span> <span class="n">copyWorkers</span> <span class="kt">int</span><span class="p">,</span> <span class="n">healthWatcher</span> <span class="n">health</span><span class="o">.</span><span class="n">Watcher</span><span class="p">)</span> <span class="p">{</span>
    <span class="c">// ...</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    The function above could be rewritten with an option structure as follows:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">type</span> <span class="n">ReplicationOptions</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">Config</span>              <span class="o">*</span><span class="n">replicator</span><span class="o">.</span><span class="n">Config</span>
    <span class="n">PrimaryRegions</span>      <span class="p">[]</span><span class="kt">string</span>
    <span class="n">ReadonlyRegions</span>     <span class="p">[]</span><span class="kt">string</span>
    <span class="n">ReplicateExisting</span>   <span class="kt">bool</span>
    <span class="n">OverwritePolicies</span>   <span class="kt">bool</span>
    <span class="n">ReplicationInterval</span> <span class="n">time</span><span class="o">.</span><span class="n">Duration</span>
    <span class="n">CopyWorkers</span>         <span class="kt">int</span>
    <span class="n">HealthWatcher</span>       <span class="n">health</span><span class="o">.</span><span class="n">Watcher</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">EnableReplication</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">opts</span> <span class="n">ReplicationOptions</span><span class="p">)</span> <span class="p">{</span>
    <span class="c">// ...</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    The function can then be called in a different package:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">func</span> <span class="n">foo</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="p">{</span>
    <span class="c">// Complex call:</span>
    <span class="n">storage</span><span class="o">.</span><span class="n">EnableReplication</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">storage</span><span class="o">.</span><span class="n">ReplicationOptions</span><span class="p">{</span>
        <span class="n">Config</span><span class="o">:</span>              <span class="n">config</span><span class="p">,</span>
        <span class="n">PrimaryRegions</span><span class="o">:</span>      <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"us-east1"</span><span class="p">,</span> <span class="s">"us-central2"</span><span class="p">,</span> <span class="s">"us-west3"</span><span class="p">},</span>
        <span class="n">ReadonlyRegions</span><span class="o">:</span>     <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"us-east5"</span><span class="p">,</span> <span class="s">"us-central6"</span><span class="p">},</span>
        <span class="n">OverwritePolicies</span><span class="o">:</span>   <span class="no">true</span><span class="p">,</span>
        <span class="n">ReplicationInterval</span><span class="o">:</span> <span class="m">1</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Hour</span><span class="p">,</span>
        <span class="n">CopyWorkers</span><span class="o">:</span>         <span class="m">100</span><span class="p">,</span>
        <span class="n">HealthWatcher</span><span class="o">:</span>       <span class="n">watcher</span><span class="p">,</span>
    <span class="p">})</span>

    <span class="c">// Simple call:</span>
    <span class="n">storage</span><span class="o">.</span><span class="n">EnableReplication</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">storage</span><span class="o">.</span><span class="n">ReplicationOptions</span><span class="p">{</span>
        <span class="n">Config</span><span class="o">:</span>         <span class="n">config</span><span class="p">,</span>
        <span class="n">PrimaryRegions</span><span class="o">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"us-east1"</span><span class="p">,</span> <span class="s">"us-central2"</span><span class="p">,</span> <span class="s">"us-west3"</span><span class="p">},</span>
    <span class="p">})</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    <strong>
     Note:
    </strong>
    <a href="decisions#contexts">
     Contexts are never included in option structs
    </a>
    .
   </p>
   <p>
    This option is often preferred when some of the following apply:
   </p>
   <ul>
    <li>
     All callers need to specify one or more of the options.
    </li>
    <li>
     A large number of callers need to provide many options.
    </li>
    <li>
     The options are shared between multiple functions that the user will call.
    </li>
   </ul>
   <p>
    <a id="variadic-options">
    </a>
   </p>
   <h3 id="variadic-options">
    Variadic options
   </h3>
   <p>
    Using variadic options, exported functions are created which return closures
            that can be passed to the
    <a href="https://golang.org/ref/spec#Passing_arguments_to_..._parameters">
     variadic (
     <code class="language-plaintext highlighter-rouge">
      ...
     </code>
     ) parameter
    </a>
    of a function. The
            function takes as its parameters the values of the option (if any), and the
            returned closure accepts a mutable reference (usually a pointer to a struct
            type) that will be updated based on the inputs.
   </p>
   <p>
    Using variadic options can provide a number of benefits:
   </p>
   <ul>
    <li>
     Options take no space at a call-site when no configuration is needed.
    </li>
    <li>
     Options are still values, so callers can share them, write helpers, and
                accumulate them.
    </li>
    <li>
     Options can accept multiple parameters (e.g.
     <code class="language-plaintext highlighter-rouge">
      cartesian.Translate(dx, dy
int) TransformOption
     </code>
     ).
    </li>
    <li>
     The option functions can return a named type to group options together in
                godoc.
    </li>
    <li>
     Packages can allow (or prevent) third-party packages to define (or from
                defining) their own options.
    </li>
   </ul>
   <p>
    <strong>
     Note:
    </strong>
    Using variadic options requires a substantial amount of additional
            code (see the following example), so it should only be used when the advantages
            outweigh the overhead.
   </p>
   <p>
    Here is an example of a function that could be improved:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Bad:</span>
<span class="k">func</span> <span class="n">EnableReplication</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">config</span> <span class="o">*</span><span class="n">placer</span><span class="o">.</span><span class="n">Config</span><span class="p">,</span> <span class="n">primaryCells</span><span class="p">,</span> <span class="n">readonlyCells</span> <span class="p">[]</span><span class="kt">string</span><span class="p">,</span> <span class="n">replicateExisting</span><span class="p">,</span> <span class="n">overwritePolicies</span> <span class="kt">bool</span><span class="p">,</span> <span class="n">replicationInterval</span> <span class="n">time</span><span class="o">.</span><span class="n">Duration</span><span class="p">,</span> <span class="n">copyWorkers</span> <span class="kt">int</span><span class="p">,</span> <span class="n">healthWatcher</span> <span class="n">health</span><span class="o">.</span><span class="n">Watcher</span><span class="p">)</span> <span class="p">{</span>
  <span class="o">...</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    The example above could be rewritten with variadic options as follows:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">type</span> <span class="n">replicationOptions</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">readonlyCells</span>       <span class="p">[]</span><span class="kt">string</span>
    <span class="n">replicateExisting</span>   <span class="kt">bool</span>
    <span class="n">overwritePolicies</span>   <span class="kt">bool</span>
    <span class="n">replicationInterval</span> <span class="n">time</span><span class="o">.</span><span class="n">Duration</span>
    <span class="n">copyWorkers</span>         <span class="kt">int</span>
    <span class="n">healthWatcher</span>       <span class="n">health</span><span class="o">.</span><span class="n">Watcher</span>
<span class="p">}</span>

<span class="c">// A ReplicationOption configures EnableReplication.</span>
<span class="k">type</span> <span class="n">ReplicationOption</span> <span class="k">func</span><span class="p">(</span><span class="o">*</span><span class="n">replicationOptions</span><span class="p">)</span>

<span class="c">// ReadonlyCells adds additional cells that should additionally</span>
<span class="c">// contain read-only replicas of the data.</span>
<span class="c">//</span>
<span class="c">// Passing this option multiple times will add additional</span>
<span class="c">// read-only cells.</span>
<span class="c">//</span>
<span class="c">// Default: none</span>
<span class="k">func</span> <span class="n">ReadonlyCells</span><span class="p">(</span><span class="n">cells</span> <span class="o">...</span><span class="kt">string</span><span class="p">)</span> <span class="n">ReplicationOption</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">func</span><span class="p">(</span><span class="n">opts</span> <span class="o">*</span><span class="n">replicationOptions</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">readonlyCells</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">readonlyCells</span><span class="p">,</span> <span class="n">cells</span><span class="o">...</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c">// ReplicateExisting controls whether files that already exist in the</span>
<span class="c">// primary cells will be replicated.  Otherwise, only newly-added</span>
<span class="c">// files will be candidates for replication.</span>
<span class="c">//</span>
<span class="c">// Passing this option again will overwrite earlier values.</span>
<span class="c">//</span>
<span class="c">// Default: false</span>
<span class="k">func</span> <span class="n">ReplicateExisting</span><span class="p">(</span><span class="n">enabled</span> <span class="kt">bool</span><span class="p">)</span> <span class="n">ReplicationOption</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">func</span><span class="p">(</span><span class="n">opts</span> <span class="o">*</span><span class="n">replicationOptions</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">replicateExisting</span> <span class="o">=</span> <span class="n">enabled</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c">// ... other options ...</span>

<span class="c">// DefaultReplicationOptions control the default values before</span>
<span class="c">// applying options passed to EnableReplication.</span>
<span class="k">var</span> <span class="n">DefaultReplicationOptions</span> <span class="o">=</span> <span class="p">[]</span><span class="n">ReplicationOption</span><span class="p">{</span>
    <span class="n">OverwritePolicies</span><span class="p">(</span><span class="no">true</span><span class="p">),</span>
    <span class="n">ReplicationInterval</span><span class="p">(</span><span class="m">12</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Hour</span><span class="p">),</span>
    <span class="n">CopyWorkers</span><span class="p">(</span><span class="m">10</span><span class="p">),</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">EnableReplication</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">config</span> <span class="o">*</span><span class="n">placer</span><span class="o">.</span><span class="n">Config</span><span class="p">,</span> <span class="n">primaryCells</span> <span class="p">[]</span><span class="kt">string</span><span class="p">,</span> <span class="n">opts</span> <span class="o">...</span><span class="n">ReplicationOption</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">var</span> <span class="n">options</span> <span class="n">replicationOptions</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">opt</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">DefaultReplicationOptions</span> <span class="p">{</span>
        <span class="n">opt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">opt</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">opts</span> <span class="p">{</span>
        <span class="n">opt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    The function can then be called in a different package:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">func</span> <span class="n">foo</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="p">{</span>
    <span class="c">// Complex call:</span>
    <span class="n">storage</span><span class="o">.</span><span class="n">EnableReplication</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"po"</span><span class="p">,</span> <span class="s">"is"</span><span class="p">,</span> <span class="s">"ea"</span><span class="p">},</span>
        <span class="n">storage</span><span class="o">.</span><span class="n">ReadonlyCells</span><span class="p">(</span><span class="s">"ix"</span><span class="p">,</span> <span class="s">"gg"</span><span class="p">),</span>
        <span class="n">storage</span><span class="o">.</span><span class="n">OverwritePolicies</span><span class="p">(</span><span class="no">true</span><span class="p">),</span>
        <span class="n">storage</span><span class="o">.</span><span class="n">ReplicationInterval</span><span class="p">(</span><span class="m">1</span><span class="o">*</span><span class="n">time</span><span class="o">.</span><span class="n">Hour</span><span class="p">),</span>
        <span class="n">storage</span><span class="o">.</span><span class="n">CopyWorkers</span><span class="p">(</span><span class="m">100</span><span class="p">),</span>
        <span class="n">storage</span><span class="o">.</span><span class="n">HealthWatcher</span><span class="p">(</span><span class="n">watcher</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c">// Simple call:</span>
    <span class="n">storage</span><span class="o">.</span><span class="n">EnableReplication</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"po"</span><span class="p">,</span> <span class="s">"is"</span><span class="p">,</span> <span class="s">"ea"</span><span class="p">})</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    Prefer this option when many of the following apply:
   </p>
   <ul>
    <li>
     Most callers will not need to specify any options.
    </li>
    <li>
     Most options are used infrequently.
    </li>
    <li>
     There are a large number of options.
    </li>
    <li>
     Options require arguments.
    </li>
    <li>
     Options could fail or be set incorrectly (in which case the option function
                returns an
     <code class="language-plaintext highlighter-rouge">
      error
     </code>
     ).
    </li>
    <li>
     Options require a lot of documentation that can be hard to fit in a struct.
    </li>
    <li>
     Users or other packages can provide custom options.
    </li>
   </ul>
   <p>
    Options in this style should accept parameters rather than using presence to
            signal their value; the latter can make dynamic composition of arguments much
            more difficult. For example, binary settings should accept a boolean (e.g.
    <code class="language-plaintext highlighter-rouge">
     rpc.FailFast(enable bool)
    </code>
    is preferable to
    <code class="language-plaintext highlighter-rouge">
     rpc.EnableFailFast()
    </code>
    ). An
            enumerated option should accept an enumerated constant (e.g.
    <code class="language-plaintext highlighter-rouge">
     log.Format(log.Capacitor)
    </code>
    is preferable to
    <code class="language-plaintext highlighter-rouge">
     log.CapacitorFormat()
    </code>
    ). The
            alternative makes it much more difficult for users who must programmatically
            choose which options to pass; such users are forced to change the actual
            composition of the parameters rather than simply changing the arguments to the
            options. Don’t assume that all users will know the full set of options
            statically.
   </p>
   <p>
    In general, options should be processed in order. If there is a conflict or if a
            non-cumulative option is passed multiple times, the last argument should win.
   </p>
   <p>
    The parameter to the option function is generally unexported in this pattern, to
            restrict the options to being defined only within the package itself. This is a
            good default, though there may be times when it is appropriate to allow other
            packages to define options.
   </p>
   <p>
    See
    <a href="http://commandcenter.blogspot.com/2014/01/self-referential-functions-and-design.html">
     Rob Pike’s original blog post
    </a>
    and
    <a href="https://dave.cheney.net/2014/10/17/functional-options-for-friendly-apis">
     Dave Cheney’s talk
    </a>
    for a more in-depth
            look at how these options can be used.
   </p>
   <p>
    <a id="complex-clis">
    </a>
   </p>
   <h2 id="complex-command-line-interfaces">
    Complex command-line interfaces
   </h2>
   <p>
    Some programs wish to present users with a rich command-line interface that
            includes sub-commands. For example,
    <code class="language-plaintext highlighter-rouge">
     kubectl create
    </code>
    ,
    <code class="language-plaintext highlighter-rouge">
     kubectl run
    </code>
    , and many
            other sub-commands are all provided by the program
    <code class="language-plaintext highlighter-rouge">
     kubectl
    </code>
    . There are at least
            the following libraries in common use for achieving this.
   </p>
   <p>
    If you don’t have a preference or other considerations are equal,
    <a href="https://pkg.go.dev/github.com/google/subcommands">
     subcommands
    </a>
    is recommended, since it is the simplest and is easy to use correctly. However,
            if you need different features that it doesn’t provide, pick one of the other
            options.
   </p>
   <ul>
    <li>
     <p>
      <strong>
       <a href="https://pkg.go.dev/github.com/spf13/cobra">
        cobra
       </a>
      </strong>
     </p>
     <ul>
      <li>
       Flag convention: getopt
      </li>
      <li>
       Common outside the Google codebase.
      </li>
      <li>
       Many extra features.
      </li>
      <li>
       Pitfalls in usage (see below).
      </li>
     </ul>
    </li>
    <li>
     <p>
      <strong>
       <a href="https://pkg.go.dev/github.com/google/subcommands">
        subcommands
       </a>
      </strong>
     </p>
     <ul>
      <li>
       Flag convention: Go
      </li>
      <li>
       Simple and easy to use correctly.
      </li>
      <li>
       Recommended if you don’t need extra features.
      </li>
     </ul>
    </li>
   </ul>
   <p>
    <strong>
     Warning
    </strong>
    : cobra command functions should use
    <code class="language-plaintext highlighter-rouge">
     cmd.Context()
    </code>
    to obtain a
            context rather than creating their own root context with
    <code class="language-plaintext highlighter-rouge">
     context.Background
    </code>
    .
            Code that uses the subcommands package already receives the correct context as a
            function parameter.
   </p>
   <p>
    You are not required to place each subcommand in a separate package, and it is
            often not necessary to do so. Apply the same considerations about package
            boundaries as in any Go codebase. If your code can be used both as a library and
            as a binary, it is usually beneficial to separate the CLI code and the library,
            making the CLI just one more of its clients. (This is not specific to CLIs that
            have subcommands, but is mentioned here because it is a common place where it
            comes up.)
   </p>
   <p>
    <a id="tests">
    </a>
   </p>
   <h2 id="tests">
    Tests
   </h2>
   <p>
    <a id="test-functions">
    </a>
   </p>
   <h3 id="leave-testing-to-the-test-function">
    Leave testing to the
    <code class="language-plaintext highlighter-rouge">
     Test
    </code>
    function
   </h3>
   <!-- Note to maintainers: This section overlaps with decisions#assert and
decisions#mark-test-helpers. The point is not to repeat information, but
to have one place that summarizes the distinction that newcomers to the
language often wonder about. -->
   <p>
    Go distinguishes between “test helpers” and “assertion helpers”:
   </p>
   <ul>
    <li>
     <p>
      <strong>
       Test helpers
      </strong>
      are functions that do setup or cleanup tasks. All failures
                    that occur in test helpers are expected to be failures of the environment
                    (not from the code under test) — for example when a test database cannot be
                    started because there are no more free ports on this machine. For functions
                    like these, calling
      <code class="language-plaintext highlighter-rouge">
       t.Helper
      </code>
      is often appropriate to
      <a href="decisions#mark-test-helpers">
       mark them as a test helper
      </a>
      . See
      <a href="#test-helper-error-handling">
       error handling in test helpers
      </a>
      for more
                    details.
     </p>
    </li>
    <li>
     <p>
      <strong>
       Assertion helpers
      </strong>
      are functions that check the correctness of a system
                    and fail the test if an expectation is not met. Assertion helpers are
      <a href="decisions#assert">
       not considered idiomatic
      </a>
      in Go.
     </p>
    </li>
   </ul>
   <p>
    The purpose of a test is to report pass/fail conditions of the code under test.
            The ideal place to fail a test is within the
    <code class="language-plaintext highlighter-rouge">
     Test
    </code>
    function itself, as that
            ensures that
    <a href="decisions#useful-test-failures">
     failure messages
    </a>
    and the test logic are clear.
   </p>
   <p>
    As your testing code grows, it may become necessary to factor out some
            functionality to separate functions. Standard software engineering
            considerations still apply, as
    <em>
     test code is still code
    </em>
    . If the functionality
            does not interact with the testing framework, then all of the usual rules apply.
            When the common code interacts with the framework, however, some care must be
            taken to avoid common pitfalls that can lead to uninformative failure messages
            and unmaintainable tests.
   </p>
   <p>
    If many separate test cases require the same validation logic, arrange the test
            in one of the following ways instead of using assertion helpers or complex
            validation functions:
   </p>
   <ul>
    <li>
     Inline the logic (both the validation and the failure) in the
     <code class="language-plaintext highlighter-rouge">
      Test
     </code>
     function, even if it is repetitive. This works best in simple cases.
    </li>
    <li>
     If inputs are similar, consider unifying them into a
     <a href="decisions#table-driven-tests">
      table-driven test
     </a>
     while keeping the logic inlined in the loop. This helps to avoid repetition
                while keeping the validation and failure in the
     <code class="language-plaintext highlighter-rouge">
      Test
     </code>
     .
    </li>
    <li>
     If there are multiple callers who need the same validation function but
                table tests are not suitable (typically because the inputs are not simple
                enough or the validation is required as part of a sequence of operations),
                arrange the validation function so that it returns a value (typically an
     <code class="language-plaintext highlighter-rouge">
      error
     </code>
     ) rather than taking a
     <code class="language-plaintext highlighter-rouge">
      testing.T
     </code>
     parameter and using it to fail the
                test. Use logic within the
     <code class="language-plaintext highlighter-rouge">
      Test
     </code>
     to decide whether to fail, and to provide
     <a href="decisions#useful-test-failures">
      useful test failures
     </a>
     . You can also create test helpers to factor out
                common boilerplate setup code.
    </li>
   </ul>
   <p>
    The design outlined in the last point maintains orthogonality. For example,
    <a href="https://pkg.go.dev/github.com/google/go-cmp/cmp">
     package
     <code class="language-plaintext highlighter-rouge">
      cmp
     </code>
    </a>
    is not designed to fail tests, but rather to compare (and to
            diff) values. It therefore does not need to know about the context in which the
            comparison was made, since the caller can supply that. If your common testing
            code provides a
    <code class="language-plaintext highlighter-rouge">
     cmp.Transformer
    </code>
    for your data type, that can often be the
            simplest design. For other validations, consider returning an
    <code class="language-plaintext highlighter-rouge">
     error
    </code>
    value.
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="c">// polygonCmp returns a cmp.Option that equates s2 geometry objects up to</span>
<span class="c">// some small floating-point error.</span>
<span class="k">func</span> <span class="n">polygonCmp</span><span class="p">()</span> <span class="n">cmp</span><span class="o">.</span><span class="n">Option</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">cmp</span><span class="o">.</span><span class="n">Options</span><span class="p">{</span>
        <span class="n">cmp</span><span class="o">.</span><span class="n">Transformer</span><span class="p">(</span><span class="s">"polygon"</span><span class="p">,</span> <span class="k">func</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">s2</span><span class="o">.</span><span class="n">Polygon</span><span class="p">)</span> <span class="p">[]</span><span class="o">*</span><span class="n">s2</span><span class="o">.</span><span class="n">Loop</span> <span class="p">{</span> <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">Loops</span><span class="p">()</span> <span class="p">}),</span>
        <span class="n">cmp</span><span class="o">.</span><span class="n">Transformer</span><span class="p">(</span><span class="s">"loop"</span><span class="p">,</span> <span class="k">func</span><span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">s2</span><span class="o">.</span><span class="n">Loop</span><span class="p">)</span> <span class="p">[]</span><span class="n">s2</span><span class="o">.</span><span class="n">Point</span> <span class="p">{</span> <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">Vertices</span><span class="p">()</span> <span class="p">}),</span>
        <span class="n">cmpopts</span><span class="o">.</span><span class="n">EquateApprox</span><span class="p">(</span><span class="m">0.00000001</span><span class="p">,</span> <span class="m">0</span><span class="p">),</span>
        <span class="n">cmpopts</span><span class="o">.</span><span class="n">EquateEmpty</span><span class="p">(),</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestFenceposts</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="c">// This is a test for a fictional function, Fenceposts, which draws a fence</span>
    <span class="c">// around some Place object. The details are not important, except that</span>
    <span class="c">// the result is some object that has s2 geometry (github.com/golang/geo/s2)</span>
    <span class="n">got</span> <span class="o">:=</span> <span class="n">Fencepost</span><span class="p">(</span><span class="n">tomsDiner</span><span class="p">,</span> <span class="m">1</span><span class="o">*</span><span class="n">meter</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">diff</span> <span class="o">:=</span> <span class="n">cmp</span><span class="o">.</span><span class="n">Diff</span><span class="p">(</span><span class="n">want</span><span class="p">,</span> <span class="n">got</span><span class="p">,</span> <span class="n">polygonCmp</span><span class="p">());</span> <span class="n">diff</span> <span class="o">!=</span> <span class="s">""</span> <span class="p">{</span>
        <span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"Fencepost(tomsDiner, 1m) returned unexpected diff (-want+got):</span><span class="se">\n</span><span class="s">%v"</span><span class="p">,</span> <span class="n">diff</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">FuzzFencepost</span><span class="p">(</span><span class="n">f</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">F</span><span class="p">)</span> <span class="p">{</span>
    <span class="c">// Fuzz test (https://go.dev/doc/fuzz) for the same.</span>

    <span class="n">f</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">tomsDiner</span><span class="p">,</span> <span class="m">1</span><span class="o">*</span><span class="n">meter</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">school</span><span class="p">,</span> <span class="m">3</span><span class="o">*</span><span class="n">meter</span><span class="p">)</span>

    <span class="n">f</span><span class="o">.</span><span class="n">Fuzz</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">geo</span> <span class="n">Place</span><span class="p">,</span> <span class="n">padding</span> <span class="n">Length</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">got</span> <span class="o">:=</span> <span class="n">Fencepost</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="n">padding</span><span class="p">)</span>
        <span class="c">// Simple reference implementation: not used in prod, but easy to</span>
        <span class="c">// reason about and therefore useful to check against in random tests.</span>
        <span class="n">reference</span> <span class="o">:=</span> <span class="n">slowFencepost</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="n">padding</span><span class="p">)</span>

        <span class="c">// In the fuzz test, inputs and outputs can be large so don't</span>
        <span class="c">// bother with printing a diff. cmp.Equal is enough.</span>
        <span class="k">if</span> <span class="o">!</span><span class="n">cmp</span><span class="o">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">got</span><span class="p">,</span> <span class="n">reference</span><span class="p">,</span> <span class="n">polygonCmp</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"Fencepost returned wrong placement"</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">})</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    The
    <code class="language-plaintext highlighter-rouge">
     polygonCmp
    </code>
    function is agnostic about how it’s called; it doesn’t take a
            concrete input type nor does it police what to do in case two objects don’t
            match. Therefore, more callers can make use of it.
   </p>
   <p>
    <strong>
     Note:
    </strong>
    There is an analogy between test helpers and plain library code. Code
            in libraries should usually
    <a href="decisions#dont-panic">
     not panic
    </a>
    except in rare circumstances; code
            called from a test should not stop the test unless there is
    <a href="#t-fatal">
     no point in proceeding
    </a>
    .
   </p>
   <p>
    <a id="test-validation-apis">
    </a>
   </p>
   <h3 id="designing-extensible-validation-apis">
    Designing extensible validation APIs
   </h3>
   <p>
    Most of the advice about testing in the style guide is about testing your own
            code. This section is about how to provide facilities for other people to test
            the code they write to ensure that it conforms to your library’s requirements.
   </p>
   <p>
    <a id="test-validation-apis-what">
    </a>
   </p>
   <h4 id="acceptance-testing">
    Acceptance testing
   </h4>
   <p>
    Such testing is referred to as
    <a href="https://en.wikipedia.org/wiki/Acceptance_testing">
     acceptance testing
    </a>
    . The premise of this kind of
            testing is that the person using the test does not know every last detail of
            what goes on in the test; they just hand the inputs over to the testing facility
            to do the work. This can be thought of as a form of
    <a href="https://en.wikipedia.org/wiki/Inversion_of_control">
     inversion of control
    </a>
    .
   </p>
   <p>
    In a typical Go test, the test function controls the program flow, and the
    <a href="decisions#assert">
     no assert
    </a>
    and
    <a href="#test-functions">
     test functions
    </a>
    guidance
            encourages you to keep it that way. This section explains how to author support
            for these tests in a way that is consistent with Go style.
   </p>
   <p>
    Before diving into how, consider an example from
    <a href="https://pkg.go.dev/io/fs">
     <code class="language-plaintext highlighter-rouge">
      io/fs
     </code>
    </a>
    , excerpted below:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="k">type</span> <span class="n">FS</span> <span class="k">interface</span> <span class="p">{</span>
    <span class="n">Open</span><span class="p">(</span><span class="n">name</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">File</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    While there exist well-known implementations of
    <code class="language-plaintext highlighter-rouge">
     fs.FS
    </code>
    , a Go developer may be
            expected to author one. To help validate the user-implemented
    <code class="language-plaintext highlighter-rouge">
     fs.FS
    </code>
    is
            correct, a generic library has been provided in
    <a href="https://pkg.go.dev/testing/fstest">
     <code class="language-plaintext highlighter-rouge">
      testing/fstest
     </code>
    </a>
    called
    <a href="https://pkg.go.dev/testing/fstest#TestFS">
     <code class="language-plaintext highlighter-rouge">
      fstest.TestFS
     </code>
    </a>
    . This API treats the implementation as a blackbox to make sure
            it upholds the most basic parts of the
    <code class="language-plaintext highlighter-rouge">
     io/fs
    </code>
    contract.
   </p>
   <p>
    <a id="test-validation-apis-writing">
    </a>
   </p>
   <h4 id="writing-an-acceptance-test">
    Writing an acceptance test
   </h4>
   <p>
    Now that we know what an acceptance test is and why you might use one, let’s
            explore building an acceptance test for
    <code class="language-plaintext highlighter-rouge">
     package chess
    </code>
    , a package used to
            simulate chess games. Users of
    <code class="language-plaintext highlighter-rouge">
     chess
    </code>
    are expected to implement the
    <code class="language-plaintext highlighter-rouge">
     chess.Player
    </code>
    interface. These implementations are the primary thing we will
            validate. Our acceptance test concerns itself with whether the player
            implementation makes legal moves, not whether the moves are smart.
   </p>
   <ol>
    <li>
     <p>
      Create a new package for the validation behavior,
      <a href="#naming-doubles-helper-package">
       customarily named
      </a>
      by appending the word
      <code class="language-plaintext highlighter-rouge">
       test
      </code>
      to the package name (for example,
      <code class="language-plaintext highlighter-rouge">
       chesstest
      </code>
      ).
     </p>
    </li>
    <li>
     <p>
      Create the function that performs the validation by accepting the
                    implementation under test as an argument and exercises it:
     </p>
     <div class="language-go highlighter-rouge">
      <div class="highlight">
       <pre class="highlight"><code><span class="c">// ExercisePlayer tests a Player implementation in a single turn on a board.</span>
<span class="c">// The board itself is spot checked for sensibility and correctness.</span>
<span class="c">//</span>
<span class="c">// It returns a nil error if the player makes a correct move in the context</span>
<span class="c">// of the provided board. Otherwise ExercisePlayer returns one of this</span>
<span class="c">// package's errors to indicate how and why the player failed the</span>
<span class="c">// validation.</span>
<span class="k">func</span> <span class="n">ExercisePlayer</span><span class="p">(</span><span class="n">b</span> <span class="o">*</span><span class="n">chess</span><span class="o">.</span><span class="n">Board</span><span class="p">,</span> <span class="n">p</span> <span class="n">chess</span><span class="o">.</span><span class="n">Player</span><span class="p">)</span> <span class="kt">error</span>
</code></pre>
      </div>
     </div>
     <p>
      The test should note which invariants are broken and how. Your design can
                    choose between two disciplines for failure reporting:
     </p>
     <ul>
      <li>
       <p>
        <strong>
         Fail fast
        </strong>
        : return an error as soon as the implementation violates an
                            invariant.
       </p>
       <p>
        This is the simplest approach, and it works well if the acceptance test
                            is expected to execute quickly. Simple error
        <a href="https://google.github.io/styleguide/go/index.html#gotip">
         sentinels
        </a>
        and
        <a href="https://google.github.io/styleguide/go/index.html#gotip">
         custom types
        </a>
        can be used easily here, which conversely makes testing
                            the acceptance test easy.
       </p>
       <div class="language-go highlighter-rouge">
        <div class="highlight">
         <pre class="highlight"><code><span class="k">for</span> <span class="n">color</span><span class="p">,</span> <span class="n">army</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">b</span><span class="o">.</span><span class="n">Armies</span> <span class="p">{</span>
    <span class="c">// The king should never leave the board, because the game ends at</span>
    <span class="c">// checkmate.</span>
    <span class="k">if</span> <span class="n">army</span><span class="o">.</span><span class="n">King</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">&amp;</span><span class="n">MissingPieceError</span><span class="p">{</span><span class="n">Color</span><span class="o">:</span> <span class="n">color</span><span class="p">,</span> <span class="n">Piece</span><span class="o">:</span> <span class="n">chess</span><span class="o">.</span><span class="n">King</span><span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
        </div>
       </div>
      </li>
      <li>
       <p>
        <strong>
         Aggregate all failures
        </strong>
        : collect all failures, and report them all.
       </p>
       <p>
        This approach resembles the
        <a href="decisions#keep-going">
         keep going
        </a>
        guidance
                            in feel and may be preferable if the acceptance test is expected to
                            execute slowly.
       </p>
       <p>
        How you aggregate the failures should be dictated by whether you want to
                            give users the ability or yourself the ability to interrogate individual
                            failures (for example, for you to test your acceptance test). Below
                            demonstrates using a
        <a href="https://google.github.io/styleguide/go/index.html#gotip">
         custom error type
        </a>
        that
        <a href="https://google.github.io/styleguide/go/index.html#gotip">
         aggregates errors
        </a>
        :
       </p>
       <div class="language-go highlighter-rouge">
        <div class="highlight">
         <pre class="highlight"><code><span class="k">var</span> <span class="n">badMoves</span> <span class="p">[]</span><span class="kt">error</span>

<span class="n">move</span> <span class="o">:=</span> <span class="n">p</span><span class="o">.</span><span class="n">Move</span><span class="p">()</span>
<span class="k">if</span> <span class="n">putsOwnKingIntoCheck</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">move</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">badMoves</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">badMoves</span><span class="p">,</span> <span class="n">PutsSelfIntoCheckError</span><span class="p">{</span><span class="n">Move</span><span class="o">:</span> <span class="n">move</span><span class="p">})</span>
<span class="p">}</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">badMoves</span><span class="p">)</span> <span class="o">&gt;</span> <span class="m">0</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">SimulationError</span><span class="p">{</span><span class="n">BadMoves</span><span class="o">:</span> <span class="n">badMoves</span><span class="p">}</span>
<span class="p">}</span>
<span class="k">return</span> <span class="no">nil</span>
</code></pre>
        </div>
       </div>
      </li>
     </ul>
    </li>
   </ol>
   <p>
    The acceptance test should honor the
    <a href="decisions#keep-going">
     keep going
    </a>
    guidance
            by not calling
    <code class="language-plaintext highlighter-rouge">
     t.Fatal
    </code>
    unless the test detects a broken invariant in the
            system being exercised.
   </p>
   <p>
    For example,
    <code class="language-plaintext highlighter-rouge">
     t.Fatal
    </code>
    should be reserved for exceptional cases such as
    <a href="#test-helper-error-handling">
     setup failure
    </a>
    as usual:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="k">func</span> <span class="n">ExerciseGame</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">cfg</span> <span class="o">*</span><span class="n">Config</span><span class="p">,</span> <span class="n">p</span> <span class="n">chess</span><span class="o">.</span><span class="n">Player</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Helper</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">Simulation</span> <span class="o">==</span> <span class="n">Modem</span> <span class="p">{</span>
        <span class="n">conn</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">modempool</span><span class="o">.</span><span class="n">Allocate</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
            <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"No modem for the opponent could be provisioned: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">t</span><span class="o">.</span><span class="n">Cleanup</span><span class="p">(</span><span class="k">func</span><span class="p">()</span> <span class="p">{</span> <span class="n">modempool</span><span class="o">.</span><span class="n">Return</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="p">})</span>
    <span class="p">}</span>
    <span class="c">// Run acceptance test (a whole game).</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    This technique can help you create concise, canonical validations. But do not
            attempt to use it to bypass the
    <a href="decisions#assert">
     guidance on assertions
    </a>
    .
   </p>
   <p>
    The final product should be in a form similar to this for end users:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">package</span> <span class="n">deepblue_test</span>

<span class="k">import</span> <span class="p">(</span>
    <span class="s">"chesstest"</span>
    <span class="s">"deepblue"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">TestAcceptance</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">player</span> <span class="o">:=</span> <span class="n">deepblue</span><span class="o">.</span><span class="n">New</span><span class="p">()</span>
    <span class="n">err</span> <span class="o">:=</span> <span class="n">chesstest</span><span class="o">.</span><span class="n">ExerciseGame</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">chesstest</span><span class="o">.</span><span class="n">SimpleGame</span><span class="p">,</span> <span class="n">player</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"Deep Blue player failed acceptance test: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    <a id="use-real-transports">
    </a>
   </p>
   <h3 id="use-real-transports">
    Use real transports
   </h3>
   <p>
    When testing component integrations, especially where HTTP or RPC are used as
            the underlying transport between the components, prefer using the real
            underlying transport to connect to the test version of the backend.
   </p>
   <p>
    For example, suppose the code you want to test (sometimes referred to as “system
            under test” or SUT) interacts with a backend that implements the
    <a href="https://pkg.go.dev/google.golang.org/genproto/googleapis/longrunning">
     long running operations
    </a>
    API. To test your SUT, use a real
    <a href="https://pkg.go.dev/google.golang.org/genproto/googleapis/longrunning#OperationsClient">
     OperationsClient
    </a>
    that is connected to a
    <a href="https://abseil.io/resources/swe-book/html/ch13.html#basic_concepts">
     test double
    </a>
    (e.g., a mock, stub, or fake) of the
    <a href="https://pkg.go.dev/google.golang.org/genproto/googleapis/longrunning#OperationsServer">
     OperationsServer
    </a>
    .
   </p>
   <p>
    This is recommended over hand-implementing the client, due to the complexity of
            imitating client behavior correctly. By using the production client with a
            test-specific server, you ensure your test is using as much of the real code as
            possible.
   </p>
   <p>
    <strong>
     Tip:
    </strong>
    Where possible, use a testing library provided by the authors of the
            service under test.
   </p>
   <p>
    <a id="t-fatal">
    </a>
   </p>
   <h3 id="terror-vs-tfatal">
    <code class="language-plaintext highlighter-rouge">
     t.Error
    </code>
    vs.
    <code class="language-plaintext highlighter-rouge">
     t.Fatal
    </code>
   </h3>
   <p>
    As discussed in
    <a href="decisions#keep-going">
     decisions
    </a>
    , tests should generally not
            abort at the first encountered problem.
   </p>
   <p>
    However, some situations require that the test not proceed. Calling
    <code class="language-plaintext highlighter-rouge">
     t.Fatal
    </code>
    is
            appropriate when some piece of test setup fails, especially in
    <a href="#test-helper-error-handling">
     test setup helpers
    </a>
    , without which you cannot run the rest of the test. In a
            table-driven test,
    <code class="language-plaintext highlighter-rouge">
     t.Fatal
    </code>
    is appropriate for failures that set up the whole
            test function before the test loop. Failures that affect a single entry in the
            test table, which make it impossible to continue with that entry, should be
            reported as follows:
   </p>
   <ul>
    <li>
     If you’re not using
     <code class="language-plaintext highlighter-rouge">
      t.Run
     </code>
     subtests, use
     <code class="language-plaintext highlighter-rouge">
      t.Error
     </code>
     followed by a
     <code class="language-plaintext highlighter-rouge">
      continue
     </code>
     statement to move on to the next table entry.
    </li>
    <li>
     If you’re using subtests (and you’re inside a call to
     <code class="language-plaintext highlighter-rouge">
      t.Run
     </code>
     ), use
     <code class="language-plaintext highlighter-rouge">
      t.Fatal
     </code>
     , which ends the current subtest and allows your test case to
                progress to the next subtest.
    </li>
   </ul>
   <p>
    <strong>
     Warning:
    </strong>
    It is not always safe to call
    <code class="language-plaintext highlighter-rouge">
     t.Fatal
    </code>
    and similar functions.
    <a href="#t-fatal-goroutine">
     More details here
    </a>
    .
   </p>
   <p>
    <a id="test-helper-error-handling">
    </a>
   </p>
   <h3 id="error-handling-in-test-helpers">
    Error handling in test helpers
   </h3>
   <p>
    <strong>
     Note:
    </strong>
    This section discusses
    <a href="decisions#mark-test-helpers">
     test helpers
    </a>
    in the sense Go uses the term:
            functions that perform test setup and cleanup, not common assertion facilities.
            See the
    <a href="#test-functions">
     test functions
    </a>
    section for more discussion.
   </p>
   <p>
    Operations performed by a test helper sometimes fail. For example, setting up a
            directory with files involves I/O, which can fail. When test helpers fail, their
            failure often signifies that the test cannot continue, since a setup
            precondition failed. When this happens, prefer calling one of the
    <code class="language-plaintext highlighter-rouge">
     Fatal
    </code>
    functions in the helper:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">func</span> <span class="n">mustAddGameAssets</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dir</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Helper</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">WriteFile</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">Join</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="s">"pak0.pak"</span><span class="p">),</span> <span class="n">pak0</span><span class="p">,</span> <span class="m">0644</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"Setup failed: could not write pak0 asset: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">WriteFile</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">Join</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="s">"pak1.pak"</span><span class="p">),</span> <span class="n">pak1</span><span class="p">,</span> <span class="m">0644</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"Setup failed: could not write pak1 asset: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    This keeps the calling side cleaner than if the helper were to return the error
            to the test itself:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Bad:</span>
<span class="k">func</span> <span class="n">addGameAssets</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dir</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Helper</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">WriteFile</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">Join</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s">"pak0.pak"</span><span class="p">),</span> <span class="n">pak0</span><span class="p">,</span> <span class="m">0644</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">err</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">WriteFile</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">Join</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s">"pak1.pak"</span><span class="p">),</span> <span class="n">pak1</span><span class="p">,</span> <span class="m">0644</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">err</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    <strong>
     Warning:
    </strong>
    It is not always safe to call
    <code class="language-plaintext highlighter-rouge">
     t.Fatal
    </code>
    and similar functions.
    <a href="#t-fatal-goroutine">
     More details
    </a>
    here.
   </p>
   <p>
    The failure message should include a description of what happened. This is
            important, as you may be providing a testing API to many users, especially as
            the number of error-producing steps in the helper increases. When the test
            fails, the user should know where, and why.
   </p>
   <p>
    <strong>
     Tip:
    </strong>
    Go 1.14 introduced a
    <a href="https://pkg.go.dev/testing#T.Cleanup">
     <code class="language-plaintext highlighter-rouge">
      t.Cleanup
     </code>
    </a>
    function that can be used to
            register cleanup functions that run when your test completes. The function also
            works with test helpers. See
    <a href="https://google.github.io/styleguide/go/index.html#gotip">
     GoTip #4: Cleaning Up Your Tests
    </a>
    for guidance on simplifying test helpers.
   </p>
   <p>
    The snippet below in a fictional file called
    <code class="language-plaintext highlighter-rouge">
     paint_test.go
    </code>
    demonstrates how
    <code class="language-plaintext highlighter-rouge">
     (*testing.T).Helper
    </code>
    influences failure reporting in a Go test:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="k">package</span> <span class="n">paint_test</span>

<span class="k">import</span> <span class="p">(</span>
    <span class="s">"fmt"</span>
    <span class="s">"testing"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">paint</span><span class="p">(</span><span class="n">color</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"no %q paint today"</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">badSetup</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="c">// This should call t.Helper, but doesn't.</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">paint</span><span class="p">(</span><span class="s">"taupe"</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"Could not paint the house under test: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="c">// line 15</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">mustGoodSetup</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Helper</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">paint</span><span class="p">(</span><span class="s">"lilac"</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"Could not paint the house under test: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestBad</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">badSetup</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="c">// ...</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestGood</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">mustGoodSetup</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="c">// line 32</span>
    <span class="c">// ...</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    Here is an example of this output when run. Note the highlighted text and how it
            differs:
   </p>
   <div class="language-text highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code>=== RUN   TestBad
    paint_test.go:15: Could not paint the house under test: no "taupe" paint today
--- FAIL: TestBad (0.00s)
=== RUN   TestGood
    paint_test.go:32: Could not paint the house under test: no "lilac" paint today
--- FAIL: TestGood (0.00s)
FAIL
</code></pre>
    </div>
   </div>
   <p>
    The error with
    <code class="language-plaintext highlighter-rouge">
     paint_test.go:15
    </code>
    refers to the line of the setup function that
            failed in
    <code class="language-plaintext highlighter-rouge">
     badSetup
    </code>
    :
   </p>
   <p>
    <code class="language-plaintext highlighter-rouge">
     t.Fatalf("Could not paint the house under test: %v", err)
    </code>
   </p>
   <p>
    Whereas
    <code class="language-plaintext highlighter-rouge">
     paint_test.go:32
    </code>
    refers to the line of the test that failed in
    <code class="language-plaintext highlighter-rouge">
     TestGood
    </code>
    :
   </p>
   <p>
    <code class="language-plaintext highlighter-rouge">
     goodSetup(t)
    </code>
   </p>
   <p>
    Correctly using
    <code class="language-plaintext highlighter-rouge">
     (*testing.T).Helper
    </code>
    attributes the location of the failure
            much better when:
   </p>
   <ul>
    <li>
     the helper functions grow
    </li>
    <li>
     the helper functions call other helpers
    </li>
    <li>
     the amount of helper usage in the test functions grow
    </li>
   </ul>
   <p>
    <strong>
     Tip:
    </strong>
    If a helper calls
    <code class="language-plaintext highlighter-rouge">
     (*testing.T).Error
    </code>
    or
    <code class="language-plaintext highlighter-rouge">
     (*testing.T).Fatal
    </code>
    , provide
            some context in the format string to help determine what went wrong and why.
   </p>
   <p>
    <strong>
     Tip:
    </strong>
    If nothing a helper does can cause a test to fail, it doesn’t need to
            call
    <code class="language-plaintext highlighter-rouge">
     t.Helper
    </code>
    . Simplify its signature by removing
    <code class="language-plaintext highlighter-rouge">
     t
    </code>
    from the function
            parameter list.
   </p>
   <p>
    <a id="t-fatal-goroutine">
    </a>
   </p>
   <h3 id="dont-call-tfatal-from-separate-goroutines">
    Don’t call
    <code class="language-plaintext highlighter-rouge">
     t.Fatal
    </code>
    from separate goroutines
   </h3>
   <p>
    As
    <a href="https://pkg.go.dev/testing#T">
     documented in package testing
    </a>
    , it is
            incorrect to call
    <code class="language-plaintext highlighter-rouge">
     t.FailNow
    </code>
    ,
    <code class="language-plaintext highlighter-rouge">
     t.Fatal
    </code>
    , etc. from any goroutine but the one
            running the Test function (or the subtest). If your test starts new goroutines,
            they must not call these functions from inside these goroutines.
   </p>
   <p>
    <a href="#test-functions">
     Test helpers
    </a>
    usually don’t signal failure from new
            goroutines, and therefore it is all right for them to use
    <code class="language-plaintext highlighter-rouge">
     t.Fatal
    </code>
    . If in
            doubt, call
    <code class="language-plaintext highlighter-rouge">
     t.Error
    </code>
    and return instead.
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">func</span> <span class="n">TestRevEngine</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">engine</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">Start</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"Engine failed to start: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">num</span> <span class="o">:=</span> <span class="m">11</span>
    <span class="k">var</span> <span class="n">wg</span> <span class="n">sync</span><span class="o">.</span><span class="n">WaitGroup</span>
    <span class="n">wg</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="k">go</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">defer</span> <span class="n">wg</span><span class="o">.</span><span class="n">Done</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">engine</span><span class="o">.</span><span class="n">Vroom</span><span class="p">();</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
                <span class="c">// This cannot be t.Fatalf.</span>
                <span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"No vroom left on engine: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">rpm</span> <span class="o">:=</span> <span class="n">engine</span><span class="o">.</span><span class="n">Tachometer</span><span class="p">();</span> <span class="n">rpm</span> <span class="o">&gt;</span> <span class="m">1e6</span> <span class="p">{</span>
                <span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"Inconceivable engine rate: %d"</span><span class="p">,</span> <span class="n">rpm</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}()</span>
    <span class="p">}</span>
    <span class="n">wg</span><span class="o">.</span><span class="n">Wait</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">seen</span> <span class="o">:=</span> <span class="n">engine</span><span class="o">.</span><span class="n">NumVrooms</span><span class="p">();</span> <span class="n">seen</span> <span class="o">!=</span> <span class="n">num</span> <span class="p">{</span>
        <span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"engine.NumVrooms() = %d, want %d"</span><span class="p">,</span> <span class="n">seen</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    Adding
    <code class="language-plaintext highlighter-rouge">
     t.Parallel
    </code>
    to a test or subtest does not make it unsafe to call
    <code class="language-plaintext highlighter-rouge">
     t.Fatal
    </code>
    .
   </p>
   <p>
    When all calls to the
    <code class="language-plaintext highlighter-rouge">
     testing
    </code>
    API are in the
    <a href="#test-functions">
     test function
    </a>
    ,
            it is usually easy to spot incorrect usage because the
    <code class="language-plaintext highlighter-rouge">
     go
    </code>
    keyword is plain to
            see. Passing
    <code class="language-plaintext highlighter-rouge">
     testing.T
    </code>
    arguments around makes tracking such usage harder.
            Typically, the reason for passing these arguments is to introduce a test helper,
            and those should not depend on the system under test. Therefore, if a test
            helper
    <a href="#test-helper-error-handling">
     registers a fatal test failure
    </a>
    , it can and
            should do so from the test’s goroutine.
   </p>
   <p>
    <a id="t-field-names">
    </a>
   </p>
   <h3 id="use-field-names-in-struct-literals">
    Use field names in struct literals
   </h3>
   <p>
    <a id="t-field-labels">
    </a>
   </p>
   <p>
    In table-driven tests, prefer to specify field names when initializing test case
            struct literals. This is helpful when the test cases cover a large amount of
            vertical space (e.g. more than 20-30 lines), when there are adjacent fields with
            the same type, and also when you wish to omit fields which have the zero value.
            For example:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">func</span> <span class="n">TestStrJoin</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">tests</span> <span class="o">:=</span> <span class="p">[]</span><span class="k">struct</span> <span class="p">{</span>
        <span class="n">slice</span>     <span class="p">[]</span><span class="kt">string</span>
        <span class="n">separator</span> <span class="kt">string</span>
        <span class="n">skipEmpty</span> <span class="kt">bool</span>
        <span class="n">want</span>      <span class="kt">string</span>
    <span class="p">}{</span>
        <span class="p">{</span>
            <span class="n">slice</span><span class="o">:</span>     <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"a"</span><span class="p">,</span> <span class="s">"b"</span><span class="p">,</span> <span class="s">""</span><span class="p">},</span>
            <span class="n">separator</span><span class="o">:</span> <span class="s">","</span><span class="p">,</span>
            <span class="n">want</span><span class="o">:</span>      <span class="s">"a,b,"</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="n">slice</span><span class="o">:</span>     <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"a"</span><span class="p">,</span> <span class="s">"b"</span><span class="p">,</span> <span class="s">""</span><span class="p">},</span>
            <span class="n">separator</span><span class="o">:</span> <span class="s">","</span><span class="p">,</span>
            <span class="n">skipEmpty</span><span class="o">:</span> <span class="no">true</span><span class="p">,</span>
            <span class="n">want</span><span class="o">:</span>      <span class="s">"a,b"</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="c">// ...</span>
    <span class="p">}</span>
    <span class="c">// ...</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    <a id="t-common-setup-scope">
    </a>
   </p>
   <h3 id="keep-setup-code-scoped-to-specific-tests">
    Keep setup code scoped to specific tests
   </h3>
   <p>
    Where possible, setup of resources and dependencies should be as closely scoped
            to specific test cases as possible. For example, given a setup function:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// mustLoadDataSet loads a data set for the tests.</span>
<span class="c">//</span>
<span class="c">// This example is very simple and easy to read. Often realistic setup is more</span>
<span class="c">// complex, error-prone, and potentially slow.</span>
<span class="k">func</span> <span class="n">mustLoadDataset</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">[]</span><span class="kt">byte</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Helper</span><span class="p">()</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">ReadFile</span><span class="p">(</span><span class="s">"path/to/your/project/testdata/dataset"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"Could not load dataset: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">data</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    Call
    <code class="language-plaintext highlighter-rouge">
     mustLoadDataset
    </code>
    explicitly in test functions that need it:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">func</span> <span class="n">TestParseData</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">data</span> <span class="o">:=</span> <span class="n">mustLoadDataset</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">parsed</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">ParseData</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"Unexpected error parsing data: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">want</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">DataTable</span><span class="p">{</span> <span class="c">/* ... */</span> <span class="p">}</span>
    <span class="k">if</span> <span class="n">got</span> <span class="o">:=</span> <span class="n">parsed</span><span class="p">;</span> <span class="o">!</span><span class="n">cmp</span><span class="o">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">got</span><span class="p">,</span> <span class="n">want</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"ParseData(data) = %v, want %v"</span><span class="p">,</span> <span class="n">got</span><span class="p">,</span> <span class="n">want</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestListContents</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">data</span> <span class="o">:=</span> <span class="n">mustLoadDataset</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">contents</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">ListContents</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"Unexpected error listing contents: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">want</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span> <span class="c">/* ... */</span> <span class="p">}</span>
    <span class="k">if</span> <span class="n">got</span> <span class="o">:=</span> <span class="n">contents</span><span class="p">;</span> <span class="o">!</span><span class="n">cmp</span><span class="o">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">got</span><span class="p">,</span> <span class="n">want</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"ListContents(data) = %v, want %v"</span><span class="p">,</span> <span class="n">got</span><span class="p">,</span> <span class="n">want</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestRegression682831</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">got</span><span class="p">,</span> <span class="n">want</span> <span class="o">:=</span> <span class="n">guessOS</span><span class="p">(</span><span class="s">"zpc79.example.com"</span><span class="p">),</span> <span class="s">"grhat"</span><span class="p">;</span> <span class="n">got</span> <span class="o">!=</span> <span class="n">want</span> <span class="p">{</span>
        <span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">`guessOS("zpc79.example.com") = %q, want %q`</span><span class="p">,</span> <span class="n">got</span><span class="p">,</span> <span class="n">want</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    The test function
    <code class="language-plaintext highlighter-rouge">
     TestRegression682831
    </code>
    does not use the data set and therefore
            does not call
    <code class="language-plaintext highlighter-rouge">
     mustLoadDataset
    </code>
    , which could be slow and failure-prone:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Bad:</span>
<span class="k">var</span> <span class="n">dataset</span> <span class="p">[]</span><span class="kt">byte</span>

<span class="k">func</span> <span class="n">TestParseData</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="c">// As documented above without calling mustLoadDataset directly.</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestListContents</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="c">// As documented above without calling mustLoadDataset directly.</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestRegression682831</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">got</span><span class="p">,</span> <span class="n">want</span> <span class="o">:=</span> <span class="n">guessOS</span><span class="p">(</span><span class="s">"zpc79.example.com"</span><span class="p">),</span> <span class="s">"grhat"</span><span class="p">;</span> <span class="n">got</span> <span class="o">!=</span> <span class="n">want</span> <span class="p">{</span>
        <span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">`guessOS("zpc79.example.com") = %q, want %q`</span><span class="p">,</span> <span class="n">got</span><span class="p">,</span> <span class="n">want</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">init</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">mustLoadDataset</span><span class="p">()</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    A user may wish to run a function in isolation of the others and should not be
            penalized by these factors:
   </p>
   <div class="language-shell highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c"># No reason for this to perform the expensive initialization.</span>
<span class="nv">$ </span>go <span class="nb">test</span> <span class="nt">-run</span> TestRegression682831
</code></pre>
    </div>
   </div>
   <p>
    <a id="t-custom-main">
    </a>
   </p>
   <h4 id="when-to-use-a-custom-testmain-entrypoint">
    When to use a custom
    <code class="language-plaintext highlighter-rouge">
     TestMain
    </code>
    entrypoint
   </h4>
   <p>
    If
    <strong>
     all tests in the package
    </strong>
    require common setup and the
    <strong>
     setup requires
                teardown
    </strong>
    , you can use a
    <a href="https://golang.org/pkg/testing/#hdr-Main">
     custom testmain entrypoint
    </a>
    . This can happen if the
            resource the test cases require is especially expensive to setup, and the cost
            should be amortized. Typically you have extracted any unrelated tests from the
            test suite at that point. It is typically only used for
    <a href="https://en.wikipedia.org/wiki/Functional_testing">
     functional tests
    </a>
    .
   </p>
   <p>
    Using a custom
    <code class="language-plaintext highlighter-rouge">
     TestMain
    </code>
    <strong>
     should not be your first choice
    </strong>
    due the amount of
            care that should be taken for correct use. Consider first whether the solution
            in the
    <a href="#t-setup-amortization">
     <em>
      amortizing common test setup
     </em>
    </a>
    section or an ordinary
    <a href="#t-common-setup-scope">
     test helper
    </a>
    is
            sufficient for your needs.
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">var</span> <span class="n">db</span> <span class="o">*</span><span class="n">sql</span><span class="o">.</span><span class="n">DB</span>

<span class="k">func</span> <span class="n">TestInsert</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span> <span class="c">/* omitted */</span> <span class="p">}</span>

<span class="k">func</span> <span class="n">TestSelect</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span> <span class="c">/* omitted */</span> <span class="p">}</span>

<span class="k">func</span> <span class="n">TestUpdate</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span> <span class="c">/* omitted */</span> <span class="p">}</span>

<span class="k">func</span> <span class="n">TestDelete</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span> <span class="c">/* omitted */</span> <span class="p">}</span>

<span class="c">// runMain sets up the test dependencies and eventually executes the tests.</span>
<span class="c">// It is defined as a separate function to enable the setup stages to clearly</span>
<span class="c">// defer their teardown steps.</span>
<span class="k">func</span> <span class="n">runMain</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">m</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">M</span><span class="p">)</span> <span class="p">(</span><span class="n">code</span> <span class="kt">int</span><span class="p">,</span> <span class="n">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ctx</span><span class="p">,</span> <span class="n">cancel</span> <span class="o">:=</span> <span class="n">context</span><span class="o">.</span><span class="n">WithCancel</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
    <span class="k">defer</span> <span class="n">cancel</span><span class="p">()</span>

    <span class="n">d</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">setupDatabase</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="m">0</span><span class="p">,</span> <span class="n">err</span>
    <span class="p">}</span>
    <span class="k">defer</span> <span class="n">d</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span> <span class="c">// Expressly clean up database.</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">d</span>          <span class="c">// db is defined as a package-level variable.</span>

    <span class="c">// m.Run() executes the regular, user-defined test functions.</span>
    <span class="c">// Any defer statements that have been made will be run after m.Run()</span>
    <span class="c">// completes.</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">Run</span><span class="p">(),</span> <span class="no">nil</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestMain</span><span class="p">(</span><span class="n">m</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">M</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">code</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">runMain</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">Background</span><span class="p">(),</span> <span class="n">m</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="c">// Failure messages should be written to STDERR, which log.Fatal uses.</span>
        <span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c">// NOTE: defer statements do not run past here due to os.Exit</span>
    <span class="c">//       terminating the process.</span>
    <span class="n">os</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    Ideally a test case is hermetic between invocations of itself and between other
            test cases.
   </p>
   <p>
    At the very least, ensure that individual test cases reset any global state they
            have modified if they have done so (for instance, if the tests are working with
            an external database).
   </p>
   <p>
    <a id="t-setup-amortization">
    </a>
   </p>
   <h4 id="amortizing-common-test-setup">
    Amortizing common test setup
   </h4>
   <p>
    Using a
    <code class="language-plaintext highlighter-rouge">
     sync.Once
    </code>
    may be appropriate, though not required, if all of the
            following are true about the common setup:
   </p>
   <ul>
    <li>
     It is expensive.
    </li>
    <li>
     It only applies to some tests.
    </li>
    <li>
     It does not require teardown.
    </li>
   </ul>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">var</span> <span class="n">dataset</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">once</span> <span class="n">sync</span><span class="o">.</span><span class="n">Once</span>
    <span class="n">data</span> <span class="p">[]</span><span class="kt">byte</span>
    <span class="n">err</span>  <span class="kt">error</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">mustLoadDataset</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">[]</span><span class="kt">byte</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Helper</span><span class="p">()</span>
    <span class="n">dataset</span><span class="o">.</span><span class="n">once</span><span class="o">.</span><span class="n">Do</span><span class="p">(</span><span class="k">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">ReadFile</span><span class="p">(</span><span class="s">"path/to/your/project/testdata/dataset"</span><span class="p">)</span>
        <span class="c">// dataset is defined as a package-level variable.</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">err</span>
    <span class="p">})</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">err</span><span class="p">;</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"Could not load dataset: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">dataset</span><span class="o">.</span><span class="n">data</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    When
    <code class="language-plaintext highlighter-rouge">
     mustLoadDataset
    </code>
    is used in multiple test functions, its cost is
            amortized:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">func</span> <span class="n">TestParseData</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">data</span> <span class="o">:=</span> <span class="n">mustLoadDataset</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="c">// As documented above.</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestListContents</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">data</span> <span class="o">:=</span> <span class="n">mustLoadDataset</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="c">// As documented above.</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestRegression682831</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">got</span><span class="p">,</span> <span class="n">want</span> <span class="o">:=</span> <span class="n">guessOS</span><span class="p">(</span><span class="s">"zpc79.example.com"</span><span class="p">),</span> <span class="s">"grhat"</span><span class="p">;</span> <span class="n">got</span> <span class="o">!=</span> <span class="n">want</span> <span class="p">{</span>
        <span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">`guessOS("zpc79.example.com") = %q, want %q`</span><span class="p">,</span> <span class="n">got</span><span class="p">,</span> <span class="n">want</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    The reason that common teardown is tricky is there is no uniform place to
            register cleanup routines. If the setup function (in this case
    <code class="language-plaintext highlighter-rouge">
     loadDataset
    </code>
    )
            relies on a context,
    <code class="language-plaintext highlighter-rouge">
     sync.Once
    </code>
    may be problematic. This is because the second
            of two racing calls to the setup function would need to wait for the first call
            to finish before returning. This period of waiting cannot be easily made to
            respect the context’s cancellation.
   </p>
   <p>
    <a id="string-concat">
    </a>
   </p>
   <h2 id="string-concatenation">
    String concatenation
   </h2>
   <p>
    There are several ways to concatenate strings in Go. Some examples include:
   </p>
   <ul>
    <li>
     The “+” operator
    </li>
    <li>
     <code class="language-plaintext highlighter-rouge">
      fmt.Sprintf
     </code>
    </li>
    <li>
     <code class="language-plaintext highlighter-rouge">
      strings.Builder
     </code>
    </li>
    <li>
     <code class="language-plaintext highlighter-rouge">
      text/template
     </code>
    </li>
    <li>
     <code class="language-plaintext highlighter-rouge">
      safehtml/template
     </code>
    </li>
   </ul>
   <p>
    Though there is no one-size-fits-all rule for which to choose, the following
            guidance outlines when each method is preferred.
   </p>
   <p>
    <a id="string-concat-simple">
    </a>
   </p>
   <h3 id="prefer--for-simple-cases">
    Prefer “+” for simple cases
   </h3>
   <p>
    Prefer using “+” when concatenating few strings. This method is syntactically
            the simplest and requires no import.
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="n">key</span> <span class="o">:=</span> <span class="s">"projectid: "</span> <span class="o">+</span> <span class="n">p</span>
</code></pre>
    </div>
   </div>
   <p>
    <a id="string-concat-fmt">
    </a>
   </p>
   <h3 id="prefer-fmtsprintf-when-formatting">
    Prefer
    <code class="language-plaintext highlighter-rouge">
     fmt.Sprintf
    </code>
    when formatting
   </h3>
   <p>
    Prefer using
    <code class="language-plaintext highlighter-rouge">
     fmt.Sprintf
    </code>
    when building a complex string with formatting. Using
            many “+” operators may obscure the end result.
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="n">str</span> <span class="o">:=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"%s [%s:%d]-&gt; %s"</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">qos</span><span class="p">,</span> <span class="n">mtu</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
</code></pre>
    </div>
   </div>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Bad:</span>
<span class="n">bad</span> <span class="o">:=</span> <span class="n">src</span><span class="o">.</span><span class="n">String</span><span class="p">()</span> <span class="o">+</span> <span class="s">" ["</span> <span class="o">+</span> <span class="n">qos</span><span class="o">.</span><span class="n">String</span><span class="p">()</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">strconv</span><span class="o">.</span><span class="n">Itoa</span><span class="p">(</span><span class="n">mtu</span><span class="p">)</span> <span class="o">+</span> <span class="s">"]-&gt; "</span> <span class="o">+</span> <span class="n">dst</span><span class="o">.</span><span class="n">String</span><span class="p">()</span>
</code></pre>
    </div>
   </div>
   <p>
    <strong>
     Best Practice:
    </strong>
    When the output of the string-building operation is an
    <code class="language-plaintext highlighter-rouge">
     io.Writer
    </code>
    , don’t construct a temporary string with
    <code class="language-plaintext highlighter-rouge">
     fmt.Sprintf
    </code>
    just to send
            it to the Writer. Instead, use
    <code class="language-plaintext highlighter-rouge">
     fmt.Fprintf
    </code>
    to emit to the Writer directly.
   </p>
   <p>
    When the formatting is even more complex, prefer
    <a href="https://pkg.go.dev/text/template">
     <code class="language-plaintext highlighter-rouge">
      text/template
     </code>
    </a>
    or
    <a href="https://pkg.go.dev/github.com/google/safehtml/template">
     <code class="language-plaintext highlighter-rouge">
      safehtml/template
     </code>
    </a>
    as appropriate.
   </p>
   <p>
    <a id="string-concat-piecemeal">
    </a>
   </p>
   <h3 id="prefer-stringsbuilder-for-constructing-a-string-piecemeal">
    Prefer
    <code class="language-plaintext highlighter-rouge">
     strings.Builder
    </code>
    for constructing a string piecemeal
   </h3>
   <p>
    Prefer using
    <code class="language-plaintext highlighter-rouge">
     strings.Builder
    </code>
    when building a string bit-by-bit.
    <code class="language-plaintext highlighter-rouge">
     strings.Builder
    </code>
    takes amortized linear time, whereas “+” and
    <code class="language-plaintext highlighter-rouge">
     fmt.Sprintf
    </code>
    take quadratic time when called sequentially to form a larger string.
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="n">b</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="n">strings</span><span class="o">.</span><span class="n">Builder</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">digitsOfPi</span> <span class="p">{</span>
    <span class="n">fmt</span><span class="o">.</span><span class="n">Fprintf</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s">"the %d digit of pi is: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">str</span> <span class="o">:=</span> <span class="n">b</span><span class="o">.</span><span class="n">String</span><span class="p">()</span>
</code></pre>
    </div>
   </div>
   <p>
    <strong>
     Note:
    </strong>
    For more discussion, see
    <a href="https://google.github.io/styleguide/go/index.html#gotip">
     GoTip #29: Building Strings Efficiently
    </a>
    .
   </p>
   <p>
    <a id="string-constants">
    </a>
   </p>
   <h3 id="constant-strings">
    Constant strings
   </h3>
   <p>
    Prefer to use backticks (`) when constructing constant, multi-line string
            literals.
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="n">usage</span> <span class="o">:=</span> <span class="s">`Usage:

custom_tool [args]`</span>
</code></pre>
    </div>
   </div>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Bad:</span>
<span class="n">usage</span> <span class="o">:=</span> <span class="s">""</span> <span class="o">+</span>
  <span class="s">"Usage:</span><span class="se">\n</span><span class="s">"</span> <span class="o">+</span>
  <span class="s">"</span><span class="se">\n</span><span class="s">"</span> <span class="o">+</span>
  <span class="s">"custom_tool [args]"</span>
</code></pre>
    </div>
   </div>
   <!--
-->
   <p>
    <a id="globals">
    </a>
   </p>
   <h2 id="global-state">
    Global state
   </h2>
   <p>
    Libraries should not force their clients to use APIs that rely on
    <a href="https://en.wikipedia.org/wiki/Global_variable">
     global state
    </a>
    . They are advised
            not to expose APIs or export
    <a href="https://go.dev/ref/spec#TopLevelDecl">
     package level
    </a>
    variables that control
            behavior for all clients as parts of their API. The rest of the section uses
            “global” and “package level state” synonymously.
   </p>
   <p>
    Instead, if your functionality maintains state, allow your clients to create and
            use instance values.
   </p>
   <p>
    <strong>
     Important:
    </strong>
    While this guidance is applicable to all developers, it is most
            critical for infrastructure providers who offer libraries, integrations, and
            services to other teams.
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="c">// Package sidecar manages subprocesses that provide features for applications.</span>
<span class="k">package</span> <span class="n">sidecar</span>

<span class="k">type</span> <span class="n">Registry</span> <span class="k">struct</span> <span class="p">{</span> <span class="n">plugins</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="n">Plugin</span> <span class="p">}</span>

<span class="k">func</span> <span class="n">New</span><span class="p">()</span> <span class="o">*</span><span class="n">Registry</span> <span class="p">{</span> <span class="k">return</span> <span class="o">&amp;</span><span class="n">Registry</span><span class="p">{</span><span class="n">plugins</span><span class="o">:</span> <span class="nb">make</span><span class="p">(</span><span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="n">Plugin</span><span class="p">)}</span> <span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span><span class="n">Registry</span><span class="p">)</span> <span class="n">Register</span><span class="p">(</span><span class="n">name</span> <span class="kt">string</span><span class="p">,</span> <span class="n">p</span> <span class="o">*</span><span class="n">Plugin</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    Your users will instantiate the data they need (a
    <code class="language-plaintext highlighter-rouge">
     *sidecar.Registry
    </code>
    ) and then
            pass it as an explicit dependency:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">package</span> <span class="n">main</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">sidecars</span> <span class="o">:=</span> <span class="n">sidecar</span><span class="o">.</span><span class="n">New</span><span class="p">()</span>
  <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">sidecars</span><span class="o">.</span><span class="n">Register</span><span class="p">(</span><span class="s">"Cloud Logger"</span><span class="p">,</span> <span class="n">cloudlogger</span><span class="o">.</span><span class="n">New</span><span class="p">());</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="n">log</span><span class="o">.</span><span class="n">Exitf</span><span class="p">(</span><span class="s">"could not setup cloud logger: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="n">cfg</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">myapp</span><span class="o">.</span><span class="n">Config</span><span class="p">{</span><span class="n">Sidecars</span><span class="o">:</span> <span class="n">sidecars</span><span class="p">}</span>
  <span class="n">myapp</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">Background</span><span class="p">(),</span> <span class="n">cfg</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    There are different approaches to migrating existing code to support dependency
            passing. The main one you will use is passing dependencies as parameters to
            constructors, functions, methods, or struct fields on the call chain.
   </p>
   <p>
    See also:
   </p>
   <ul>
    <li>
     <a href="https://google.github.io/styleguide/go/index.html#gotip">
      Go Tip #5: Slimming Your Client Libraries
     </a>
    </li>
    <li>
     <a href="https://google.github.io/styleguide/go/index.html#gotip">
      Go Tip #24: Use Case-Specific Constructions
     </a>
    </li>
    <li>
     <a href="https://google.github.io/styleguide/go/index.html#gotip">
      Go Tip #40: Improving Time Testability with Function Parameters
     </a>
    </li>
    <li>
     <a href="https://google.github.io/styleguide/go/index.html#gotip">
      Go Tip #41: Identify Function Call Parameters
     </a>
    </li>
    <li>
     <a href="https://google.github.io/styleguide/go/index.html#gotip">
      Go Tip #44: Improving Time Testability with Struct Fields
     </a>
    </li>
    <li>
     <a href="https://google.github.io/styleguide/go/index.html#gotip">
      Go Tip #80: Dependency Injection Principles
     </a>
    </li>
   </ul>
   <p>
    APIs that do not support explicit dependency passing become fragile as the
            number of clients increases:
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Bad:</span>
<span class="k">package</span> <span class="n">sidecar</span>

<span class="k">var</span> <span class="n">registry</span> <span class="o">=</span> <span class="nb">make</span><span class="p">(</span><span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="n">Plugin</span><span class="p">)</span>

<span class="k">func</span> <span class="n">Register</span><span class="p">(</span><span class="n">name</span> <span class="kt">string</span><span class="p">,</span> <span class="n">p</span> <span class="o">*</span><span class="n">Plugin</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span> <span class="c">/* registers plugin in registry */</span> <span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    Consider what happens in the case of tests exercising code that transitively
            relies on a sidecar for cloud logging.
   </p>
   <div class="language-go highlighter-rouge">
    <div class="highlight">
     <pre class="highlight"><code><span class="c">// Bad:</span>
<span class="k">package</span> <span class="n">app</span>

<span class="k">import</span> <span class="p">(</span>
  <span class="s">"cloudlogger"</span>
  <span class="s">"sidecar"</span>
  <span class="s">"testing"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">TestEndToEnd</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="c">// The system under test (SUT) relies on a sidecar for a production cloud</span>
  <span class="c">// logger already being registered.</span>
  <span class="o">...</span> <span class="c">// Exercise SUT and check invariants.</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestRegression_NetworkUnavailability</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="c">// We had an outage because of a network partition that rendered the cloud</span>
  <span class="c">// logger inoperative, so we added a regression test to exercise the SUT with</span>
  <span class="c">// a test double that simulates network unavailability with the logger.</span>
  <span class="n">sidecar</span><span class="o">.</span><span class="n">Register</span><span class="p">(</span><span class="s">"cloudlogger"</span><span class="p">,</span> <span class="n">cloudloggertest</span><span class="o">.</span><span class="n">UnavailableLogger</span><span class="p">)</span>
  <span class="o">...</span> <span class="c">// Exercise SUT and check invariants.</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestRegression_InvalidUser</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="c">// The system under test (SUT) relies on a sidecar for a production cloud</span>
  <span class="c">// logger already being registered.</span>
  <span class="c">//</span>
  <span class="c">// Oops. cloudloggertest.UnavailableLogger is still registered from the</span>
  <span class="c">// previous test.</span>
  <span class="o">...</span> <span class="c">// Exercise SUT and check invariants.</span>
<span class="p">}</span>
</code></pre>
    </div>
   </div>
   <p>
    Go tests are executed sequentially by default, so the tests above run as:
   </p>
   <ol>
    <li>
     <code class="language-plaintext highlighter-rouge">
      TestEndToEnd
     </code>
    </li>
    <li>
     <code class="language-plaintext highlighter-rouge">
      TestRegression_NetworkUnavailability
     </code>
     , which overrides the default value of
                cloudlogger
    </li>
    <li>
     <code class="language-plaintext highlighter-rouge">
      TestRegression_InvalidUser
     </code>
     , which requires the default value of
                cloudlogger registered in
     <code class="language-plaintext highlighter-rouge">
      package sidecar
     </code>
    </li>
   </ol>
   <p>
    This creates an order-dependent test case, which breaks running with test
            filters, and prevents tests from running in parallel or being sharded.
   </p>
   <p>
    Using global state poses problems that lack easy answers for you and the API’s
            clients:
   </p>
   <ul>
    <li>
     <p>
      What happens if a client needs to use different and separately operating
                    sets of
      <code class="language-plaintext highlighter-rouge">
       Plugin
      </code>
      s (for example, to support multiple servers) in the same
                    process space?
     </p>
    </li>
    <li>
     <p>
      What happens if a client wants to replace a registered
      <code class="language-plaintext highlighter-rouge">
       Plugin
      </code>
      with an
                    alternative implementation in a test, like a
      <a href="https://abseil.io/resources/swe-book/html/ch13.html#basic_concepts">
       test double
      </a>
      ?
     </p>
     <p>
      What happens if a client’s tests require hermeticity between instances of a
      <code class="language-plaintext highlighter-rouge">
       Plugin
      </code>
      , or between all of the plugins registered?
     </p>
    </li>
    <li>
     <p>
      What happens if multiple clients
      <code class="language-plaintext highlighter-rouge">
       Register
      </code>
      a
      <code class="language-plaintext highlighter-rouge">
       Plugin
      </code>
      under the same name?
                    Which one wins, if any?
     </p>
     <p>
      How should errors be
      <a href="decisions#handle-errors">
       handled
      </a>
      ? If the code panics
                    or calls
      <code class="language-plaintext highlighter-rouge">
       log.Fatal
      </code>
      , will that always be
      <a href="decisions#dont-panic">
       appropriate for all places in which API would be called
      </a>
      ?
                    Can a client verify it doesn’t do something bad before doing so?
     </p>
    </li>
    <li>
     <p>
      Are there certain stages in a program’s startup phases or lifetime during
                    which
      <code class="language-plaintext highlighter-rouge">
       Register
      </code>
      can be called and when it can’t?
     </p>
     <p>
      What happens if
      <code class="language-plaintext highlighter-rouge">
       Register
      </code>
      is called at the wrong time? A client could call
      <code class="language-plaintext highlighter-rouge">
       Register
      </code>
      in
      <a href="https://go.dev/ref/spec#Package_initialization">
       <code class="language-plaintext highlighter-rouge">
        func init
       </code>
      </a>
      ,
                    before flags are parsed, or after
      <code class="language-plaintext highlighter-rouge">
       main
      </code>
      . The stage at which a function is
                    called affects error handling. If the author of an API assumes the API is
      <em>
       only
      </em>
      called during program initialization without the requirement that it
                    is, the assumption may nudge the author to design error handling to
      <a href="best-practices#program-init">
       abort the program
      </a>
      by modeling the API as a
      <code class="language-plaintext highlighter-rouge">
       Must
      </code>
      -like function. Aborting is not appropriate for general-purpose
                    library functions that can be used at any stage.
     </p>
    </li>
    <li>
     <p>
      What if the client’s and the designer’s concurrency needs are mismatched?
     </p>
    </li>
   </ul>
   <p>
    See also:
   </p>
   <ul>
    <li>
     <a href="https://google.github.io/styleguide/go/index.html#gotip">
      Go Tip #36: Enclosing Package-Level State
     </a>
    </li>
    <li>
     <a href="https://google.github.io/styleguide/go/index.html#gotip">
      Go Tip #71: Reducing Parallel Test Flakiness
     </a>
    </li>
    <li>
     <a href="https://google.github.io/styleguide/go/index.html#gotip">
      Go Tip #80: Dependency Injection Principles
     </a>
    </li>
    <li>
     Error Handling:
     <a href="https://docs.python.org/3/glossary.html#term-LBYL">
      Look Before You Leap
     </a>
     versus
     <a href="https://docs.python.org/3/glossary.html#term-EAFP">
      Easier to Ask for Forgiveness than Permission
     </a>
    </li>
    <li>
     <a href="/styleguide/go/#unit-testing-practices">
      Unit Testing Practices on Public APIs
     </a>
    </li>
   </ul>
   <p>
    Global state has cascading effects on the
    <a href="/styleguide/go/guide.html#maintainability">
     health of the Google codebase
    </a>
    . Global state should
            be approached with
    <strong>
     extreme scrutiny
    </strong>
    .
   </p>
   <p>
    <a href="#globals-forms">
     Global state comes in several forms
    </a>
    , and you can use a few
    <a href="#globals-litmus-tests">
     litmus tests to identify when it is safe
    </a>
    .
   </p>
   <p>
    <a id="globals-forms">
    </a>
   </p>
   <h3 id="major-forms-of-package-state-apis">
    Major forms of package state APIs
   </h3>
   <p>
    Several of the most common problematic API forms are enumerated below:
   </p>
   <ul>
    <li>
     <p>
      Top-level variables irrespective of whether they are exported.
     </p>
     <div class="language-go highlighter-rouge">
      <div class="highlight">
       <pre class="highlight"><code><span class="c">// Bad:</span>
<span class="k">package</span> <span class="n">logger</span>

<span class="c">// Sinks manages the default output sources for this package's logging API.  This</span>
<span class="c">// variable should be set at package initialization time and never thereafter.</span>
<span class="k">var</span> <span class="n">Sinks</span> <span class="p">[]</span><span class="n">Sink</span>
</code></pre>
      </div>
     </div>
     <p>
      See the
      <a href="#globals-litmus-tests">
       litmus tests
      </a>
      to know when these are safe.
     </p>
    </li>
    <li>
     <p>
      The
      <a href="https://en.wikipedia.org/wiki/Service_locator_pattern">
       service locator pattern
      </a>
      .
                    See the
      <a href="#globals">
       first example
      </a>
      . The service locator pattern itself is not
                    problematic, rather the locator being defined as global.
     </p>
    </li>
    <li>
     <p>
      Registries for
      <a href="https://en.wikipedia.org/wiki/Callback_\(computer_programming\)">
       callbacks
      </a>
      and similar behaviors.
     </p>
     <div class="language-go highlighter-rouge">
      <div class="highlight">
       <pre class="highlight"><code><span class="c">// Bad:</span>
<span class="k">package</span> <span class="n">health</span>

<span class="k">var</span> <span class="n">unhealthyFuncs</span> <span class="p">[]</span><span class="k">func</span>

<span class="k">func</span> <span class="n">OnUnhealthy</span><span class="p">(</span><span class="n">f</span> <span class="k">func</span><span class="p">())</span> <span class="p">{</span>
  <span class="n">unhealthyFuncs</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">unhealthyFuncs</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
      </div>
     </div>
    </li>
    <li>
     <p>
      Thick-Client singletons for things like backends, storage, data access
                    layers, and other system resources. These often pose additional problems
                    with service reliability.
     </p>
     <div class="language-go highlighter-rouge">
      <div class="highlight">
       <pre class="highlight"><code><span class="c">// Bad:</span>
<span class="k">package</span> <span class="n">useradmin</span>

<span class="k">var</span> <span class="n">client</span> <span class="n">pb</span><span class="o">.</span><span class="n">UserAdminServiceClientInterface</span>

<span class="k">func</span> <span class="n">Client</span><span class="p">()</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">UserAdminServiceClient</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">client</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="n">client</span> <span class="o">=</span> <span class="o">...</span>  <span class="c">// Set up client.</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">client</span>
<span class="p">}</span>
</code></pre>
      </div>
     </div>
    </li>
   </ul>
   <blockquote>
    <p>
     <strong>
      Note:
     </strong>
     Many legacy APIs in the Google codebase do not follow this guidance;
                in fact, some Go standard libraries allow for configuration via global values.
                Nevertheless, the legacy API’s contravention of this guidance
     <strong>
      <a href="guide#local-consistency">
       should not be used as precedent
      </a>
     </strong>
     for continuing
                the pattern.
    </p>
    <p>
     It is better to invest in proper API design today than pay for redesigning
                later.
    </p>
   </blockquote>
   <p>
    <a id="globals-litmus-tests">
    </a>
   </p>
   <h3 id="litmus-tests">
    Litmus tests
   </h3>
   <p>
    <a href="#globals-forms">
     APIs using the patterns above
    </a>
    are unsafe when:
   </p>
   <ul>
    <li>
     Multiple functions interact via global state when executed in the same
                program, despite being otherwise independent (for example, authored by
                different authors in vastly different directories).
    </li>
    <li>
     Independent test cases interact with each other through global state.
    </li>
    <li>
     Users of the API are tempted to swap or replace global state for testing
                purposes, particularly to replace any part of the state with a
     <a href="https://abseil.io/resources/swe-book/html/ch13.html#basic_concepts">
      test double
     </a>
     , like a stub, fake, spy, or mock.
    </li>
    <li>
     Users have to consider special ordering requirements when interacting with
                global state:
     <code class="language-plaintext highlighter-rouge">
      func init
     </code>
     , whether flags are parsed yet, etc.
    </li>
   </ul>
   <p>
    Provided the conditions above are avoided, there are a
    <strong>
     few limited
                circumstances under which these APIs are safe
    </strong>
    , namely when any of the
            following is true:
   </p>
   <ul>
    <li>
     The global state is logically constant
                (
     <a href="https://github.com/klauspost/compress/blob/290f4cfacb3eff892555a491e3eeb569a48665e7/zstd/snappy.go#L413">
      example
     </a>
     ).
    </li>
    <li>
     The package’s observable behavior is stateless. For example, a public
                function may use a private global variable as a cache, but so long as the
                caller can’t distinguish cache hits from misses, the function is stateless.
    </li>
    <li>
     The global state does not bleed into things that are external to the
                program, like sidecar processes or files on a shared filesystem.
    </li>
    <li>
     There is no expectation of predictable behavior
                (
     <a href="https://pkg.go.dev/math/rand">
      example
     </a>
     ).
    </li>
   </ul>
   <blockquote>
    <p>
     <strong>
      Note:
     </strong>
     <a href="https://www.oreilly.com/library/view/designing-distributed-systems/9781491983638/ch02.html">
      Sidecar processes
     </a>
     may
     <strong>
      not
     </strong>
     strictly be process-local. They can and often are shared with more
                than one application process. Moreover, these sidecars often interact with
                external distributed systems.
    </p>
    <p>
     Further, the same stateless, idempotent, and local rules in addition to the
                base considerations above would apply to the code of the sidecar process
                itself!
    </p>
   </blockquote>
   <p>
    An example of one of these safe situations is
    <a href="https://pkg.go.dev/image">
     <code class="language-plaintext highlighter-rouge">
      package image
     </code>
    </a>
    with its
    <a href="https://pkg.go.dev/image#RegisterFormat">
     <code class="language-plaintext highlighter-rouge">
      image.RegisterFormat
     </code>
    </a>
    function.
            Consider the litmus tests from above applied to a typical decoder, like the one
            for handling the
    <a href="https://pkg.go.dev/image/png">
     PNG
    </a>
    format:
   </p>
   <ul>
    <li>
     Multiple calls to
     <code class="language-plaintext highlighter-rouge">
      package image
     </code>
     ’s APIs that use the registered decoders
                (for example,
     <code class="language-plaintext highlighter-rouge">
      image.Decode
     </code>
     ) cannot interfere with one another, similarly
                for tests. The only exception is
     <code class="language-plaintext highlighter-rouge">
      image.RegisterFormat
     </code>
     , but that is
                mitigated by the points below.
    </li>
    <li>
     It is extremely unlikely that a user would want to replace a decoder with a
     <a href="https://abseil.io/resources/swe-book/html/ch13.html#basic_concepts">
      test double
     </a>
     , as the PNG decoder exemplifies a case in which our codebase’s
                preference for real objects applies. However, a user would be more likely to
                replace a decoder with a test double if the decoder statefully interacted
                with operating system resources (for example, the network).
    </li>
    <li>
     Collisions in registration are conceivable, though they are probably rare in
                practice.
    </li>
    <li>
     The decoders are stateless, idempotent, and pure.
    </li>
   </ul>
   <p>
    <a id="globals-default-instance">
    </a>
   </p>
   <h3 id="providing-a-default-instance">
    Providing a default instance
   </h3>
   <p>
    While not recommended, it is acceptable to provide a simplified API that uses
            package level state if you need to maximize convenience for the user.
   </p>
   <p>
    Follow the
    <a href="#globals-litmus-tests">
     litmus tests
    </a>
    with these guidelines in such
            cases:
   </p>
   <ol>
    <li>
     The package must offer clients the ability to create isolated instances of
                package types as
     <a href="#globals-forms">
      described above
     </a>
     .
    </li>
    <li>
     The public APIs that use global state must be a thin proxy to the previous
                API. A good example of this is
     <a href="https://pkg.go.dev/net/http#Handle">
      <code class="language-plaintext highlighter-rouge">
       http.Handle
      </code>
     </a>
     internally calling
     <a href="https://pkg.go.dev/net/http#ServeMux.Handle">
      <code class="language-plaintext highlighter-rouge">
       (*http.ServeMux).Handle
      </code>
     </a>
     on
                the package variable
     <a href="https://pkg.go.dev/net/http#DefaultServeMux">
      <code class="language-plaintext highlighter-rouge">
       http.DefaultServeMux
      </code>
     </a>
     .
    </li>
    <li>
     <p>
      This package-level API must only be used by
      <a href="https://github.com/bazelbuild/rules_go/blob/master/docs/go/core/rules.md#go_binary">
       binary build targets
      </a>
      , not
      <a href="https://github.com/bazelbuild/rules_go/blob/master/docs/go/core/rules.md#go_library">
       libraries
      </a>
      , unless the libraries are undertaking a refactoring to support
                    dependency passing. Infrastructure libraries that can be imported by other
                    packages must not rely on package-level state of the packages they import.
     </p>
     <p>
      For example, an infrastructure provider implementing a sidecar that is to be
                    shared with other teams using the API from the top should offer an API to
                    accommodate this:
     </p>
     <div class="language-go highlighter-rouge">
      <div class="highlight">
       <pre class="highlight"><code><span class="c">// Good:</span>
<span class="k">package</span> <span class="n">cloudlogger</span>

<span class="k">func</span> <span class="n">New</span><span class="p">()</span> <span class="o">*</span><span class="n">Logger</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>

<span class="k">func</span> <span class="n">Register</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span><span class="n">sidecar</span><span class="o">.</span><span class="n">Registry</span><span class="p">,</span> <span class="n">l</span> <span class="o">*</span><span class="n">Logger</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">r</span><span class="o">.</span><span class="n">Register</span><span class="p">(</span><span class="s">"Cloud Logging"</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
      </div>
     </div>
    </li>
    <li>
     This package-level API must
     <a href="#documentation-conventions">
      document
     </a>
     and
                enforce its invariants (for example, at which stage in the program’s life it
                can be called, whether it can be used concurrently). Further, it must
                provide an API to reset global state to a known-good default (for example,
                to facilitate testing).
    </li>
   </ol>
   <p>
    See also:
   </p>
   <ul>
    <li>
     <a href="https://google.github.io/styleguide/go/index.html#gotip">
      Go Tip #36: Enclosing Package-Level State
     </a>
    </li>
    <li>
     <a href="https://google.github.io/styleguide/go/index.html#gotip">
      Go Tip #80: Dependency Injection Principles
     </a>
    </li>
   </ul>
   <div class="footer border-top border-gray-light mt-5 pt-3 text-right text-gray">
    This site is open source.
    <a href="https://github.com/google/styleguide/edit/gh-pages/go/best-practices.md">
     Improve this page
    </a>
    .
   </div>
  </div>
  <script crossorigin="anonymous" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js">
  </script>
  <script>
   anchors.add();
  </script>
 </body>
</html>
