<!DOCTYPE html>
<!-- saved from url=(0059)https://docs.ckan.org/en/2.9/contributing/architecture.html -->
<html class="js flexbox canvas canvastext webgl no-touch geolocation postmessage no-websqldatabase indexeddb hashchange history draganddrop websockets rgba hsla multiplebgs backgroundsize borderimage borderradius boxshadow textshadow opacity cssanimations csscolumns cssgradients cssreflections csstransforms csstransforms3d csstransitions fontface generatedcontent video audio localstorage sessionstorage webworkers no-applicationcache svg inlinesvg smil svgclippaths" lang="en" style="">
 <!--<![endif]-->
 <head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>
   CKAN code architecture — CKAN 2.9.11 documentation
  </title>
  <script src="./ckan_files/modernizr.min.js.下载" type="text/javascript">
  </script>
  <script data-url_root="../" id="documentation_options" src="./ckan_files/documentation_options.js.下载" type="text/javascript">
  </script>
  <script src="./ckan_files/jquery.js.下载" type="text/javascript">
  </script>
  <script src="./ckan_files/underscore.js.下载" type="text/javascript">
  </script>
  <script src="./ckan_files/doctools.js.下载" type="text/javascript">
  </script>
  <script src="./ckan_files/language_data.js.下载" type="text/javascript">
  </script>
  <script async="async" src="./ckan_files/readthedocs-doc-embed.js.下载" type="text/javascript">
  </script>
  <script src="./ckan_files/theme.js.下载" type="text/javascript">
  </script>
  <link href="./ckan_files/theme.css" rel="stylesheet" type="text/css"/>
  <link href="./ckan_files/pygments.css" rel="stylesheet" type="text/css"/>
  <link href="./ckan_files/custom.css" rel="stylesheet" type="text/css"/>
  <link href="https://docs.ckan.org/en/2.9/genindex.html" rel="index" title="Index"/>
  <link href="https://docs.ckan.org/en/2.9/search.html" rel="search" title="Search"/>
  <link href="https://docs.ckan.org/en/2.9/contributing/css.html" rel="next" title="CSS coding standards"/>
  <link href="https://docs.ckan.org/en/2.9/contributing/simple-code-contributions.html" rel="prev" title="Projects for beginner CKAN developers"/>
  <!-- RTD Extra Head -->
  <link href="./ckan_files/readthedocs-doc-embed.css" rel="stylesheet" type="text/css"/>
  <script id="READTHEDOCS_DATA" type="application/json">
   {"ad_free": false, "api_host": "https://readthedocs.org", "builder": "sphinx", "canonical_url": null, "docroot": "/doc/", "features": {"docsearch_disabled": false}, "global_analytics_code": "UA-17997319-1", "language": "en", "page": "contributing/architecture", "programming_language": "py", "project": "ckan", "proxied_api_host": "/_", "source_suffix": ".rst", "subprojects": {"ckanext-spatial": "https://docs.ckan.org/projects/ckanext-spatial/en/latest/"}, "theme": "sphinx_rtd_theme", "user_analytics_code": "UA-82993323-1", "version": "2.9"}
  </script>
  <!--
Using this variable directly instead of using `JSON.parse` is deprecated.
The READTHEDOCS_DATA global variable will be removed in the future.
-->
  <script type="text/javascript">
   READTHEDOCS_DATA = JSON.parse(document.getElementById('READTHEDOCS_DATA').innerHTML);
  </script>
  <script async="async" src="./ckan_files/readthedocs-analytics.js.下载" type="text/javascript">
  </script>
  <!-- end RTD <extrahead> -->
  <script async="" id="ethicaladsjs" src="./ckan_files/ethicalads.min.js.下载" type="text/javascript">
  </script>
 </head>
 <body class="wy-body-for-nav">
  <div class="wy-grid-for-nav">
   <nav class="wy-nav-side" data-toggle="wy-nav-shift">
    <div class="wy-side-scroll">
     <div class="wy-side-nav-search">
      <a href="https://docs.ckan.org/en/2.9/contents.html">
       <img alt="Logo" class="logo" src="./ckan_files/ckanlogo.webp"/>
      </a>
      <div class="version">
       2.9.11
      </div>
      <div role="search">
       <form action="https://docs.ckan.org/en/2.9/search.html" class="wy-form" id="rtd-search-form" method="get">
        <input name="q" placeholder="Search docs" type="text"/>
        <input name="check_keywords" type="hidden" value="yes"/>
        <input name="area" type="hidden" value="default"/>
       </form>
      </div>
     </div>
     <div aria-label="main navigation" class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation">
      <ul class="current">
       <li class="toctree-l1">
        <a class="reference internal" href="https://docs.ckan.org/en/2.9/user-guide.html">
         User guide
        </a>
       </li>
       <li class="toctree-l1">
        <a class="reference internal" href="https://docs.ckan.org/en/2.9/sysadmin-guide.html">
         Sysadmin guide
        </a>
       </li>
       <li class="toctree-l1">
        <a class="reference internal" href="https://docs.ckan.org/en/2.9/maintaining/index.html">
         Maintainer’s guide
        </a>
       </li>
       <li class="toctree-l1">
        <a class="reference internal" href="https://docs.ckan.org/en/2.9/api/index.html">
         API guide
        </a>
       </li>
       <li class="toctree-l1">
        <a class="reference internal" href="https://docs.ckan.org/en/2.9/extensions/index.html">
         Extending guide
        </a>
       </li>
       <li class="toctree-l1">
        <a class="reference internal" href="https://docs.ckan.org/en/2.9/theming/index.html">
         Theming guide
        </a>
       </li>
       <li class="toctree-l1 current">
        <a class="reference internal" href="https://docs.ckan.org/en/2.9/contributing/index.html">
         <span class="toctree-expand">
         </span>
         Contributing guide
        </a>
        <ul class="">
         <li class="toctree-l2">
          <a class="reference internal" href="https://docs.ckan.org/en/2.9/contributing/issues.html">
           Reporting issues
          </a>
         </li>
         <li class="toctree-l2">
          <a class="reference internal" href="https://docs.ckan.org/en/2.9/contributing/i18n.html">
           Translating CKAN
          </a>
         </li>
         <li class="toctree-l2">
          <a class="reference internal" href="https://docs.ckan.org/en/2.9/contributing/test.html">
           Testing CKAN
          </a>
         </li>
         <li class="toctree-l2">
          <a class="reference internal" href="https://docs.ckan.org/en/2.9/contributing/commit-messages.html">
           Writing commit messages
          </a>
         </li>
         <li class="toctree-l2">
          <a class="reference internal" href="https://docs.ckan.org/en/2.9/contributing/pull-requests.html">
           Making a pull request
          </a>
         </li>
         <li class="toctree-l2">
          <a class="reference internal" href="https://docs.ckan.org/en/2.9/contributing/reviewing.html">
           Reviewing and merging a pull request
          </a>
         </li>
         <li class="toctree-l2">
          <a class="reference internal" href="https://docs.ckan.org/en/2.9/contributing/documentation.html">
           Writing documentation
          </a>
         </li>
         <li class="toctree-l2">
          <a class="reference internal" href="https://docs.ckan.org/en/2.9/contributing/simple-code-contributions.html">
           Projects for beginner CKAN developers
          </a>
         </li>
         <li class="toctree-l2 current">
          <a class="reference internal current" href="https://docs.ckan.org/en/2.9/contributing/architecture.html#">
           <span class="toctree-expand">
           </span>
           CKAN code architecture
          </a>
          <ul>
           <li class="toctree-l3">
            <a class="reference internal" href="https://docs.ckan.org/en/2.9/contributing/architecture.html#routes">
             Routes
            </a>
           </li>
           <li class="toctree-l3">
            <a class="reference internal" href="https://docs.ckan.org/en/2.9/contributing/architecture.html#views">
             <span class="toctree-expand">
             </span>
             Views
            </a>
            <ul>
             <li class="toctree-l4">
              <a class="reference internal" href="https://docs.ckan.org/en/2.9/contributing/architecture.html#template-helper-functions">
               Template helper functions
              </a>
             </li>
             <li class="toctree-l4">
              <a class="reference internal" href="https://docs.ckan.org/en/2.9/contributing/architecture.html#always-go-through-the-action-functions">
               Always go through the action functions
              </a>
             </li>
             <li class="toctree-l4">
              <a class="reference internal" href="https://docs.ckan.org/en/2.9/contributing/architecture.html#use-get-action">
               Use
               <code class="docutils literal notranslate">
                <span class="pre">
                 get_action()
                </span>
               </code>
              </a>
             </li>
             <li class="toctree-l4">
              <a class="reference internal" href="https://docs.ckan.org/en/2.9/contributing/architecture.html#don-t-pass-orm-objects-to-templates">
               Don’t pass ORM objects to templates
              </a>
             </li>
            </ul>
           </li>
           <li class="toctree-l3">
            <a class="reference internal" href="https://docs.ckan.org/en/2.9/contributing/architecture.html#logic">
             <span class="toctree-expand">
             </span>
             Logic
            </a>
            <ul>
             <li class="toctree-l4">
              <a class="reference internal" href="https://docs.ckan.org/en/2.9/contributing/architecture.html#action-functions-are-exposed-in-the-api">
               Action functions are exposed in the API
              </a>
             </li>
             <li class="toctree-l4">
              <a class="reference internal" href="https://docs.ckan.org/en/2.9/contributing/architecture.html#auth-functions-and-check-access">
               Auth functions and
               <code class="docutils literal notranslate">
                <span class="pre">
                 check_access()
                </span>
               </code>
              </a>
             </li>
             <li class="toctree-l4">
              <a class="reference internal" href="https://docs.ckan.org/en/2.9/contributing/architecture.html#logic-get-or-bust">
               <code class="docutils literal notranslate">
                <span class="pre">
                 logic.get_or_bust()
                </span>
               </code>
              </a>
             </li>
             <li class="toctree-l4">
              <a class="reference internal" href="https://docs.ckan.org/en/2.9/contributing/architecture.html#validation-and-ckan-logic-schema">
               Validation and
               <code class="docutils literal notranslate">
                <span class="pre">
                 ckan.logic.schema
                </span>
               </code>
              </a>
             </li>
            </ul>
           </li>
           <li class="toctree-l3">
            <a class="reference internal" href="https://docs.ckan.org/en/2.9/contributing/architecture.html#models">
             Models
            </a>
           </li>
           <li class="toctree-l3">
            <a class="reference internal" href="https://docs.ckan.org/en/2.9/contributing/architecture.html#deprecation">
             Deprecation
            </a>
           </li>
          </ul>
         </li>
         <li class="toctree-l2">
          <a class="reference internal" href="https://docs.ckan.org/en/2.9/contributing/css.html">
           CSS coding standards
          </a>
         </li>
         <li class="toctree-l2">
          <a class="reference internal" href="https://docs.ckan.org/en/2.9/contributing/html.html">
           HTML coding standards
          </a>
         </li>
         <li class="toctree-l2">
          <a class="reference internal" href="https://docs.ckan.org/en/2.9/contributing/javascript.html">
           JavaScript coding standards
          </a>
         </li>
         <li class="toctree-l2">
          <a class="reference internal" href="https://docs.ckan.org/en/2.9/contributing/python.html">
           Python coding standards
          </a>
         </li>
         <li class="toctree-l2">
          <a class="reference internal" href="https://docs.ckan.org/en/2.9/contributing/string-i18n.html">
           String internationalization
          </a>
         </li>
         <li class="toctree-l2">
          <a class="reference internal" href="https://docs.ckan.org/en/2.9/contributing/unicode.html">
           Unicode handling
          </a>
         </li>
         <li class="toctree-l2">
          <a class="reference internal" href="https://docs.ckan.org/en/2.9/contributing/testing.html">
           Testing coding standards
          </a>
         </li>
         <li class="toctree-l2">
          <a class="reference internal" href="https://docs.ckan.org/en/2.9/contributing/frontend/index.html">
           Frontend development guidelines
          </a>
         </li>
         <li class="toctree-l2">
          <a class="reference internal" href="https://docs.ckan.org/en/2.9/contributing/database-migrations.html">
           Database migrations
          </a>
         </li>
         <li class="toctree-l2">
          <a class="reference internal" href="https://docs.ckan.org/en/2.9/contributing/upgrading-dependencies.html">
           Upgrading CKAN’s dependencies
          </a>
         </li>
         <li class="toctree-l2">
          <a class="reference internal" href="https://docs.ckan.org/en/2.9/contributing/release-process.html">
           Doing a CKAN release
          </a>
         </li>
        </ul>
       </li>
       <li class="toctree-l1">
        <a class="reference internal" href="https://docs.ckan.org/en/2.9/changelog.html">
         Changelog
        </a>
       </li>
      </ul>
     </div>
    </div>
   </nav>
   <section class="wy-nav-content-wrap" data-toggle="wy-nav-shift">
    <nav aria-label="top navigation" class="wy-nav-top">
     <i class="fa fa-bars" data-toggle="wy-nav-top">
     </i>
     <a href="https://docs.ckan.org/en/2.9/contents.html">
      CKAN
     </a>
    </nav>
    <div class="wy-nav-content">
     <div class="rst-content">
      <div aria-label="breadcrumbs navigation" role="navigation">
       <ul class="wy-breadcrumbs">
        <li>
         <a href="https://docs.ckan.org/en/2.9/contents.html">
          Docs
         </a>
         »
        </li>
        <li>
         <a href="https://docs.ckan.org/en/2.9/contributing/index.html">
          Contributing guide
         </a>
         »
        </li>
        <li>
         CKAN code architecture
        </li>
        <li class="wy-breadcrumbs-aside">
         <a class="fa fa-github" href="https://github.com/ckan/ckan/blob/2.9/doc/contributing/architecture.rst">
          Edit on GitHub
         </a>
        </li>
       </ul>
       <hr/>
      </div>
      <div class="document" itemscope="itemscope" itemtype="http://schema.org/Article" role="main">
       <div itemprop="articleBody">
        <div class="section" id="ckan-code-architecture">
         <h1>
          CKAN code architecture
          <a class="headerlink" href="https://docs.ckan.org/en/2.9/contributing/architecture.html#ckan-code-architecture" title="Permalink to this headline">
           ¶
          </a>
         </h1>
         <p>
          This section documents our CKAN-specific coding standards, which are guidelines
for writing code that is consistent with the intended design and architecture
of CKAN.
         </p>
         <blockquote>
          <div>
           <img alt="CKAN architecture diagram" src="./ckan_files/architecture.png"/>
          </div>
         </blockquote>
         <div class="section" id="routes">
          <h2>
           Routes
           <a class="headerlink" href="https://docs.ckan.org/en/2.9/contributing/architecture.html#routes" title="Permalink to this headline">
            ¶
           </a>
          </h2>
          <p>
           Routes define the connection between CKAN URLs and views that process
requests and provide responses.
          </p>
          <p>
           Default routes are defined in
           <code class="docutils literal notranslate">
            <span class="pre">
             ckan.config.routing
            </span>
           </code>
           and extended with the
           <a class="reference internal" href="https://docs.ckan.org/en/2.9/extensions/plugin-interfaces.html#ckan.plugins.interfaces.IRoutes" title="ckan.plugins.interfaces.IRoutes">
            <code class="xref py py-class docutils literal notranslate">
             <span class="pre">
              ckan.plugins.interfaces.IRoutes
             </span>
            </code>
           </a>
           plugin interface.
          </p>
         </div>
         <div class="section" id="views">
          <h2>
           Views
           <a class="headerlink" href="https://docs.ckan.org/en/2.9/contributing/architecture.html#views" title="Permalink to this headline">
            ¶
           </a>
          </h2>
          <p>
           Views process requests by reading and updating data with action
function and return a response by rendering Jinja2 templates.
CKAN views are defined in
           <code class="docutils literal notranslate">
            <span class="pre">
             ckan.controllers
            </span>
           </code>
           and templates in
           <code class="docutils literal notranslate">
            <span class="pre">
             ckan.templates
            </span>
           </code>
           .
          </p>
          <p>
           Views and templates may use
           <code class="docutils literal notranslate">
            <span class="pre">
             logic.check_access
            </span>
           </code>
           or
           <a class="reference internal" href="https://docs.ckan.org/en/2.9/theming/template-helper-functions.html#ckan.lib.helpers.check_access" title="ckan.lib.helpers.check_access">
            <code class="xref py py-func docutils literal notranslate">
             <span class="pre">
              ckan.lib.helpers.check_access()
             </span>
            </code>
           </a>
           to hide links or render
helpful errors but action functions, not views, are responsible for
actually enforcing permissions checking.
          </p>
          <p>
           Plugins define new views by adding or updating routes. For adding
templates or helper functions from a plugin see
           <a class="reference internal" href="https://docs.ckan.org/en/2.9/theming/index.html">
            <span class="doc">
             Theming guide
            </span>
           </a>
           and
           <a class="reference internal" href="https://docs.ckan.org/en/2.9/theming/templates.html#custom-template-helper-functions">
            <span class="std std-ref">
             Adding your own template helper functions
            </span>
           </a>
           .
          </p>
          <div class="section" id="template-helper-functions">
           <h3>
            Template helper functions
            <a class="headerlink" href="https://docs.ckan.org/en/2.9/contributing/architecture.html#template-helper-functions" title="Permalink to this headline">
             ¶
            </a>
           </h3>
           <p>
            Template helper functions are used for code that is reused frequently or
code that is too complicated to be included in the templates themselves.
           </p>
           <p>
            Template helpers should never perform expensive queries or update data.
           </p>
           <p>
            <code class="docutils literal notranslate">
             <span class="pre">
              ckan.lib.helpers
             </span>
            </code>
            contains helper functions that can be used from
            <code class="docutils literal notranslate">
             <span class="pre">
              ckan.controllers
             </span>
            </code>
            or from templates. When developing for ckan core, only use
the helper functions found in
            <code class="docutils literal notranslate">
             <span class="pre">
              ckan.lib.helpers.__allowed_functions__
             </span>
            </code>
            .
           </p>
          </div>
          <div class="section" id="always-go-through-the-action-functions">
           <span id="always-use-action-functions">
           </span>
           <h3>
            Always go through the action functions
            <a class="headerlink" href="https://docs.ckan.org/en/2.9/contributing/architecture.html#always-go-through-the-action-functions" title="Permalink to this headline">
             ¶
            </a>
           </h3>
           <p>
            Whenever some code, for example in
            <code class="docutils literal notranslate">
             <span class="pre">
              ckan.lib
             </span>
            </code>
            or
            <code class="docutils literal notranslate">
             <span class="pre">
              ckan.controllers
             </span>
            </code>
            , wants
to get, create, update or delete an object from CKAN’s model it should do so by
calling a function from the
            <code class="docutils literal notranslate">
             <span class="pre">
              ckan.logic.action
             </span>
            </code>
            package, and
            <em>
             not
            </em>
            by
accessing
            <code class="docutils literal notranslate">
             <span class="pre">
              ckan.model
             </span>
            </code>
            directly.
           </p>
          </div>
          <div class="section" id="use-get-action">
           <h3>
            Use
            <code class="docutils literal notranslate">
             <span class="pre">
              get_action()
             </span>
            </code>
            <a class="headerlink" href="https://docs.ckan.org/en/2.9/contributing/architecture.html#use-get-action" title="Permalink to this headline">
             ¶
            </a>
           </h3>
           <p>
            Don’t call
            <code class="docutils literal notranslate">
             <span class="pre">
              logic.action
             </span>
            </code>
            functions directly, instead use
            <code class="docutils literal notranslate">
             <span class="pre">
              get_action()
             </span>
            </code>
            .
This allows plugins to override action functions using the
            <code class="docutils literal notranslate">
             <span class="pre">
              IActions
             </span>
            </code>
            plugin
interface. For example:
           </p>
           <div class="highlight-default notranslate">
            <div class="highlight">
             <pre><span></span><span class="n">ckan</span><span class="o">.</span><span class="n">logic</span><span class="o">.</span><span class="n">get_action</span><span class="p">(</span><span class="s1">'group_activity_list'</span><span class="p">)(</span><span class="o">...</span><span class="p">)</span>
</pre>
            </div>
           </div>
           <p>
            Instead of
           </p>
           <div class="highlight-default notranslate">
            <div class="highlight">
             <pre><span></span><span class="n">ckan</span><span class="o">.</span><span class="n">logic</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">group_activity_list</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre>
            </div>
           </div>
           <p>
            Views and templates may check authorization to avoid rendering
           </p>
          </div>
          <div class="section" id="don-t-pass-orm-objects-to-templates">
           <h3>
            Don’t pass ORM objects to templates
            <a class="headerlink" href="https://docs.ckan.org/en/2.9/contributing/architecture.html#don-t-pass-orm-objects-to-templates" title="Permalink to this headline">
             ¶
            </a>
           </h3>
           <p>
            Don’t pass SQLAlchemy ORM objects (e.g.
            <code class="xref py py-class docutils literal notranslate">
             <span class="pre">
              ckan.model.User
             </span>
            </code>
            objects)
to templates (for example by adding them to
            <a class="reference internal" href="https://docs.ckan.org/en/2.9/theming/variables-and-functions.html#c" title="c">
             <code class="xref py py-data docutils literal notranslate">
              <span class="pre">
               c
              </span>
             </code>
            </a>
            , passing them to
            <code class="xref py py-func docutils literal notranslate">
             <span class="pre">
              render()
             </span>
            </code>
            in the
            <code class="docutils literal notranslate">
             <span class="pre">
              extra_vars
             </span>
            </code>
            dict, returning them
from template helper functions, etc.)
           </p>
           <p>
            Using ORM objects in the templates often creates SQLAlchemy “detached instance”
errors that cause 500 Server Errors and can be difficult to debug.
           </p>
          </div>
         </div>
         <div class="section" id="logic">
          <h2>
           Logic
           <a class="headerlink" href="https://docs.ckan.org/en/2.9/contributing/architecture.html#logic" title="Permalink to this headline">
            ¶
           </a>
          </h2>
          <p>
           Logic includes action functions, auth functions, background tasks
and business logic.
          </p>
          <p>
           Action functions have a uniform interface accepting a dictionary of simple
strings lists, dictionaries or files (wrapped in a
           <code class="docutils literal notranslate">
            <span class="pre">
             cgi.FieldStorage
            </span>
           </code>
           objects). They return simple dictionaries or raise one of a small number of
exceptions including
           <code class="docutils literal notranslate">
            <span class="pre">
             ckan.logic.NotAuthorized
            </span>
           </code>
           ,
           <code class="docutils literal notranslate">
            <span class="pre">
             ckan.logic.NotFound
            </span>
           </code>
           and
           <code class="docutils literal notranslate">
            <span class="pre">
             ckan.logic.ValidationError
            </span>
           </code>
           .
          </p>
          <p>
           Plugins override action functions with the
           <a class="reference internal" href="https://docs.ckan.org/en/2.9/extensions/plugin-interfaces.html#ckan.plugins.interfaces.IActions" title="ckan.plugins.interfaces.IActions">
            <code class="xref py py-class docutils literal notranslate">
             <span class="pre">
              ckan.plugins.interfaces.IActions
             </span>
            </code>
           </a>
           interface and auth functions
with the
           <a class="reference internal" href="https://docs.ckan.org/en/2.9/extensions/plugin-interfaces.html#ckan.plugins.interfaces.IAuthFunctions" title="ckan.plugins.interfaces.IAuthFunctions">
            <code class="xref py py-class docutils literal notranslate">
             <span class="pre">
              ckan.plugins.interfaces.IAuthFunctions
             </span>
            </code>
           </a>
           interface.
          </p>
          <div class="section" id="action-functions-are-exposed-in-the-api">
           <h3>
            Action functions are exposed in the API
            <a class="headerlink" href="https://docs.ckan.org/en/2.9/contributing/architecture.html#action-functions-are-exposed-in-the-api" title="Permalink to this headline">
             ¶
            </a>
           </h3>
           <p>
            The functions in
            <code class="docutils literal notranslate">
             <span class="pre">
              ckan.logic.action
             </span>
            </code>
            are exposed to the world as the
            <a class="reference internal" href="https://docs.ckan.org/en/2.9/api/index.html">
             <span class="doc">
              API guide
             </span>
            </a>
            .  The API URL for an action function is automatically generated
from the function name, for example
            <code class="docutils literal notranslate">
             <span class="pre">
              ckan.logic.action.create.package_create()
             </span>
            </code>
            is exposed at
            <code class="docutils literal notranslate">
             <span class="pre">
              /api/action/package_create
             </span>
            </code>
            . See
            <a class="reference external" href="https://plus.google.com/112678702228711889851/posts/eVeouesvaVX">
             Steve Yegge’s Google platforms rant
            </a>
            for some
interesting discussion about APIs.
           </p>
           <p>
            <strong>
             All
            </strong>
            publicly visible functions in the
            <code class="docutils literal notranslate">
             <span class="pre">
              ckan.logic.action.{create,delete,get,update}
             </span>
            </code>
            namespaces will be exposed
through the
            <a class="reference internal" href="https://docs.ckan.org/en/2.9/api/index.html">
             <span class="doc">
              API guide
             </span>
            </a>
            .
            <strong>
             This includes functions imported
            </strong>
            by those
modules,
            <strong>
             as well as any helper functions
            </strong>
            defined within those modules.  To
prevent inadvertent exposure of non-action functions through the action api,
care should be taken to:
           </p>
           <ol class="arabic">
            <li>
             <p class="first">
              Import modules correctly (see
              <a class="reference internal" href="https://docs.ckan.org/en/2.9/contributing/python.html#imports">
               <span class="std std-ref">
                Imports
               </span>
              </a>
              ).  For example:
             </p>
             <div class="highlight-default notranslate">
              <div class="highlight">
               <pre><span></span><span class="kn">import</span> <span class="nn">ckan.lib.search</span> <span class="k">as</span> <span class="nn">search</span>

<span class="n">search</span><span class="o">.</span><span class="n">query_for</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre>
              </div>
             </div>
            </li>
            <li>
             <p class="first">
              Hide any locally defined helper functions:
             </p>
             <div class="highlight-default notranslate">
              <div class="highlight">
               <pre><span></span><span class="k">def</span> <span class="nf">_a_useful_helper_function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
   <span class="s1">'''This function is not exposed because it is marked as private```</span>
<span class="s1">   return x+y+z</span>
</pre>
              </div>
             </div>
            </li>
            <li>
             <p class="first">
              Bring imported convenience functions into the module namespace as private
members:
             </p>
             <div class="highlight-default notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">_get_or_bust</span> <span class="o">=</span> <span class="n">logic</span><span class="o">.</span><span class="n">get_or_bust</span>
</pre>
              </div>
             </div>
            </li>
           </ol>
          </div>
          <div class="section" id="auth-functions-and-check-access">
           <h3>
            Auth functions and
            <code class="docutils literal notranslate">
             <span class="pre">
              check_access()
             </span>
            </code>
            <a class="headerlink" href="https://docs.ckan.org/en/2.9/contributing/architecture.html#auth-functions-and-check-access" title="Permalink to this headline">
             ¶
            </a>
           </h3>
           <p>
            Each action function defined in
            <code class="docutils literal notranslate">
             <span class="pre">
              ckan.logic.action
             </span>
            </code>
            should use its own
corresponding auth function defined in
            <code class="docutils literal notranslate">
             <span class="pre">
              ckan.logic.auth
             </span>
            </code>
            . Instead of calling
its auth function directly, an action function should go through
            <code class="docutils literal notranslate">
             <span class="pre">
              ckan.logic.check_access
             </span>
            </code>
            (which is aliased
            <code class="docutils literal notranslate">
             <span class="pre">
              _check_access
             </span>
            </code>
            in the action
modules) because this allows plugins to override auth functions using the
            <code class="docutils literal notranslate">
             <span class="pre">
              IAuthFunctions
             </span>
            </code>
            plugin interface. For example:
           </p>
           <div class="highlight-default notranslate">
            <div class="highlight">
             <pre><span></span><span class="k">def</span> <span class="nf">package_show</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">):</span>
    <span class="n">_check_access</span><span class="p">(</span><span class="s1">'package_show'</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">)</span>
</pre>
            </div>
           </div>
           <p>
            <code class="docutils literal notranslate">
             <span class="pre">
              check_access
             </span>
            </code>
            will raise an exception if the user is not authorized, which
the action function should not catch. When this happens the user will be shown
an authorization error in their browser (or will receive one in their response
from the API).
           </p>
          </div>
          <div class="section" id="logic-get-or-bust">
           <h3>
            <code class="docutils literal notranslate">
             <span class="pre">
              logic.get_or_bust()
             </span>
            </code>
            <a class="headerlink" href="https://docs.ckan.org/en/2.9/contributing/architecture.html#logic-get-or-bust" title="Permalink to this headline">
             ¶
            </a>
           </h3>
           <p>
            The
            <code class="docutils literal notranslate">
             <span class="pre">
              data_dict
             </span>
            </code>
            parameter of logic action functions may be user provided, so
required files may be invalid or absent. Naive Code like:
           </p>
           <div class="highlight-default notranslate">
            <div class="highlight">
             <pre><span></span><span class="nb">id</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span>
</pre>
            </div>
           </div>
           <p>
            may raise a
            <code class="docutils literal notranslate">
             <span class="pre">
              KeyError
             </span>
            </code>
            and cause CKAN to crash with a 500 Server Error
and no message to explain what went wrong. Instead do:
           </p>
           <div class="highlight-default notranslate">
            <div class="highlight">
             <pre><span></span><span class="nb">id</span> <span class="o">=</span> <span class="n">_get_or_bust</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="s2">"id"</span><span class="p">)</span>
</pre>
            </div>
           </div>
           <p>
            which will raise
            <code class="docutils literal notranslate">
             <span class="pre">
              ValidationError
             </span>
            </code>
            if
            <code class="docutils literal notranslate">
             <span class="pre">
              "id"
             </span>
            </code>
            is not in
            <code class="docutils literal notranslate">
             <span class="pre">
              data_dict
             </span>
            </code>
            . The
            <code class="docutils literal notranslate">
             <span class="pre">
              ValidationError
             </span>
            </code>
            will be caught and the user will get a 400 Bad Request
response and an error message explaining the problem.
           </p>
          </div>
          <div class="section" id="validation-and-ckan-logic-schema">
           <h3>
            Validation and
            <code class="docutils literal notranslate">
             <span class="pre">
              ckan.logic.schema
             </span>
            </code>
            <a class="headerlink" href="https://docs.ckan.org/en/2.9/contributing/architecture.html#validation-and-ckan-logic-schema" title="Permalink to this headline">
             ¶
            </a>
           </h3>
           <p>
            Logic action functions can use schema defined in
            <code class="docutils literal notranslate">
             <span class="pre">
              ckan.logic.schema
             </span>
            </code>
            to
validate the contents of the
            <code class="docutils literal notranslate">
             <span class="pre">
              data_dict
             </span>
            </code>
            parameters that users pass to them.
           </p>
           <p>
            An action function should first check for a custom schema provided in the
context, and failing that should retrieve its default schema directly, and
then call
            <code class="docutils literal notranslate">
             <span class="pre">
              _validate()
             </span>
            </code>
            to validate and convert the data. For example, here
is the validation code from the
            <code class="docutils literal notranslate">
             <span class="pre">
              user_create()
             </span>
            </code>
            action function:
           </p>
           <div class="highlight-default notranslate">
            <div class="highlight">
             <pre><span></span><span class="n">schema</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'schema'</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ckan</span><span class="o">.</span><span class="n">logic</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">default_user_schema</span><span class="p">()</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s1">'session'</span><span class="p">]</span>
<span class="n">validated_data_dict</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">_validate</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
    <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
    <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
</pre>
            </div>
           </div>
          </div>
         </div>
         <div class="section" id="models">
          <h2>
           Models
           <a class="headerlink" href="https://docs.ckan.org/en/2.9/contributing/architecture.html#models" title="Permalink to this headline">
            ¶
           </a>
          </h2>
          <p>
           Ideally SQLAlchemy should only be used within
           <code class="docutils literal notranslate">
            <span class="pre">
             ckan.model
            </span>
           </code>
           and not from other
packages such as
           <code class="docutils literal notranslate">
            <span class="pre">
             ckan.logic
            </span>
           </code>
           .  For example instead of using an SQLAlchemy
query from the logic package to retrieve a particular user from the database,
we add a
           <code class="docutils literal notranslate">
            <span class="pre">
             get()
            </span>
           </code>
           method to
           <code class="docutils literal notranslate">
            <span class="pre">
             ckan.model.user.User
            </span>
           </code>
           :
          </p>
          <div class="highlight-default notranslate">
           <div class="highlight">
            <pre><span></span><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
    <span class="n">query</span> <span class="o">=</span> <span class="o">...</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</pre>
           </div>
          </div>
          <p>
           Now we can call this method from the logic package.
          </p>
         </div>
         <div class="section" id="deprecation">
          <h2>
           Deprecation
           <a class="headerlink" href="https://docs.ckan.org/en/2.9/contributing/architecture.html#deprecation" title="Permalink to this headline">
            ¶
           </a>
          </h2>
          <ul>
           <li>
            <p class="first">
             Anything that may be used by
             <a class="reference internal" href="https://docs.ckan.org/en/2.9/extensions/index.html">
              <span class="doc">
               extensions
              </span>
             </a>
             ,
             <a class="reference internal" href="https://docs.ckan.org/en/2.9/theming/index.html">
              <span class="doc">
               themes
              </span>
             </a>
             or
             <a class="reference internal" href="https://docs.ckan.org/en/2.9/api/index.html">
              <span class="doc">
               API clients
              </span>
             </a>
             needs to
maintain backward compatibility at call-site. For example: action functions,
template helper functions and functions defined in the plugins toolkit.
            </p>
           </li>
           <li>
            <p class="first">
             The length of time of deprecation is evaluated on a function-by-function
basis. At minimum, a function should be marked as deprecated during a point
release.
            </p>
           </li>
           <li>
            <p class="first">
             To deprecate a function use the
             <code class="xref py py-func docutils literal notranslate">
              <span class="pre">
               ckan.lib.maintain.deprecated()
              </span>
             </code>
             decorator and add “deprecated” to the function’s docstring:
            </p>
            <div class="highlight-default notranslate">
             <div class="highlight">
              <pre><span></span><span class="nd">@maintain</span><span class="o">.</span><span class="n">deprecated</span><span class="p">(</span><span class="s2">"helpers.get_action() is deprecated and will be removed "</span>
                    <span class="s2">"in a future version of CKAN. Instead, please use the "</span>
                    <span class="s2">"extra_vars param to render() in your controller to pass "</span>
                    <span class="s2">"results from action functions to your templates."</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_action</span><span class="p">(</span><span class="n">action_name</span><span class="p">,</span> <span class="n">data_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">'''Calls an action function from a template. Deprecated in CKAN 2.3.'''</span>
    <span class="k">if</span> <span class="n">data_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">return</span> <span class="n">logic</span><span class="o">.</span><span class="n">get_action</span><span class="p">(</span><span class="n">action_name</span><span class="p">)({},</span> <span class="n">data_dict</span><span class="p">)</span>
</pre>
             </div>
            </div>
           </li>
           <li>
            <p class="first">
             Any deprecated functions should be added to an
             <em>
              API changes and deprecations
             </em>
             section in the
             <a class="reference internal" href="https://docs.ckan.org/en/2.9/changelog.html">
              <span class="doc">
               Changelog
              </span>
             </a>
             entry for the next release (do this before
merging the deprecation into master)
            </p>
           </li>
           <li>
            <p class="first">
             Keep the deprecation messages passed to the decorator short, they appear in
logs. Put longer explanations of why something was deprecated in the
changelog.
            </p>
           </li>
          </ul>
         </div>
        </div>
       </div>
      </div>
      <footer>
       <div aria-label="footer navigation" class="rst-footer-buttons" role="navigation">
        <a class="btn btn-neutral float-right" href="https://docs.ckan.org/en/2.9/contributing/css.html" title="CSS coding standards">
         Next
         <span class="icon fa-arrow-circle-right">
         </span>
        </a>
        <a class="btn btn-neutral" href="https://docs.ckan.org/en/2.9/contributing/simple-code-contributions.html" title="Projects for beginner CKAN developers">
         <span class="icon fa-arrow-circle-left">
         </span>
         Previous
        </a>
       </div>
       <hr/>
       <div>
        <div class="ethical-rtd" data-ea-manual="true" data-ea-publisher="readthedocs" data-ea-style="stickybox" data-ea-type="image" id="rtd-sidebar">
        </div>
       </div>
       <p>
        Support the
        <a href="http://ckan.org/">
         CKAN Association
        </a>
        .
       </p>
       <p class="copyright">
        © 2009-2018
        <a href="https://okfn.org/">
         Open Knowledge Foundation
        </a>
        and
        <a href="https://github.com/ckan/ckan/graphs/contributors">
         contributors
        </a>
        .
    Licensed under
        <a href="https://creativecommons.org/licenses/by-sa/3.0/">
         Creative Commons
    Attribution ShareAlike (Unported) v3.0 License
        </a>
        .
        <br/>
        <img alt="CC License Logo" src="./ckan_files/80x15.png"/>
        <a href="https://opendefinition.org/">
         <img alt="{{ _('Open Content') }}" border="0" src="./ckan_files/oc_80x15_blue.png"/>
        </a>
       </p>
       <p>
        <a href="https://github.com/ckan/ckan">
         Source
        </a>
        —
        <a href="https://github.com/ckan/ckan/issues">
         Issues
        </a>
        —
        <a href="http://lists.okfn.org/mailman/listinfo/ckan-dev">
         Mailing List
        </a>
        —
        <a href="http://twitter.com/CKANProject">
         Twitter @CKANProject
        </a>
       </p>
       <p>
        Related Projects:
        <a href="http://datacatalogs.org/">
         DataCatalogs.org
        </a>
        —
        <a href="http://openspending.org/">
         OpenSpending.org
        </a>
        —
        <a href="http://opendatahandbook.org/">
         Open Data Handbook
        </a>
       </p>
       <a href="https://github.com/snide/sphinx_rtd_theme">
        Sphinx theme
       </a>
       provided by
       <a href="https://readthedocs.org/">
        Read the Docs
       </a>
      </footer>
     </div>
    </div>
   </section>
  </div>
  <div aria-label="versions" class="rst-versions" data-toggle="rst-versions" role="note">
   <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book">
     Read the Docs
    </span>
    v: 2.9
    <span class="fa fa-caret-down">
    </span>
   </span>
   <div class="rst-other-versions">
    <!-- Inserted RTD Footer -->
    <div class="injected">
     <dl>
      <dt>
       版本
      </dt>
      <dd>
       <a href="https://docs.ckan.org/en/latest/contributing/architecture.html">
        latest
       </a>
      </dd>
      <dd>
       <a href="https://docs.ckan.org/en/2.10/contributing/architecture.html">
        2.10
       </a>
      </dd>
      <dd class="rtd-current-item">
       <a href="https://docs.ckan.org/en/2.9/contributing/architecture.html">
        2.9
       </a>
      </dd>
      <dd>
       <a href="https://docs.ckan.org/en/2.8/contributing/architecture.html">
        2.8
       </a>
      </dd>
      <dd>
       <a href="https://docs.ckan.org/en/2.7/contributing/architecture.html">
        2.7
       </a>
      </dd>
      <dd>
       <a href="https://docs.ckan.org/en/2.6/contributing/architecture.html">
        2.6
       </a>
      </dd>
      <dd>
       <a href="https://docs.ckan.org/en/2.5/contributing/architecture.html">
        2.5
       </a>
      </dd>
      <dd>
       <a href="https://docs.ckan.org/en/ckan-2.4.9/contributing/architecture.html">
        ckan-2.4.9
       </a>
      </dd>
      <dd>
       <a href="https://docs.ckan.org/en/ckan-2.3.5/contributing/architecture.html">
        ckan-2.3.5
       </a>
      </dd>
      <dd>
       <a href="https://docs.ckan.org/en/ckan-2.2.3/contributing/architecture.html">
        ckan-2.2.3
       </a>
      </dd>
      <dd>
       <a href="https://docs.ckan.org/en/ckan-2.1.5/contributing/architecture.html">
        ckan-2.1.5
       </a>
      </dd>
     </dl>
     <dl>
      <dt>
       下载
      </dt>
      <dd>
       <a href="https://docs.ckan.org/_/downloads/en/2.9/pdf/">
        PDF
       </a>
      </dd>
      <dd>
       <a href="https://docs.ckan.org/_/downloads/en/2.9/htmlzip/">
        HTML
       </a>
      </dd>
      <dd>
       <a href="https://docs.ckan.org/_/downloads/en/2.9/epub/">
        Epub
       </a>
      </dd>
     </dl>
     <dl>
      <!-- These are kept as relative links for internal installs that are http -->
      <dt>
       在 Read the Docs 上
      </dt>
      <dd>
       <a href="https://readthedocs.org/projects/ckan/">
        项目主页
       </a>
      </dd>
      <dd>
       <a href="https://readthedocs.org/projects/ckan/builds/">
        构建
       </a>
      </dd>
      <dd>
       <a href="https://readthedocs.org/projects/ckan/downloads/">
        下载
       </a>
      </dd>
     </dl>
     <dl>
      <dt>
       在 GitHub 上
      </dt>
      <dd>
       <a href="https://github.com/ckan/ckan/blob/2.9/doc/contributing/architecture.rst">
        查看
       </a>
      </dd>
      <dd>
       <a href="https://github.com/ckan/ckan/edit/2.9/doc/contributing/architecture.rst">
        编辑
       </a>
      </dd>
     </dl>
     <dl>
      <dt>
       搜索
      </dt>
      <dd>
       <div style="padding: 6px;">
        <form action="https://readthedocs.org/projects/ckan/search/" class="wy-form" id="flyout-search-form" method="get" target="_blank">
         <input aria-label="搜索文档" name="q" placeholder="搜索文档" type="text"/>
        </form>
       </div>
      </dd>
     </dl>
     <hr/>
     <small>
      <span>
       托管于
       <a href="https://readthedocs.org/">
        Read the Docs
       </a>
      </span>
      <span>
       ·
      </span>
      <a href="https://docs.readthedocs.io/page/privacy-policy.html">
       隐私政策
      </a>
     </small>
    </div>
   </div>
  </div>
  <script type="text/javascript">
   jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 </body>
</html>
